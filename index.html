// K√∂hn…ô setupCustomersPage funksiyasƒ±nƒ± silib, bunu …ôlav…ô edin
function setupCustomersPage() {
    const customerTableBody = appContainer.querySelector('#customerTableBody');
    const addCustomerBtn = appContainer.querySelector('#addCustomerBtn');
    const customerSearch = appContainer.querySelector('#customerSearch');
    
    const populateGuarantorSelects = () => {
        const customers = getCustomers();
        const addGuarantorSelect = document.getElementById('customerGuarantorModal');
        const editGuarantorSelect = document.getElementById('editCustomerGuarantor');
        
        addGuarantorSelect.innerHTML = '<option value="">-- Zamin Se√ßin --</option>';
        editGuarantorSelect.innerHTML = '<option value="">-- Zamin Se√ßin --</option>';

        customers.forEach(c => {
            const option = `<option value="${c.id}">${c.name}</option>`;
            addGuarantorSelect.innerHTML += option;
            editGuarantorSelect.innerHTML += option;
        });
    };
    
    document.getElementById('addGuarantorBtn').addEventListener('click', () => {
        alert("Yeni zamin yaratmaq √º√ß√ºn m√º≈üt…ôri …ôlav…ô etm…ô p…ônc…ôr…ôsi a√ßƒ±lƒ±r. M…ôlumatlarƒ± daxil edib yadda saxlayƒ±n, sonra bu m√º≈üt…ôrini zamin kimi se√ß…ô bil…ôrsiniz.");
        addCustomerForm.reset();
        openModal(addCustomerModal);
    });

    const renderCustomers = () => {
        const query = customerSearch.value.toLowerCase();
        let customers = getCustomers();
        if(query){
            customers = customers.filter(c => c.name.toLowerCase().includes(query) || c.phone.includes(query));
        }
        customerTableBody.innerHTML = '';
        if (customers.length === 0) {
            customerTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">M√º≈üt…ôri tapƒ±lmadƒ±.</td></tr>';
            return;
        }
        customers.forEach(c => {
            // D∆èYƒ∞≈ûƒ∞KLƒ∞K: "Detallar" d√ºym…ôsi ikona √ßevrildi
            customerTableBody.innerHTML += `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td>${c.debt.toFixed(2)} ‚Çº</td>
                    <td class="actions-cell">
                        <button class="btn-details customer-details-btn" data-id="${c.id}" title="∆ètraflƒ± M…ôlumat" style="color: var(--primary-color);">‚ÑπÔ∏è</button>
                        <button class="btn-edit" data-id="${c.id}" title="Redakt…ô Et">‚úèÔ∏è</button>
                        <button class="btn-delete" data-id="${c.id}" title="Sil">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    };

    addCustomerBtn.addEventListener('click', () => {
        addCustomerForm.reset();
        populateGuarantorSelects();
        openModal(addCustomerModal); 
    });

    customerTableBody.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = parseInt(btn.dataset.id);

        // D∆èYƒ∞≈ûƒ∞KLƒ∞K: Detallar p…ônc…ôr…ôsinin m…ôzmunu tamamil…ô yenil…ôndi
        if (btn.classList.contains('customer-details-btn')) {
            const customer = getCustomers().find(c => c.id === id);
            if (!customer) return;

            const sales = getSales().filter(s => s.customerId === id).reverse();
            
            let guarantorName = "Se√ßilm…ôyib";
            if(customer.guarantorId) {
                const guarantor = getCustomers().find(g => g.id === customer.guarantorId);
                if(guarantor) guarantorName = guarantor.name;
            }

            const historyTitle = document.getElementById('customer-history-title');
            const historyContent = document.getElementById('customerSalesHistoryContent');

            historyTitle.textContent = `${customer.name} - ∆ètraflƒ± M…ôlumat`;
            
            // 1. M√º≈üt…ôri m…ôlumatlarƒ± hiss…ôsi (Yuxarƒ±)
            let customerInfoHtml = `
                <div style="background: #f9fafb; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border-color); margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <p><strong><span style="color: var(--text-secondary);">≈û/V Seriya:</span></strong><br>${customer.sv_seria || 'Qeyd edilm…ôyib'}</p>
                    <p><strong><span style="color: var(--text-secondary);">Fƒ∞N Kod:</span></strong><br>${customer.fin || 'Qeyd edilm…ôyib'}</p>
                    <p><strong><span style="color: var(--text-secondary);">Telefon:</span></strong><br>${customer.phone || 'Qeyd edilm…ôyib'}</p>
                    <p><strong><span style="color: var(--text-secondary);">Zamin:</span></strong><br>${guarantorName}</p>
                    <p style="grid-column: 1 / -1;"><strong><span style="color: var(--text-secondary);">√únvan:</span></strong><br>${customer.unvan || 'Qeyd edilm…ôyib'}</p>
                </div>
            `;
            
            // 2. Satƒ±≈ü tarix√ß…ôsi c…ôdv…ôli (A≈üaƒüƒ±)
            let salesHistoryHtml = `
                <h4>Satƒ±≈ü Tarix√ß…ôsi</h4>
                <table class="data-table" style="margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th>Satƒ±≈ü ID</th>
                            <th>Alƒ±≈ü Tarixi</th>
                            <th>Alƒ±≈ü N√∂v√º</th>
                            <th>M…ôbl…ôƒü</th>
                            <th>√ñd…ônilmi≈ü</th>
                            <th>Qalƒ±q Borc</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (sales.length === 0) {
                salesHistoryHtml += '<tr><td colspan="7" style="text-align:center;">Bu m√º≈üt…ôrinin satƒ±≈ü tarix√ß…ôsi yoxdur.</td></tr>';
            } else {
                sales.forEach(sale => {
                    const debt = (sale.totalAmount - sale.initialPayment);
                    salesHistoryHtml += `
                        <tr>
                            <td>${sale.id}</td>
                            <td>${sale.date}</td>
                            <td>${sale.type}</td>
                            <td>${sale.totalAmount.toFixed(2)} ‚Çº</td>
                            <td class="positive">${sale.initialPayment.toFixed(2)} ‚Çº</td>
                            <td class="${debt > 0 ? 'negative' : ''}">${debt.toFixed(2)} ‚Çº</td>
                            <td class="actions-cell"><button class="btn-details view-sale-details" data-id="${sale.id}" style="padding: 0.5rem;">M…ôhsullar</button></td>
                        </tr>`;
                });
            }
            salesHistoryHtml += `</tbody></table>`;
            
            // H…ôr iki hiss…ôni birl…ô≈üdirib p…ônc…ôr…ôy…ô yerl…ô≈üdiririk
            historyContent.innerHTML = customerInfoHtml + salesHistoryHtml;
            openModal(customerSalesHistoryModal);
            return;
        }

        if (btn.classList.contains('btn-delete')) {
            const customer = getCustomers().find(c => c.id === id);
            if (customer.debt > 0) {
                alert('Bu m√º≈üt…ôrinin borcu olduƒüu √º√ß√ºn silin…ô bilm…ôz!');
                return;
            }
            if (confirm('M√º≈üt…ôrini silm…ôy…ô …ôminsiniz?')) {
                saveCustomers(getCustomers().filter(c => c.id !== id));
                renderCustomers();
            }
        }
        if (btn.classList.contains('btn-edit')) {
            const customer = getCustomers().find(c => c.id === id);
            if (customer) {
                populateGuarantorSelects();
                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCustomerName').value = customer.name;
                document.getElementById('editCustomerSv').value = customer.sv_seria || '';
                document.getElementById('editCustomerFin').value = customer.fin || '';
                document.getElementById('editCustomerAddress').value = customer.unvan || '';
                document.getElementById('editCustomerPhone').value = customer.phone;
                document.getElementById('editCustomerGuarantor').value = customer.guarantorId || '';
                openModal(editCustomerModal);
            }
        }
    });

    customerSalesHistoryModal.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn && btn.classList.contains('view-sale-details')) {
            const saleId = parseInt(btn.dataset.id);
            const sale = getSales().find(s => s.id === saleId);
            if (!sale) return;
            
            let productsHtml = `<table class="data-table"><thead><tr><th>M…ôhsul</th><th>Say</th><th>Qiym…ôt</th><th>Toplam</th></tr></thead><tbody>`;
            sale.items.forEach(item => {
                productsHtml += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${item.salePrice.toFixed(2)} ‚Çº</td><td>${(item.quantity * item.salePrice).toFixed(2)} ‚Çº</td></tr>`;
            });
            productsHtml += '</tbody></table>';
            
            document.getElementById('productsInSaleContent').innerHTML = productsHtml;
            openModal(productsInSaleModal);
        }
    });

    customerSearch.addEventListener('input', renderCustomers);
    renderCustomers();
}
