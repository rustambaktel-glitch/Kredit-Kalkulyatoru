<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BAKFON Kredit Kalkulyatoru</title>
  <style>
    :root{ 
      --bg:#f7f9fc; --text:#0f172a; --card:#ffffff; --border:#e7eaf0; --muted:#51607a; --primary:#dc2626;
      --pill-bg:#eef2ff; --pill-border:#c7d2fe; --input-bg:#ffffff; --input-border:#cfd5e1; --shadow:0 6px 18px rgba(2,6,23,.06);
      --radius:14px; --warn-bg:#fff1f2; --warn-border:#fecaca; --warn-text:#991b1b;
      --ok-bg:#f0fdf4; --ok-border:#bbf7d0; --ok-text:#14532d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:16px;line-height:1.55}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{text-align:center;margin:0 0 16px 0}
    header h1{margin:0;font-size:32px;font-weight:800;letter-spacing:.2px;color:var(--primary)}
    h2{font-size:22px;font-weight:700;color:#111827;margin:6px 0 0}
    h3{font-size:18px;font-weight:700;color:#111827;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;box-shadow:var(--shadow)}
    .row{display:grid;gap:14px}
    @media(min-width:720px){.row{grid-template-columns:repeat(12,1fr)}}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    label{font-size:13px;color:#334155;font-weight:600}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text)}
    .btn{border:1px solid #cbd5e1;background:#f1f5f9;color:#0f172a;padding:11px 16px;border-radius:12px;cursor:pointer;transition:.15s ease;box-shadow:var(--shadow);font-weight:600}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#15803d;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#b91c1c;color:#fff}
    .btn.ghost{background:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--pill-border);padding:6px 10px;border-radius:999px;background:var(--pill-bg);color:#3730a3;font-size:12px}
    .pill.risk-low{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .pill.risk-med{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .pill.risk-high{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .muted{color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:#f8fafc;padding:12px 10px;font-weight:700;font-size:14px;color:#111827;border-bottom:1px solid var(--border);text-align:right}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);font-size:13px;text-align:right}
    tbody tr:nth-child(odd){background:rgba(2,6,23,.02)}
    canvas{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .bar > span{display:block;height:100%;background:#22c55e}
    .bar.warn > span{background:#ef4444}
    .notice{padding:12px;border-radius:12px;margin-top:8px}
    .notice.warn{background:var(--warn-bg);border:1px solid var(--warn-border);color:var(--warn-text)}
    .notice.ok{background:var(--ok-bg);border:1px solid var(--ok-border);color:var(--ok-text)}
    .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.12)}
    @media print{ .btn, #calc { display:none } .wrap{max-width:1000px} header{margin-bottom:0} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>BAKFON Kredit Kalkulyatoru</h1>
    </header>

    <section id="calc" class="card">
      <div class="row">
        <div class="col-4">
          <label>Məhsul dəyəri (AZN)</label>
          <input id="price" type="number" min="0" step="0.01" value="1000" />
        </div>
        <div class="col-3">
          <label>Müddət (ay)</label>
          <select id="months">
            <option value="3">3</option>
            <option value="6">6</option>
            <option value="9">9</option>
            <option value="12" selected>12</option>
            <option value="15">15</option>
            <option value="18">18</option>
          </select>
        </div>
        <div class="col-3">
          <label>Risk qrupu</label>
          <select id="risk" required>
            <option value="">-- Seçin --</option>
            <option value="low">Aşağı risk (A)</option>
            <option value="med">Orta risk (B)</option>
            <option value="high">Yüksək risk (C)</option>
          </select>
        </div>
        <div class="col-3">
          <label>Aylıq əmək haqqı (AZN)</label>
          <input id="salary" type="number" min="1" step="1" value="" required />
        </div>
        <div class="col-3">
          <label>Digər öhdəliklər (AZN)</label>
          <input id="oblig" type="number" min="0" step="1" value="" required />
        </div>
        <div class="col-12" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn success" onclick="calc()">Hesabla</button>
          <button class="btn danger" onclick="resetForm()">Sıfırla</button>
          <button class="btn ghost" onclick="exportPrint()">PDF (Çap)</button>
        </div>
      </div>
    </section>

    <div class="layout">
      <section class="card" id="summary"></section>
      <section class="card">
        <h3>Ödəniş cədvəli</h3>
        <div id="scheduleWrap" style="overflow:auto;max-height:420px"></div>
      </section>
    </div>

    <section class="card"><canvas id="chart" height="220"></canvas></section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ===== Utils
    const fmtAZN = n=> (new Intl.NumberFormat('az-AZ',{style:'currency',currency:'AZN',maximumFractionDigits:2})).format(n||0);
    const toNum = id=> Number((document.getElementById(id)?.value) ?? 0);

    // ===== Policy & limits
    const POLICY_RISK_ONLY = { low: 0.20, med: 0.30, high: 0.50 };
    const MIN_DOWN_AZN = 50;
    const MAX_OBLIG_SHARE = 0.50; // DTI həddi (öhdəlik/gəlir)
    const MAX_DSR = 0.40;         // Aylıq/net gəlir limiti

    // İlkin ödəniş hesabı: risk + ödəmə qabiliyyəti
    function getDownPayment(price, riskKey, salary=0, oblig=0){
      const base = POLICY_RISK_ONLY[riskKey] ?? POLICY_RISK_ONLY.med;
      salary = Number(salary)||0; oblig = Number(oblig)||0;
      const net = Math.max(0, salary - oblig);
      const ratio = salary>0 ? net / salary : 0;
      let mod = 0;
      if(ratio >= 0.70) mod = -0.10; else if(ratio >= 0.50) mod = -0.05; else if(ratio >= 0.35) mod = 0.00; else if(ratio >= 0.20) mod = +0.10; else mod = +0.20;
      if(riskKey==='high') mod *= 0.7;
      const pct = Math.min(0.85, Math.max(0.10, base + mod));
      let down = price * pct;
      if(down < MIN_DOWN_AZN) down = MIN_DOWN_AZN;
      if(down > price) down = price;
      return { down, pct, base, ratio, net };
    }

    // Print/PDF export
    function exportPrint(){
      const w=window.open('','_blank');
      const summary=document.getElementById('summary').innerHTML;
      const sched=document.getElementById('scheduleWrap').innerHTML;
      w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>Kredit Çap</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto; padding:16px} h1{margin:0 0 8px} .muted{color:#64748b}
        table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:8px;text-align:right} th{text-align:right;background:#f8fafc}
        th:first-child,td:first-child{text-align:left}
        .block{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:8px 0}
        </style></head><body>
        <h1>Kredit hesablaması</h1>
        <div class='muted'>${new Date().toLocaleString('az-AZ')}</div>
        <div class='block'>${summary}</div>
        <div class='block'>${sched}</div>
      </body></html>`);
      w.document.close(); w.focus(); w.print();
    }

    let chart=null;

    // ===== Main calc (exposed globally)
    function calc(){
      // clear previous invalid marks
      ['risk','salary','oblig'].forEach(id=>document.getElementById(id)?.classList.remove('invalid'));
      const riskEl=document.getElementById('risk');
      const salaryEl=document.getElementById('salary');
      const obligEl=document.getElementById('oblig');
      const risk=riskEl?.value||''; const salaryStr=salaryEl?.value||''; const obligStr=obligEl?.value||'';
      if(!risk || salaryStr==='' || obligStr===''){
        if(!risk) riskEl.classList.add('invalid');
        if(salaryStr==='') salaryEl.classList.add('invalid');
        if(obligStr==='') obligEl.classList.add('invalid');
        alert('Zəhmət olmasa Risk qrupu, Əmək haqqı və Digər öhdəlikləri daxil edin.');
        return;
      }

      const price=toNum('price');
      const months=toNum('months');
      const salary=Number(salaryStr); const oblig=Number(obligStr);
      if(months<=0){ alert('Müddət ən az 1 ay olmalıdır.'); return; }

      // DTI yoxlaması
      const dti = (salary>0)? (oblig/salary) : (oblig>0? Infinity : 0);
      if(dti > MAX_OBLIG_SHARE){
        const pctStr = Math.round(MAX_OBLIG_SHARE*100);
        document.getElementById('summary').innerHTML = `
          <h3>Xülasə</h3>
          <div class="notice warn">
            Diqqət: Digər öhdəliklər aylıq gəlirin ${pctStr}% həddini aşır (${(dti*100).toFixed(0)}%). Bu halda kredit ayrılmır.
          </div>`;
        document.getElementById('scheduleWrap').innerHTML = '';
        if(chart){ chart.destroy(); chart=null; }
        return;
      }

      // İlkin hesablamalar
      const baseRes = getDownPayment(price, risk, salary, oblig);
      let down = baseRes.down; let pct = baseRes.pct; const base = baseRes.base; const ratio = baseRes.ratio; const net = baseRes.net;
      let principal = Math.max(0, price - down);
      let monthly = months>0 ? principal / months : 0;

      // DSR həddi — lazım gələrsə ilkin ödənişi avtomatik artır
      const maxMonthly = Math.max(0, net * MAX_DSR);
      const needsAdj = monthly > maxMonthly + 1e-9;
      let autoAdj = false, prevDown = down, prevMonthly = monthly;
      if(needsAdj){
        const requiredPrincipal = Math.max(0, maxMonthly * months);
        const newDownRaw = price - requiredPrincipal;
        down = Math.min(price, Math.max(MIN_DOWN_AZN, Math.max(prevDown, newDownRaw)));
        pct = price>0 ? (down/price) : 0;
        principal = Math.max(0, price - down);
        monthly = months>0 ? principal / months : 0;
        autoAdj = true;
      }

      // Ödəniş cədvəli
      let bal = principal; const rows=[]; const sd=new Date();
      for(let i=1;i<=months;i++){
        bal=Math.max(0,bal-monthly);
        const d=new Date(sd); d.setMonth(d.getMonth()+i);
        rows.push({i,date:d.toISOString().slice(0,10),monthly,bal});
      }

      // Risk badge class
      const riskCls = risk==='low'?'risk-low':(risk==='high'?'risk-high':'risk-med');

      // Xülasə (sol)
      document.getElementById('summary').innerHTML=`
        <h3>Xülasə</h3>
        <div class="row">
          <div class="col-6"><div class="pill ${riskCls}">Risk: ${risk.toUpperCase()}</div><h2>${fmtAZN(price)}</h2><div class="muted">Məhsul dəyəri</div></div>
          <div class="col-6"><div class="pill">İlkin ödəniş</div>
            <h2>${fmtAZN(down)} <span class="muted">(${(pct*100).toFixed(0)}%)</span></h2>
            ${autoAdj?`<div class="notice ok">DSR həddinə görə ilkin ödəniş <strong>avtomatik artırılıb</strong>. Əvvəl: ${fmtAZN(prevDown)}, Aylıq: ${fmtAZN(prevMonthly)} → ${fmtAZN(monthly)}</div>`:''}
          </div>
          <div class="col-6"><div class="pill">Kredit</div><h2>${fmtAZN(principal)}</h2></div>
          <div class="col-6"><div class="pill">Aylıq</div><h2>${fmtAZN(monthly)}</h2></div>
          <div class="col-12"><div class="muted">Risk baza payı: ${(base*100).toFixed(0)}% • Net gəlir: ${fmtAZN(net)} (${(ratio*100).toFixed(0)}%)</div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col-12">
            <div class="muted">Borclanma yükü (DSR) — aylıq ödəniş / net gəlir</div>
            <div class="bar ${monthly>maxMonthly?'warn':''}"><span style="width:${Math.min(100, net? (monthly/net)*100 : 0)}%"></span></div>
            <div class="muted" style="margin-top:4px">Maks. aylıq icazə verilən: <strong>${fmtAZN(maxMonthly)}</strong></div>
          </div>
        </div>`;

      // Cədvəl (sağ)
      document.getElementById('scheduleWrap').innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Tarix</th><th>Aylıq</th><th>Qalıq</th></tr></thead>
          <tbody>
            ${rows.map(r=>`<tr><td>${r.i}</td><td>${r.date}</td><td>${fmtAZN(r.monthly)}</td><td>${fmtAZN(r.bal)}</td></tr>`).join('')}
          </tbody>
        </table>`;

      // Qrafik (aşağı)
      const labels=rows.map(r=>r.i); const dataBal=rows.map(r=>Number(r.bal.toFixed(2)));
      const ctx=document.getElementById('chart'); if(chart) chart.destroy();
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Qalıq borc',data:dataBal}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},elements:{line:{tension:.25}}}});
    }

    function resetForm(){
      ['price','months','risk','salary','oblig'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        if(id==='months') el.value=3; else if(id==='risk') el.value=''; else el.value='';
        el.classList.remove('invalid');
      });
      document.getElementById('summary').innerHTML="";
      document.getElementById('scheduleWrap').innerHTML="";
      if(chart){ chart.destroy(); chart=null; }
    }

    // Debug üçün konsol testləri (UI-siz). Brauzer konsolunda runTestsConsole() çağır.
    function runTestsConsole(){
      const assert=(c,m)=>{ if(!c) throw new Error(m); };
      // 1) DTI blok
      resetForm();
      document.getElementById('risk').value='med';
      document.getElementById('salary').value='1000';
      document.getElementById('oblig').value='600';
      document.getElementById('price').value='1000';
      document.getElementById('months').value='6';
      calc();
      assert(document.getElementById('summary').innerText.includes('kredit ayrılmır'),'DTI bloklanmalıdır');
      // 2) Auto-adjust aktiv
      resetForm();
      document.getElementById('risk').value='med';
      document.getElementById('salary').value='1000';
      document.getElementById('oblig').value='200';
      document.getElementById('price').value='5000';
      document.getElementById('months').value='6';
      calc();
      assert(document.getElementById('summary').innerText.includes('avtomatik artırılıb'),'Auto-adjust işləməlidir');
      // 3) Məcburi sahələr
      resetForm();
      let threw=false; try{ calc(); }catch(e){ threw=true; }
      assert(document.getElementById('risk').classList.contains('invalid'),'Risk işarələnməlidir');
      console.log('Bütün daxili konsol testləri OK ✅');
    }

    // Funksiyaları qlobal sahəyə çıxar (onclick üçün tam zəmanət)
    window.calc = calc;
    window.resetForm = resetForm;
    window.exportPrint = exportPrint;
  </script>
</body>
</html>
