<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biznes Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap');
        :root {
            --primary-color: #3f51b5;
            --primary-light: #7986cb;
            --primary-dark: #303f9f;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --text-primary: #212121;
            --text-secondary: #757575;
            --bg-main: #f5f7fa;
            --bg-content: #ffffff;
            --border-color: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            background: var(--bg-content);
            border-right: 1px solid var(--border-color);
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            z-index: 100;
            transition: transform 0.3s ease-in-out;
        }
        .sidebar .logo {
            text-align: center;
            padding: 0 0 2rem 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
        }
        .sidebar nav {
            flex-grow: 1;
        }
        .sidebar nav ul {
            list-style: none;
            padding: 0 1rem;
        }
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .sidebar nav li a:hover {
            background: #f0f4f7;
            color: var(--primary-color);
        }
        .sidebar nav li a.active {
            background: var(--primary-color);
            color: #ffffff;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }
        .sidebar nav li a.active svg {
            color: #ffffff;
        }
        .sidebar nav li a svg {
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
            color: var(--text-secondary);
            transition: color 0.2s ease-in-out;
        }
        .main-content {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
        }
        .page-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .page-header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 700;
        }
        .search-container {
            position: relative;
        }
        .search-container svg {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-secondary);
        }
        .search-input {
            min-width: 20rem;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--bg-content);
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
        }
        .content-area {
            background: var(--bg-content);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm);
        }
        .btn svg {
            width: 1.125rem;
            height: 1.125rem;
        }
        .btn-primary {
            background-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-success {
            background-color: var(--success-color);
        }
        .btn-success:hover {
            background-color: #43a047;
        }
        .btn-danger {
            background-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-primary);
        }
        .btn-warning:hover {
            background-color: #fb8c00;
        }
        .actions-cell {
            text-align: right;
            white-space: nowrap;
        }
        .actions-cell button {
            padding: 0.5rem;
            margin-left: 0.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            display: inline-flex;
            background: transparent;
            transition: background-color 0.2s;
        }
        .actions-cell button:hover {
            background-color: #f0f4f7;
        }
        .btn-edit {
            color: var(--warning-color);
        }
        .btn-delete {
            color: var(--danger-color);
        }
        .btn-details {
            color: var(--primary-color);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
        }
        .data-table th,
        .data-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        .data-table th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            background-color: #f9fafb;
        }
        .data-table tfoot tr {
            font-weight: 700;
            background-color: #f9fafb;
        }
        .data-table tbody tr {
            background: #ffffff;
            transition: background-color 0.2s;
        }
        .data-table tbody tr:hover {
            background-color: #f0f4f7;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(33, 33, 33, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding: 5vh 0;
        }
        .modal-content {
            background: var(--bg-content);
            padding: 2.5rem;
            border-radius: 1rem;
            width: 45rem;
            max-width: 90%;
            position: relative;
            box-shadow: var(--shadow-md);
            animation: modal-open 0.3s ease-out;
            z-index: 1001;
        }
        @keyframes modal-open {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            cursor: pointer;
            color: #bdbdbd;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--bg-main);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
        }
        .form-actions {
            text-align: right;
            margin-top: 2rem;
        }
        .sale-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr));
            gap: 1.5rem;
        }
        .card {
            background: var(--bg-content);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .card p {
            font-family: 'Poppins', sans-serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .positive {
            color: var(--success-color) !important;
        }
        .negative {
            color: var(--danger-color) !important;
        }
        .report-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .report-actions .btn {
            background-color: #f0f4f7;
            color: var(--text-secondary);
            box-shadow: none;
        }
        .report-actions .btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .sale-type-buttons button {
            background-color: #e9ecef;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            flex: 1;
        }
        .sale-type-buttons button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1rem;
            color: var(--text-primary);
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 1.5rem;
            margin-top: 1.5rem;
            border-bottom: none;
        }
        #customerSalesHistoryModal .modal-content {
            width: 90%;
            max-width: 95rem;
        }
        
        #saleDetailsModal .modal-content, 
        #purchaseDetailsModal .modal-content {
            width: 90%;
            max-width: 55rem;
        }
        .detail-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .detail-item strong {
            color: var(--text-secondary);
            font-weight: 500;
            display: block;
            margin-bottom: 3px;
        }
        .detail-item span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .product-details {
            border-left: 3px solid var(--primary-color);
            padding-left: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
        }
        .status-badge.anbarda {
            background-color: var(--success-color);
        }
        .status-badge.satilib {
            background-color: var(--danger-color);
        }
        
        .cart-price-input {
            width: 100px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            text-align: right;
            font-size: 0.875rem;
            background-color: var(--bg-main);
            transition: all 0.2s ease-in-out;
        }
        .cart-price-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }
        .date-input {
            width: 10rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--bg-content);
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: none;
                padding: 1rem;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .sidebar .logo {
                display: none;
            }
            .sidebar nav ul {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
                padding: 0;
            }
            .sidebar nav li a {
                margin: 0.25rem;
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.5rem;
            }
            .sidebar nav li a span {
                font-size: 0.75rem;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .search-input {
                min-width: 100%;
            }
            .sale-container {
                grid-template-columns: 1fr;
            }
            .detail-info {
                grid-template-columns: 1fr;
            }
            #customerSalesHistoryModal .modal-content,
            #saleDetailsModal .modal-content, 
            #purchaseDetailsModal .modal-content {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="https://github.com/rustambaktel-glitch/Kredit-Kalkulyatoru/blob/main/Screenshot%202025-09-13%20at%2015.07.28.png" alt="Biznes Panel Logo" style="width: 150px; height: auto;">
        </div>
        <nav id="sidebar-nav">
            <ul>
                <li><a data-page="home" class="active"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1V10"></path></svg> <span>Ana Səhifə</span></a></li>
                <li><a data-page="finance"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> <span>Maliyyə</span></a></li>
                <li><a data-page="reports"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6m-6-10h6m-6 4h6m0 0v6a2 2 0 002 2h2a2 2 0 002-2v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2z"></path></svg> <span>Hesabatlar</span></a></li>
                <li><a data-page="sales"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> <span>Satış Etmək</span></a></li>
                <li><a data-page="purchases"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg> <span>Mal Alışı</span></a></li>
                <li><a data-page="products"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg> <span>Məhsullar</span></a></li>
                <li><a data-page="stock"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m-8-4l-4-2.26v4.52L4 16m16-4l4-2.26v4.52L20 16"></path></svg> <span>Anbar</span></a></li>
                <li><a data-page="customers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-1-3.794M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>Müştərilər</span></a></li>
                <li><a data-page="suppliers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg> <span>Təchizatçılar</span></a></li>
                <li><a data-page="debts"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 4v4m0 4v2m-6-2h12a2 2 0 002-2V8a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> <span>Borclar</span></a></li>
                <li><a id="admin-login-btn"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2v2m-4-6a2 2 0 012 2v2m-6-6a2 2 0 012 2v2M3 13a2 2 0 012-2h4m5-2h-4a2 2 0 00-2 2v4a2 2 0 002 2h4m-2 2H9a2 2 0 01-2-2v-4a2 2 0 012-2h2m-4 2h4m-4 2h4m-4-4a2 2 0 01-2 2v4a2 2 0 012 2h4m-2-2h2m-2-2h2m-2-4h2m-2-2h2"></path></svg> <span>Admin</span></a></li>
            </ul>
        </nav>
    </div>

    <main class="main-content" id="app-container">
    </main>
    
    <div id="adminLoginModal" class="modal">
        <div class="modal-content" style="max-width: 25rem;">
            <span class="modal-close">&times;</span>
            <h2>Admin Girişi</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminPassword">Şifrə</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Daxil Ol</button>
                </div>
            </form>
        </div>
    </div>


    <div id="addProductModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Yeni Məhsul</h2><form id="addProductForm"><div class="form-group"><label for="productNameModal">Məhsul Adı</label><input type="text" id="productNameModal" required></div><div class="form-group"><label for="productCategoryModal">Kateqoriya</label><input type="text" id="productCategoryModal"></div><div class="form-actions"><button type="submit" class="btn btn-primary">Yadda Saxla</button></div></form></div></div>
    <div id="editProductModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Məhsulu Redaktə Et</h2><form id="editProductForm"><input type="hidden" id="editProductId"><div class="form-group"><label for="editProductName">Məhsul Adı</label><input type="text" id="editProductName" required></div><div class="form-group"><label for="editProductCategory">Kateqoriya</label><input type="text" id="editProductCategory"></div><div class="form-actions"><button type="submit" class="btn btn-primary">Dəyişikliyi Saxla</button></div></form></div></div>
    
    <div id="addCustomerModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Yeni Müştəri</h2>
        <form id="addCustomerForm">
            <div class="form-group">
                <label for="customerNameModal">Tam Adı (A.S.A)</label>
                <input type="text" id="customerNameModal" required>
            </div>
            <div class="form-group">
                <label for="customerSvModal">Ş/V Seriya və Nömrəsi</label>
                <input type="text" id="customerSvModal">
            </div>
            <div class="form-group">
                <label for="customerFinModal">FİN Kodu</label>
                <input type="text" id="customerFinModal">
            </div>
            <div class="form-group">
                <label for="customerAddressModal">Ünvan</label>
                <input type="text" id="customerAddressModal">
            </div>
            <div class="form-group">
                <label for="customerPhoneModal">Telefon Nömrəsi</label>
                <input type="text" id="customerPhoneModal" required>
            </div>
            <div class="form-group">
                <label for="customerGuarantorModal">Zamin</label>
                <select id="customerGuarantorModal">
                    <option value="">-- Zamin Seçin --</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Yadda Saxla</button>
            </div>
        </form>
    </div></div>
    <div id="editCustomerModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Müştərini Redaktə Et</h2>
        <form id="editCustomerForm">
            <input type="hidden" id="editCustomerId">
            <div class="form-group">
                <label for="editCustomerName">Tam Adı (A.S.A)</label>
                <input type="text" id="editCustomerName" required>
            </div>
            <div class="form-group">
                <label for="editCustomerSv">Ş/V Seriya və Nömrəsi</label>
                <input type="text" id="editCustomerSv">
            </div>
            <div class="form-group">
                <label for="editCustomerFin">FİN Kodu</label>
                <input type="text" id="editCustomerFin">
            </div>
            <div class="form-group">
                <label for="editCustomerAddress">Ünvan</label>
                <input type="text" id="editCustomerAddress">
            </div>
            <div class="form-group">
                <label for="editCustomerPhone">Telefon Nömrəsi</label>
                <input type="text" id="editCustomerPhone" required>
            </div>
            <div class="form-group">
                <label for="editCustomerGuarantor">Zamin</label>
                <select id="editCustomerGuarantor">
                    <option value="">-- Zamin Seçin --</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Dəyişikliyi Saxla</button>
            </div>
        </form>
    </div></div>

    <div id="addSupplierModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Yeni Təchizatçı</h2><form id="addSupplierForm"><div class="form-group"><label for="supplierNameModal">Təchizatçı Adı</label><input type="text" id="supplierNameModal" required></div><div class="form-group"><label for="supplierPhoneModal">Telefon</label><input type="text" id="supplierPhoneModal"></div><div class="form-actions"><button type="submit" class="btn btn-primary">Yadda Saxla</button></div></form></div></div>
    <div id="editSupplierModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Təchizatçını Redaktə Et</h2><form id="editSupplierForm"><input type="hidden" id="editSupplierId"><div class="form-group"><label for="editSupplierName">Təchizatçı Adı</label><input type="text" id="editSupplierName" required></div><div class="form-group"><label for="editSupplierPhone">Telefon</label><input type="text" id="editSupplierPhone"></div><div class="form-actions"><button type="submit" class="btn btn-primary">Dəyişikliyi Saxla</button></div></form></div></div>
    
    <div id="saleDetailsModal" class="modal"><div class="modal-content" style="max-width: 55rem;"><span class="modal-close">&times;</span><h2>Satış Detalları</h2><div id="saleDetailsContent" style="margin-top: 20px;"></div></div></div>
    <div id="purchaseDetailsModal" class="modal"><div class="modal-content" style="max-width: 55rem;"><span class="modal-close">&times;</span><h2>Alış Detalları</h2><div id="purchaseDetailsContent" style="margin-top: 20px;"></div></div></div>
    
    <div id="acceptPaymentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Müştəri Ödənişi</h2>
            <form id="acceptPaymentForm">
                <div class="form-group">
                    <label>Müştəri</label>
                    <select id="paymentCustomerSelect" required></select>
                </div>
                <div class="form-group" id="payment-sale-group" style="display:none;">
                    <label>Qaimə</label>
                    <select id="paymentSaleSelect" required></select>
                </div>
                <div class="form-group">
                    <label for="paymentAmount">Ödənilən Məbləğ (₼)</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="paymentCashType">Ödəniş Kassası</label>
                    <select id="paymentCashType" required>
                        <option value="Nağd Kassa">Nağd Kassa</option>
                        <option value="POS Kassa">POS Kassa</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Ödənişi Qəbul Et</button>
                </div>
            </form>
        </div>
    </div>
    <div id="addExpenseModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Xərc Əlavə Et</h2><form id="addExpenseForm"><div class="form-group"><label for="expenseType">Xərc Növü</label><select id="expenseType" required><option value="">-- Seçin --</option><option value="Ofis xərcləri">Ofis xərcləri</option><option value="Reklam xərcləri">Reklam xərcəlri</option><option value="Daşınma xərcləri">Daşınma xərcləri</option><option value="Rabitə xərcləri">Rabitə xərcləri</option><option value="Əmək haqqı">Əmək haqqı</option><option value="Digər xərclər">Digər xərclər</option></select></div><div class="form-group"><label>Məbləğ (₼)</label><input type="number" id="expenseAmount" step="0.01" required></div><div class="form-group"><label for="expenseCashType">Məxaric Kassası</label><select id="expenseCashType" required><option value="Nağd Kassa">Nağd Kassa</option><option value="POS Kassa">POS Kassa</option></select></div><div class="form-actions"><button type="submit" class="btn btn-danger">Xərci Əlavə Et</button></div></form></div></div>
    
    <div id="paySupplierModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Təchizatçıya Ödəniş</h2>
            <form id="paySupplierForm">
                <div class="form-group">
                    <label>Təchizatçı</label>
                    <select id="paymentSupplierSelect" required></select>
                </div>
                <div class="form-group" id="payment-purchase-group">
                    <label>Qaimə</label>
                    <select id="paymentPurchaseSelect"></select>
                </div>
                <div class="form-group">
                    <label for="supplierPaymentAmount">Ödənilən Məbləğ (₼)</label>
                    <input type="number" id="supplierPaymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="supplierPaymentCashType">Məxaric Kassası</label>
                    <select id="supplierPaymentCashType" required>
                        <option value="Nağd Kassa">Nağd Kassa</option>
                        <option value="POS Kassa">POS Kassa</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-warning">Ödənişi Et</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="imeiModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="imei-modal-title">IMEI Kodlarını Daxil Edin</h2>
            <form id="imeiForm">
                <div class="form-group">
                    <label for="imei1">IMEI 1</label>
                    <input type="text" id="imei1" required>
                </div>
                <div class="form-group">
                    <label for="imei2">IMEI 2</label>
                    <input type="text" id="imei2">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Əlavə et</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customerSalesHistoryModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 id="customer-history-title">Müştəri Satış Tarixçəsi</h2><div id="customerSalesHistoryContent" style="margin-top: 20px;"></div></div></div>
    <div id="supplierPurchaseDetailsModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Alış Detalları</h2><div id="supplierPurchaseDetailsContent" style="margin-top: 20px;"></div></div></div>
    <div id="incomeTypeModal" class="modal"><div class="modal-content" style="width: 30rem;"><span class="modal-close">&times;</span><h2>Mədaxil Növünü Seçin</h2><div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;"><button id="btnAcceptPayment" class="btn btn-success" style="width: 100%;">Müştəri Ödənişi</button><button id="btnOtherIncome" class="btn btn-primary" style="width: 100%;">Digər Mədaxil</button></div></div></div>
    <div id="expenseTypeModal" class="modal"><div class="modal-content" style="width: 30rem;"><span class="modal-close">&times;</span><h2>Məxaric Növünü Seçin</h2><div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;"><button id="btnPaySupplier" class="btn btn-warning" style="width: 100%;">Təchizatçıya Ödəniş Et</button><button id="btnOtherExpense" class="btn btn-danger" style="width: 100%;">Digər Xərc</button></div></div></div>
    <div id="otherIncomeModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Digər Mədaxil Əlavə Et</h2><form id="otherIncomeForm"><div class="form-group"><label for="otherIncomeDescription">Açıqlama</label><input type="text" id="otherIncomeDescription" required></div><div class="form-group"><label>Məbləğ (₼)</label><input type="number" id="otherIncomeAmount" step="0.01" required></div><div class="form-group"><label for="otherIncomeCashType">Mədaxil Kassası</label><select id="otherIncomeCashType" required><option value="Nağd Kassa">Nağd Kassa</option><option value="POS Kassa">POS Kassa</option></select></div><div class="form-actions"><button type="submit" class="btn btn-success">Mədaxili Əlavə Et</button></div></form></div></div>
    
    <div id="paymentHistoryModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="payment-history-title">Ödəniş Tarixçəsi</h2>
            <div id="paymentHistoryContent" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <div id="supplierDebtDetailsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="supplier-debt-details-title">Təchizatçı Borc Detalları</h2>
            <div id="supplierDebtDetailsContent" style="margin-top: 20px;"></div>
        </div>
    </div>


    <template id="home-page-template">
        <div class="page-container">
            <div class="page-header">
                <h1>Ana Səhifə</h1>
            </div>
            <div class="summary-cards" id="dashboard-stats" style="grid-template-columns: repeat(auto-fit, minmax(18rem, 1fr));">
                <div class="card"><h3>Ümumi Dövriyyə</h3><p id="total-turnover">0.00 ₼</p></div>
                <div class="card"><h3>Ümumi Xərc</h3><p id="total-expense">0.00 ₼</p></div>
                <div class="card"><h3>Xalis Mənfəət</h3><p id="net-profit">0.00 ₼</p></div>
                <div class="card"><h3>Anbar Dəyəri</h3><p id="stock-value">0.00 ₼</p></div>
                <div class="card"><h3>Satılan Məhsullar</h3><p id="sold-products">0 ədəd</p></div>
                <div class="card"><h3>Anbarda Olan Məhsullar</h3><p id="in-stock-products">0 ədəd</p></div>
            </div>
        </div>
    </template>


    <template id="finance-page-template">
        <div class="page-container">
            <div class="page-header">
                <h1>Maliyyə</h1>
                <div id="admin-actions" style="display:none; gap: 1rem; flex-wrap: wrap;">
                    <button id="btnBackupData" class="btn btn-primary">
                        <span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> Məlumatları Yüklə (Backup)</span>
                    </button>
                    <button id="btnFixData" class="btn btn-danger">
                        <span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> Məlumatları Düzəlt (Birdəfəlik)</span>
                    </button>
                    <button id="btnResetData" class="btn btn-danger" style="background: #e53935; color: white;">
                        <span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Bütün məlumatları sil (Sıfırla)</span>
                    </button>
                </div>
            </div>
            <div class="summary-cards">
                <div class="card"><h3>Nağd Kassa Balansı</h3><p id="cash-balance-naqd">0.00 ₼</p></div>
                <div class="card"><h3>POS Kassa Balansı</h3><p id="cash-balance-pos">0.00 ₼</p></div>
                <div class="card"><h3>Ümumi Kassa Balansı</h3><p id="current-cash-balance">0.00 ₼</p></div>
                <div class="card"><h3>Müştəri Borcları</h3><p id="total-receivables" class="positive">0.00 ₼</p></div>
                <div class="card"><h3>Təchizatçı Borcları</h3><p id="total-payables" class="negative">0.00 ₼</p></div>
            </div>
            <div class="content-area">
                <div class="page-header" style="margin-bottom: 1rem; padding: 0;">
                    <h2>Son Əməliyyatlar</h2>
                    <div class="finance-actions" style="display: flex; gap: 0.5rem;">
                        <button id="btnIncome" class="btn btn-success">
                            <span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg> Mədaxil</span>
                        </button>
                        <button id="btnExpense" class="btn btn-danger">
                            <span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19.5v-15m-7.5 7.5h15"></path></svg> Məxaric</span>
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr><th>#</th><th>Tarix</th><th>Kassa</th><th>Növ</th><th>Açıqlama</th><th>Məbləğ</th><th></th></tr>
                    </thead>
                    <tbody id="transactionsTableBody"></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>
    </template>

    <template id="reports-page-template">
        <div class="page-container">
            <div class="page-header"><h1>Hesabatlar</h1></div>
            <div class="content-area">
                <div class="report-actions" id="report-tabs">
                    <button class="btn btn-primary active" data-report="sales">Satışlar</button>
                    <button class="btn btn-primary" data-report="purchases">Alışlar</button>
                    <button class="btn btn-primary" data-report="financial">Maliyyə</button>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary);">Başlanğıc Tarixi: <input type="date" id="reportStartDate" class="date-input"></label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary);">Bitiş Tarixi: <input type="date" id="reportEndDate" class="date-input"></label>
                </div>

                <div id="sales-report-view" class="report-view">
                    <div class="page-header" style="padding: 1rem 0 0 0;">
                        <div class="search-container">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="search" id="salesReportSearch" class="search-input" placeholder="Müştəri, məbləğ və ya tarixə görə axtar...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>#</th><th>#ID</th><th>Tarix</th><th>Müştəri</th><th>Növ</th><th>Yekun Məbləğ</th><th></th></tr></thead>
                        <tbody id="salesHistoryTableBody"></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
                <div id="purchases-report-view" class="report-view" style="display:none;">
                    <div class="page-header" style="padding: 1rem 0 0 0;">
                        <div class="search-container">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="search" id="purchasesReportSearch" class="search-input" placeholder="Təchizatçı, məbləğ və ya tarixə görə axtar...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>#</th><th>#ID</th><th>Tarix</th><th>Təchizatçı</th><th>Yekun Məbləğ</th><th></th></tr></thead>
                        <tbody id="purchasesHistoryTableBody"></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
                <div id="financial-report-view" class="report-view" style="display:none;">
                    <div class="page-header" style="padding: 1rem 0 0 0;">
                        <div class="search-container">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="search" id="financialReportSearch" class="search-input" placeholder="Növ, açıqlama və ya tarixə görə axtar...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>#</th><th>#ID</th><th>Tarix</th><th>Kassa</th><th>Növ</th><th>Açıqlama</th><th>Məbləğ</th><th></th></tr></thead>
                        <tbody id="financialHistoryTableBody"></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="sales-page-template">
        <div class="page-container">
            <div class="page-header"><h1>Satış Etmək</h1></div>
            <div class="content-area">
                <div class="report-actions" id="sale-tabs">
                    <button class="btn btn-primary active" data-sale-type="cash">Nağd Satış</button>
                    <button class="btn btn-primary" data-sale-type="credit">Kredit Satışı</button>
                    <button class="btn btn-primary" data-sale-type="corporate">Korporativ Satış</button>
                </div>

                <div id="cash-sale-view" class="sale-view">
                    <form id="cashSaleForm">
                        <div class="sale-container">
                            <div>
                                <h4>Müştəri və Məhsul seçimi</h4>
                                <div class="form-group">
                                    <label>Müştəri Seçin</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <select class="sale-customer" style="flex-grow: 1;" required></select>
                                        <button type="button" class="btn btn-primary add-customer-quick" style="padding: 0.5rem; line-height: 1;">+</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>IMEI ilə Axtar</label>
                                    <div class="search-container">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="left: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <input type="search" id="imeiSearchInput" class="search-input" placeholder="IMEI daxil edin" style="width: 100%; min-width: unset; padding-left: 2.5rem;">
                                    </div>
                                </div>
                                <hr style="border-color:var(--border-color); margin: 15px 0;">
                                <table class="data-table">
                                    <thead><tr><th>#</th><th>Məhsul</th><th>IMEI 1</th><th>IMEI 2</th><th>Qiymət</th><th></th></tr></thead>
                                    <tbody class="cart-table-body"></tbody>
                                    <tfoot></tfoot>
                                </table>
                            </div>
                            <div>
                                <h4>Satışı Yekunlaşdır</h4>
                                <div class="form-group">
                                    <label>Ödəmə Növü</label>
                                    <select class="payment-type">
                                        <option value="Nağd">Nağd</option>
                                        <option value="POS Terminal">POS Terminal</option>
                                        <option value="Açıq Qaimə">Açıq Qaimə</option>
                                    </select>
                                </div>
                                <div class="form-group" id="cash-sale-cash-type-group">
                                    <label>Kassa Növü</label>
                                    <select class="cash-type">
                                        <option value="Nağd Kassa">Nağd Kassa</option>
                                        <option value="POS Kassa">POS Kassa</option>
                                    </select>
                                </div>
                                <div class="summary-row total"><span>Yekun Məbləğ:</span><span class="summary-total">0.00 ₼</span></div>
                                <div class="form-actions"><button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1rem;">Satışı Tamamla</button></div>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="credit-sale-view" class="sale-view" style="display:none;">
                    <form id="creditSaleForm">
                        <div class="sale-container">
                            <div>
                                <h4>Müştəri və Məhsul seçimi</h4>
                                <div class="form-group">
                                    <label>Müştəri Seçin</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <select class="sale-customer" style="flex-grow: 1;" required></select>
                                        <button type="button" class="btn btn-primary add-customer-quick" style="padding: 0.5rem; line-height: 1;">+</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>IMEI ilə Axtar</label>
                                    <div class="search-container">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="left: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <input type="search" id="imeiSearchInputCredit" class="search-input" placeholder="IMEI daxil edin" style="width: 100%; min-width: unset; padding-left: 2.5rem;">
                                    </div>
                                </div>
                                <hr style="border-color:var(--border-color); margin: 15px 0;">
                                <table class="data-table">
                                    <thead><tr><th>#</th><th>Məhsul</th><th>IMEI 1</th><th>IMEI 2</th><th>Qiymət</th><th></th></tr></thead>
                                    <tbody class="cart-table-body"></tbody>
                                    <tfoot></tfoot>
                                </table>
                            </div>
                            <div>
                                <h4>Kredit Məlumatları</h4>
                                <div class="form-group"><label>İlkin Ödəniş (₼)</label><input type="number" class="initial-payment" value="0" step="0.01" required></div>
                                <div class="form-group"><label>Ödəniş Kassası</label><select class="cash-type"><option value="Nağd Kassa">Nağd Kassa</option><option value="POS Kassa">POS Kassa</option></select></div>
                                <div class="form-group"><label>Ayların Sayı</label>
                                    <select class="loan-term">
                                        <option value="3">3 ay</option>
                                        <option value="6">6 ay</option>
                                        <option value="9">9 ay</option>
                                        <option value="12">12 ay</option>
                                        <option value="18">18 ay</option>
                                        <option value="24">24 ay</option>
                                    </select>
                                </div>
                                <div class="summary-row total"><span>Yekun Məbləğ:</span><span class="summary-total">0.00 ₼</span></div>
                                <div class="form-actions"><button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1rem;">Krediti Rəsmiləşdir</button></div>
                                <div id="payment-schedule" style="margin-top: 2rem;"></div>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="corporate-sale-view" class="sale-view" style="display:none;">
                    <form id="corporateSaleForm">
                        <div class="sale-container">
                            <div>
                                <h4>Müştəri və Məhsul seçimi</h4>
                                <div class="form-group">
                                    <label>Korporativ Müştəri Seçin</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <select class="sale-customer" style="flex-grow: 1;" required></select>
                                        <button type="button" class="btn btn-primary add-customer-quick" style="padding: 0.5rem; line-height: 1;">+</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>IMEI ilə Axtar</label>
                                    <div class="search-container">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="left: 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <input type="search" id="imeiSearchInputCorporate" class="search-input" placeholder="IMEI daxil edin" style="width: 100%; min-width: unset; padding-left: 2.5rem;">
                                    </div>
                                </div>
                                <hr style="border-color:var(--border-color); margin: 15px 0;">
                                <table class="data-table">
                                    <thead><tr><th>#</th><th>Məhsul</th><th>IMEI 1</th><th>IMEI 2</th><th>Qiymət</th><th></th></tr></thead>
                                    <tbody class="cart-table-body"></tbody>
                                    <tfoot></tfoot>
                                </table>
                            </div>
                            <div>
                                <h4>Satışı Yekunlaşdır</h4>
                                <div class="form-group"><label>İlkin Ödəniş (₼)</label><input type="number" class="initial-payment" value="0" step="0.01"></div>
                                <div class="form-group"><label>Ödəniş Kassası</label><select class="cash-type"><option value="Nağd Kassa">Nağd Kassa</option><option value="POS Kassa">POS Kassa</option></select></div>
                                <div class="summary-row total"><span>Yekun Məbləğ:</span><span class="summary-total">0.00 ₼</span></div>
                                <div class="summary-row"><span>Qalıq Borc:</span><span class="debt-total">0.00 ₼</span></div>
                                <div class="form-actions"><button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1rem;">Satışı Tamamla</button></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>

    <template id="purchases-page-template">
        <div class="page-container">
            <div class="page-header"><h1>Yeni Mal Alışı</h1></div>
            <form id="purchaseForm">
                <div class="sale-container">
                    <div class="content-area">
                        <h4>Təchizatçı və Məhsul seçimi</h4>
                        <div class="form-group"><label>Təchizatçı Seçin</label><select id="purchaseSupplierSelect" required></select></div>
                        <div class="form-group"><label for="purchaseProductName">Məhsul Adı</label><select id="purchaseProductSelect" required></select></div>
                        <div id="purchase-items-container">
                            </div>
                        <div class="form-actions">
                            <button type="button" id="addPurchaseItemBtn" class="btn btn-primary">Məhsul Əlavə Et</button>
                        </div>
                        
                    </div>
                    <div class="content-area">
                        <h4>Alışı Yekunlaşdır</h4>
                        <div class="summary-row total" style="margin-top: 1.5rem;"><span>Yekun Məbləğ:</span><span id="purchaseTotal">0.00 ₼</span></div>
                        <div class="form-actions"><button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1rem;"><span>Alışı Tamamla</span></button></div>
                    </div>
                </div>
            </form>
        </div>
    </template>

    <template id="products-page-template">
        <div class="page-container">
            <div class="page-header">
                <h1>Məhsullar</h1>
                <div class="search-container">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="search" id="productSearch" class="search-input" placeholder="Məhsul adı və ya ID ilə axtar...">
                </div>
                <button id="addProductBtn" class="btn btn-primary">
                    <span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg> Yeni Məhsul</span>
                </button>
            </div>
            <div class="content-area">
                <table class="data-table">
                    <thead>
                        <tr><th>#</th><th>#ID</th><th>Ad</th><th>Kateqoriya</th><th></th></tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>
    </template>
    
    <template id="stock-page-template">
        <div class="page-container">
            <div class="page-header">
                <h1>Anbar</h1>
                <div class="search-container">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="search" id="stockSearch" class="search-input" placeholder="Məhsul adı və ya IMEI ilə axtar...">
                </div>
            </div>
            <div class="content-area">
                <table class="data-table">
                    <thead>
                        <tr><th>#</th><th>Adı</th><th>Alış Tarixi</th><th>Təchizatçı</th><th>Alış Qiyməti</th><th>IMEI 1</th><th>IMEI 2</th><th>Status</th></tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
            </div>
        </div>
    </template>

    <template id="customers-page-template"><div class="page-container"><div class="page-header"><h1>Müştərilər</h1><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="customerSearch" class="search-input" placeholder="Ad və ya telefonla axtar..."></div><button id="addCustomerBtn" class="btn btn-primary"><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg> Yeni Müştəri</span></button></div><div class="content-area"><table class="data-table"><thead><tr><th>#</th><th>#ID</th><th>Tam Adı</th><th>Telefon</th><th>Borc</th><th>Ümumi Dövriyyə</th><th></th></tr></thead><tbody id="customerTableBody"></tbody><tfoot></tfoot></table></div></div></template>
    <template id="suppliers-page-template"><div class="page-container"><div class="page-header"><h1>Təchizatçılar</h1><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="supplierSearch" class="search-input" placeholder="Ad və ya telefonla axtar..."></div><button id="addSupplierBtn" class="btn btn-primary"><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg> Yeni Təchizatçı</span></button></div><div class="content-area"><table class="data-table"><thead><tr><th>#</th><th>#ID</th><th>Ad</th><th>Telefon</th><th>Bizim Borcumuz</th><th></th></tr></thead><tbody id="supplierTableBody"></tbody><tfoot></tfoot></table></div></div></template>
    
    <template id="debts-page-template">
        <div class="page-container">
            <div class="page-header"><h1>Borclar</h1></div>
            <div class="content-area">
                <div class="report-actions" id="debt-tabs">
                    <button class="btn btn-primary active" data-debt-type="customer-credit">Kredit Borcları</button>
                    <button class="btn btn-primary" data-debt-type="customer-corporate">Korporativ Borclar</button>
                    <button class="btn btn-primary" data-debt-type="customer-invoice">Açıq Qaimə Borcları</button>
                    <button class="btn btn-primary" data-debt-type="supplier">Təchizatçı Borcları</button>
                </div>
                
                <div id="customer-debts-view" class="debt-view">
                    <div class="page-header" style="padding: 1rem 0 0 0;">
                        <div class="search-container">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="search" id="customerDebtSearch" class="search-input" placeholder="Müştəri, məbləğ, tarixə görə axtar...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>#</th><th>Satış ID</th><th>Tarix</th><th>Müştəri</th><th>Toplam Məbləğ</th><th>Ödənilən</th><th>Borc Qalığı</th><th></th><th></th></tr>
                        </thead>
                        <tbody id="customerDebtTableBody"></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>

                <div id="supplier-debts-view" class="debt-view" style="display:none;">
                    <div class="page-header" style="padding: 1rem 0 0 0;">
                        <div class="search-container">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="search" id="supplierDebtSearch" class="search-input" placeholder="Təchizatçı, məbləğ, tarixə görə axtar...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>#</th><th>Təchizatçı</th><th>Toplam Borc</th><th>Ödənilən</th><th>Qalıq Borc</th><th></th><th></th></tr>
                        </thead>
                        <tbody id="supplierDebtTableBody"></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>

            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            const sidebarNav = document.getElementById('sidebar-nav');
            const allModals = document.querySelectorAll('.modal');
            const saleDetailsModal = document.getElementById('saleDetailsModal');
            const customerSalesHistoryModal = document.getElementById('customerSalesHistoryModal');
            const purchaseDetailsModal = document.getElementById('purchaseDetailsModal');
            const supplierPurchaseDetailsModal = document.getElementById('supplierDebtDetailsModal');
            
            const addProductModal = document.getElementById('addProductModal');
            const editProductModal = document.getElementById('editProductModal');
            const addCustomerModal = document.getElementById('addCustomerModal');
            const editCustomerModal = document.getElementById('editCustomerModal');
            const addSupplierModal = document.getElementById('addSupplierModal');
            const editSupplierModal = document.getElementById('editSupplierModal');
            const acceptPaymentModal = document.getElementById('acceptPaymentModal');
            const addExpenseModal = document.getElementById('addExpenseModal');
            const paySupplierModal = document.getElementById('paySupplierModal');
            const incomeTypeModal = document.getElementById('incomeTypeModal');
            const expenseTypeModal = document.getElementById('expenseTypeModal');
            const otherIncomeModal = document.getElementById('otherIncomeModal');
            const paymentHistoryModal = document.getElementById('paymentHistoryModal');
            const supplierDebtDetailsModal = document.getElementById('supplierDebtDetailsModal');
            const adminLoginModal = document.getElementById('adminLoginModal');
            
            const addProductForm = document.getElementById('addProductForm');
            const editProductForm = document.getElementById('editProductForm');
            const addCustomerForm = document.getElementById('addCustomerForm');
            const editCustomerForm = document.getElementById('editCustomerForm');
            const addSupplierForm = document.getElementById('addSupplierForm');
            const editSupplierForm = document.getElementById('editSupplierForm');
            const acceptPaymentForm = document.getElementById('acceptPaymentForm');
            const addExpenseForm = document.getElementById('addExpenseForm');
            const paySupplierForm = document.getElementById('paySupplierForm');
            const otherIncomeForm = document.getElementById('otherIncomeForm');
            const adminLoginForm = document.getElementById('adminLoginForm');
            const ADMIN_PASSWORD = 'admin';

            let DATA = {};
            const INITIAL_DATA = {
                products: [], stock: [], customers: [], suppliers: [], sales: [], purchases: [], transactions: [], cashBalance: { naqd: 0, pos: 0 }
            };

            const loadFromStorage = () => {
                try {
                    const storedData = JSON.parse(localStorage.getItem('biznesPanelData')) || {};
                    DATA = { ...INITIAL_DATA, ...storedData };
                    // Ensure cashBalance structure exists
                    if (!DATA.cashBalance || typeof DATA.cashBalance.naqd === 'undefined') {
                        DATA.cashBalance = { naqd: 0, pos: 0 };
                        recalculateAllDebtsAndBalances(true); // Recalculate if old structure is found
                    }
                } catch (e) {
                    console.error("Local Storage-dan məlumat yüklənərkən xəta: ", e);
                    DATA = INITIAL_DATA;
                }
            };

            const saveToStorage = () => {
                localStorage.setItem('biznesPanelData', JSON.stringify(DATA));
            };

            const getProducts = () => DATA.products;
            const getStock = () => DATA.stock;
            const getCustomers = () => DATA.customers.filter(c => c.isActive !== false);
            const getSuppliers = () => DATA.suppliers.filter(s => s.isActive !== false);
            const getSales = () => DATA.sales;
            const getPurchases = () => DATA.purchases;
            const getTransactions = () => DATA.transactions;
            
            // Initial data load
            loadFromStorage();
            
            document.getElementById('admin-login-btn').addEventListener('click', () => {
                openModal(adminLoginModal);
                document.getElementById('adminPassword').focus();
            });
            
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;
                if (password === ADMIN_PASSWORD) {
                    localStorage.setItem('isAdmin', 'true');
                    alert('Admin rejiminə xoş gəldiniz!');
                    closeModal(adminLoginModal);
                    renderPage(document.querySelector('.sidebar nav a.active').dataset.page);
                } else {
                    alert('Şifrə yanlışdır!');
                }
            });


            const openModal = (modal) => {
                modal.style.display = 'flex';
            };

            const closeModal = (modal) => {
                modal.style.display = 'none';
            };

            allModals.forEach(modal => {
                const closeButton = modal.querySelector('.modal-close');
                if(closeButton) closeButton.addEventListener('click', () => closeModal(modal));
                window.addEventListener('click', (event) => { if (event.target === modal) closeModal(modal); });
            });
            
            function recalculateAllDebtsAndBalances(silent = false) {
                // Borc və Balansları sıfırla
                DATA.customers.forEach(c => c.debt = 0);
                DATA.suppliers.forEach(s => s.balance = 0);
                DATA.cashBalance = { naqd: 0, pos: 0 };

                // Müştəri borclarını yenidən hesablayırıq
                DATA.sales.forEach(sale => {
                    const debt = sale.totalAmount - sale.initialPayment;
                    if (debt > 0.01) {
                        const customer = DATA.customers.find(c => c.id === sale.customerId);
                        if (customer) {
                            customer.debt += debt;
                        }
                    }
                });
                
                // Təchizatçı borclarını yenidən hesablayırıq - bu hissə transactions-dan asılıdır!
                DATA.purchases.forEach(purchase => {
                    const paidAmount = DATA.transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === purchase.id).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    const remainingDebt = purchase.totalAmount - paidAmount;
                    const supplier = DATA.suppliers.find(s => s.id === purchase.supplierId);
                    if (supplier) {
                        supplier.balance += remainingDebt;
                    }
                });
                
                // Kassa balanslarını yenidən hesablayırıq
                DATA.transactions.forEach(t => {
                    if (t.details && t.details.cashType === 'Nağd Kassa') {
                        DATA.cashBalance.naqd += t.amount;
                    } else if (t.details && t.details.cashType === 'POS Kassa') {
                        DATA.cashBalance.pos += t.amount;
                    }
                });
                

                saveToStorage();
                if(!silent) alert('Proses tamamlandı! Bütün borclar və balanslar yenidən hesablandı.');
                if(!silent) renderPage(document.querySelector('.sidebar nav a.active').dataset.page);
            }

            const pageSetups = {
                'home': setupHomePage,
                'finance': setupFinancePage, 'reports': setupReportsPage, 'sales': setupSalesPage,
                'purchases': setupPurchasesPage, 'products': setupProductsPage, 'stock': setupStockPage, 'customers': setupCustomersPage, 'suppliers': setupSuppliersPage,
                'debts': setupDebtsPage
            };

            const renderPage = (pageName) => {
                const template = document.getElementById(`${pageName}-page-template`);
                if (!template) { console.error(`Template for page "${pageName}" not found.`); return; }
                appContainer.innerHTML = '';
                const pageContent = template.content.cloneNode(true);
                appContainer.appendChild(pageContent);
                if (pageSetups[pageName]) pageSetups[pageName]();
            };

            sidebarNav.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link) {
                    e.preventDefault();
                    const pageName = link.dataset.page;
                    if(pageName) {
                        sidebarNav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        renderPage(pageName);
                    }
                }
            });

            function addTransaction(type, description, amount, cashType, details = {}) {
                const newTransaction = { 
                    id: Date.now(), 
                    date: new Date().toLocaleString('az-AZ'), 
                    type, 
                    description, 
                    amount,
                    details: {
                        ...details,
                        cashType: cashType,
                        date: new Date().toLocaleString('az-AZ')
                    }
                };
                DATA.transactions.push(newTransaction);
                if (cashType === 'Nağd Kassa') {
                    DATA.cashBalance.naqd = parseFloat((DATA.cashBalance.naqd + amount).toFixed(2));
                } else if (cashType === 'POS Kassa') {
                    DATA.cashBalance.pos = parseFloat((DATA.cashBalance.pos + amount).toFixed(2));
                }
                saveToStorage();
                return newTransaction;
            }

            addProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                DATA.products.push({ id: Date.now(), name: document.getElementById('productNameModal').value, category: document.getElementById('productCategoryModal').value, isActive: true });
                saveToStorage();
                closeModal(addProductModal);
                renderPage('products');
            });

            editProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editProductId').value);
                const updatedProducts = getProducts().map(p => p.id === id ? { ...p, name: document.getElementById('editProductName').value, category: document.getElementById('editProductCategory').value } : p);
                DATA.products = updatedProducts;
                saveToStorage();
                closeModal(editProductModal);
                renderPage('products');
            });

            addCustomerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCustomer = {
                    id: Date.now(),
                    name: document.getElementById('customerNameModal').value,
                    sv_seria: document.getElementById('customerSvModal').value,
                    fin: document.getElementById('customerFinModal').value,
                    unvan: document.getElementById('customerAddressModal').value,
                    phone: document.getElementById('customerPhoneModal').value,
                    guarantorId: parseInt(document.getElementById('customerGuarantorModal').value) || null,
                    debt: 0,
                    isActive: true
                };
                DATA.customers.push(newCustomer);
                saveToStorage();
                closeModal(addCustomerModal);
                
                const activePage = document.querySelector('.sidebar nav a.active').dataset.page;
                if (activePage === 'customers') {
                    renderPage('customers');
                } else if (activePage === 'sales') {
                    renderPage('sales'); 
                }
            });

            editCustomerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editCustomerId').value);
                const updatedCustomers = DATA.customers.map(c => {
                    if (c.id === id) {
                        return {
                            ...c,
                            name: document.getElementById('editCustomerName').value,
                            sv_seria: document.getElementById('editCustomerSv').value,
                            fin: document.getElementById('editCustomerFin').value,
                            unvan: document.getElementById('editCustomerAddress').value,
                            phone: document.getElementById('editCustomerPhone').value,
                            guarantorId: parseInt(document.getElementById('editCustomerGuarantor').value) || null
                        };
                    }
                    return c;
                });
                DATA.customers = updatedCustomers;
                saveToStorage();
                closeModal(editCustomerModal);
                renderPage('customers');
            });

            addSupplierForm.addEventListener('submit', (e) => {
                e.preventDefault();
                DATA.suppliers.push({ id: Date.now(), name: document.getElementById('supplierNameModal').value, phone: document.getElementById('supplierPhoneModal').value, balance: 0, isActive: true });
                saveToStorage();
                closeModal(addSupplierModal);
                renderPage('suppliers');
            });

            editSupplierForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editSupplierId').value);
                const updatedSuppliers = DATA.suppliers.map(s => s.id === id ? { ...s, name: document.getElementById('editSupplierName').value, phone: document.getElementById('editSupplierPhone').value } : s);
                DATA.suppliers = updatedSuppliers;
                saveToStorage();
                closeModal(editSupplierModal);
                renderPage('suppliers');
            });

            otherIncomeForm.addEventListener('submit', e => {
                e.preventDefault();
                const desc = document.getElementById('otherIncomeDescription').value;
                const amount = parseFloat(document.getElementById('otherIncomeAmount').value);
                const cashType = document.getElementById('otherIncomeCashType').value;

                if (!desc || amount <= 0) { alert('Məlumatları düzgün daxil edin.'); return; }
                
                addTransaction('Digər Mədaxil', desc, amount, cashType);
                closeModal(otherIncomeModal);
                renderPage('finance');
            });
            
            acceptPaymentForm.addEventListener('submit', e => {
                e.preventDefault();
                const customerId = parseInt(document.getElementById('paymentCustomerSelect').value);
                const saleId = document.getElementById('paymentSaleSelect').value ? parseInt(document.getElementById('paymentSaleSelect').value) : null;
                if (!customerId) { alert("Müştəri seçin."); return; }

                const amount = parseFloat(document.getElementById('paymentAmount').value);
                const cashType = document.getElementById('paymentCashType').value;
                
                let customer = DATA.customers.find(c => c.id === customerId);
                if (!customer) { alert('Müştəri tapıldı.'); return; }

                let sale = DATA.sales.find(s => s.id === saleId);
                let remainingDebt = saleId ? (sale.totalAmount - sale.initialPayment) : customer.debt;

                if (amount <= 0 || amount > (remainingDebt + 0.001)) {
                    alert('Ödəniş məbləği düzgün deyil və ya borcdan artıqdır!');
                    return;
                }

                customer.debt = parseFloat((customer.debt - amount).toFixed(2));

                if (saleId) {
                    sale.initialPayment = parseFloat((sale.initialPayment + amount).toFixed(2));
                    if (!sale.payments) sale.payments = [];
                    sale.payments.push({
                        date: new Date().toLocaleString('az-AZ'),
                        amount: amount,
                        type: cashType,
                    });
                }
                
                addTransaction(`Müştəri Ödənişi`, `${customer.name} tərəfindən ödəniş`, amount, cashType, { customerId: customer.id, saleId: saleId });
                closeModal(acceptPaymentModal);
                renderPage(document.querySelector('.sidebar nav a.active').dataset.page);
            });
            
            document.getElementById('paymentCustomerSelect').addEventListener('change', (e) => {
                const customerId = parseInt(e.target.value);
                const sales = getSales();
                const paymentSaleSelect = document.getElementById('paymentSaleSelect');
                const paymentSaleGroup = document.getElementById('payment-sale-group');
                const paymentAmountInput = document.getElementById('paymentAmount');

                if (!customerId) {
                    paymentSaleGroup.style.display = 'none';
                    paymentSaleSelect.innerHTML = '';
                    paymentAmountInput.value = '';
                    return;
                }

                const customerSales = sales.filter(s => s.customerId === customerId && (s.totalAmount - s.initialPayment) > 0.01);
                
                if (customerSales.length > 0) {
                    paymentSaleGroup.style.display = 'block';
                    paymentSaleSelect.innerHTML = '<option value="">-- Qaimə Seçin (Ümumi Ödəniş) --</option>';
                    customerSales.forEach(s => {
                        const remainingDebt = (s.totalAmount - s.initialPayment);
                        paymentSaleSelect.innerHTML += `<option value="${s.id}" data-debt="${remainingDebt.toFixed(2)}">#${s.id} - ${s.type} - Borc: ${remainingDebt.toFixed(2)} ₼</option>`;
                    });
                } else {
                    paymentSaleGroup.style.display = 'none';
                    paymentSaleSelect.innerHTML = '';
                }
                
                // Ümumi borcu ilkin dəyər kimi yaz
                const customer = getCustomers().find(c => c.id === customerId);
                paymentAmountInput.value = customer ? customer.debt.toFixed(2) : '';
                paymentAmountInput.max = customer ? customer.debt.toFixed(2) : '';
            });

            document.getElementById('paymentSaleSelect').addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const customerId = parseInt(document.getElementById('paymentCustomerSelect').value);
                const customer = getCustomers().find(c => c.id === customerId);
                
                let debt;
                if(selectedOption.value) {
                    debt = selectedOption.dataset.debt;
                } else {
                    debt = customer.debt.toFixed(2);
                }

                document.getElementById('paymentAmount').value = debt;
                document.getElementById('paymentAmount').max = debt;
            });
            
            addExpenseForm.addEventListener('submit', e => {
                e.preventDefault();
                const expenseType = document.getElementById('expenseType').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const cashType = document.getElementById('expenseCashType').value;
                if(!expenseType || amount <= 0) { alert("Məlumatları düzgün daxil edin."); return; }
                
                addTransaction(expenseType, `Xərc: ${expenseType}`, -amount, cashType);
                closeModal(addExpenseModal);
                renderPage('finance');
            });
            
            paySupplierForm.addEventListener('submit', e => {
                e.preventDefault();
                const supplierId = parseInt(document.getElementById('paymentSupplierSelect').value);
                const purchaseId = document.getElementById('paymentPurchaseSelect').value ? parseInt(document.getElementById('paymentPurchaseSelect').value) : null;
                const cashType = document.getElementById('supplierPaymentCashType').value;
                
                if(!supplierId){ alert("Təchizatçı seçin."); return; }
                
                const amount = parseFloat(document.getElementById('supplierPaymentAmount').value);
                let supplier = DATA.suppliers.find(s => s.id === supplierId);
                
                if (!supplier) { alert('Təchizatçı tapılmadı.'); return; }
                let remainingDebt = supplier.balance;

                if (purchaseId) {
                    let purchase = getPurchases().find(p => p.id === purchaseId);
                    const paidAmount = DATA.transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === purchaseId).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    remainingDebt = purchase.totalAmount - paidAmount;
                }
                
                if(amount <= 0 || amount > remainingDebt) {
                    alert('Ödəniş məbləği düzgün daxil edilməyib!');
                    return;
                }
                
                supplier.balance = parseFloat((supplier.balance - amount).toFixed(2));
                
                addTransaction('Təchizatçıya Ödəniş', `${supplier.name} üçün ${purchaseId ? `alış #${purchaseId}` : 'ümumi'} ödənişi`, -amount, cashType, { supplierId: supplier.id, purchaseId: purchaseId });
                
                closeModal(paySupplierModal);
                renderPage('finance');
            });

            document.getElementById('paymentSupplierSelect').addEventListener('change', (e) => {
                const supplierId = parseInt(e.target.value);
                const purchases = getPurchases();
                const paymentPurchaseSelect = document.getElementById('paymentPurchaseSelect');
                const paymentPurchaseGroup = document.getElementById('payment-purchase-group');
                const supplierPaymentAmountInput = document.getElementById('supplierPaymentAmount');
                
                const transactions = getTransactions();
                const supplier = getSuppliers().find(s => s.id === supplierId);

                if (!supplierId) {
                    paymentPurchaseSelect.innerHTML = '';
                    paymentPurchaseGroup.style.display = 'none';
                    supplierPaymentAmountInput.value = '';
                    return;
                }

                const supplierPurchases = purchases.filter(p => p.supplierId === supplierId);
                
                let purchaseOptions = `<option value="">-- Ümumi Ödəniş --</option>`;
                let hasDebts = false;
                supplierPurchases.forEach(p => {
                    const paidAmount = transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === p.id).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    const remainingDebt = p.totalAmount - paidAmount;
                    if (remainingDebt > 0.01) {
                        hasDebts = true;
                        purchaseOptions += `<option value="${p.id}" data-debt="${remainingDebt.toFixed(2)}">#${p.id} - Tarix: ${p.date.split(',')[0]} - Borc: ${remainingDebt.toFixed(2)} ₼</option>`;
                    }
                });
                paymentPurchaseSelect.innerHTML = purchaseOptions;
                paymentPurchaseGroup.style.display = 'block';
                supplierPaymentAmountInput.value = supplier.balance.toFixed(2);
                supplierPaymentAmountInput.max = supplier.balance.toFixed(2);
            });

            document.getElementById('paymentPurchaseSelect').addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const supplierId = parseInt(document.getElementById('paymentSupplierSelect').value);
                const supplier = getSuppliers().find(s => s.id === supplierId);
                
                let debt;
                if(selectedOption.value) {
                    debt = selectedOption.dataset.debt;
                } else {
                    debt = supplier.balance.toFixed(2);
                }

                const supplierPaymentAmountInput = document.getElementById('supplierPaymentAmount');
                supplierPaymentAmountInput.value = debt;
                supplierPaymentAmountInput.max = debt;
            });

            function showSaleDetails(saleId) {
                const sale = getSales().find(s => s.id === saleId);
                const customer = getCustomers().find(c => c.id === sale.customerId);
                const customerName = sale.customerId === 0 ? "Nağd Alıcı" : (customer ? customer.name : "Silinmiş Müştəri");

                if (!sale) return;
                
                const itemsHtml = sale.items.map((i, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${i.name}</td>
                        <td>${i.imei1 || '-'}</td>
                        <td>${i.imei2 || '-'}</td>
                        <td>${i.salePrice.toFixed(2)} ₼</td>
                    </tr>
                `).join('');

                const debt = (sale.totalAmount - sale.initialPayment);
                
                let detailsHtml = `
                    <h3>Satış Detalları #${sale.id}</h3>
                    <div class="detail-info">
                        <div class="detail-item"><strong>Müştəri:</strong> <span>${customerName}</span></div>
                        <div class="detail-item"><strong>Tarix:</strong> <span>${sale.date}</span></div>
                        <div class="detail-item"><strong>Satış Növü:</strong> <span>${sale.type}</span></div>
                        <div class="detail-item"><strong>Yekun Məbləğ:</strong> <span>${sale.totalAmount.toFixed(2)} ₼</span></div>
                        <div class="detail-item"><strong>Ödənilən:</strong> <span class="positive">${sale.initialPayment.toFixed(2)} ₼</span></div>
                        <div class="detail-item"><strong>Qalıq Borc:</strong> <span class="negative">${debt.toFixed(2)} ₼</span></div>
                        ${sale.type === 'Kredit' ? `<div class="detail-item"><strong>Kredit Şərtləri:</strong> <span>${sale.loanTerm} ay, Aylıq ödəniş: ${sale.monthlyPayment.toFixed(2)} ₼</span></div>` : ''}
                    </div>
                    
                    <h4 style="margin-bottom:10px;">Satılan Məhsullar</h4>
                    <table class="data-table" style="width:100%;">
                        <thead><tr><th>#</th><th>Məhsul</th><th>IMEI 1</th><th>IMEI 2</th><th>Qiymət</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>`;

                if (debt > 0.01) {
                    detailsHtml += `<div style="text-align: right; margin-top: 1rem;"><button class="btn btn-success" onclick="openPaymentModalForSale(${saleId}, ${sale.customerId})">Ödəniş Et</button></div>`;
                }
                
                document.getElementById('saleDetailsContent').innerHTML = detailsHtml;
                openModal(saleDetailsModal);
            }

            function showPurchaseDetails(purchaseId) {
                const purchase = getPurchases().find(p => p.id === purchaseId);
                const supplier = getSuppliers().find(s => s.id === purchase.supplierId);
                const transactions = getTransactions();
                
                if (!purchase) return;

                const paidAmount = transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === purchaseId).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const remainingDebt = purchase.totalAmount - paidAmount;
                
                const itemsHtml = purchase.items.map((i, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${i.productName}</td>
                        <td>${i.purchasePrice.toFixed(2)} ₼</td>
                        <td>${i.imei1 || '-'}</td>
                        <td>${i.imei2 || '-'}</td>
                    </tr>
                `).join('');

                let detailsHtml = `
                    <h3>Alış Detalları #${purchase.id}</h3>
                    <div class="detail-info">
                        <div class="detail-item"><strong>Təchizatçı:</strong> <span>${supplier ? supplier.name : 'Silinmiş Təchizatçı'}</span></div>
                        <div class="detail-item"><strong>Tarix:</strong> <span>${purchase.date}</span></div>
                        <div class="detail-item"><strong>Yekun Məbləğ:</strong> <span>${purchase.totalAmount.toFixed(2)} ₼</span></div>
                        <div class="detail-item"><strong>Ödənilib:</strong> <span class="positive">${paidAmount.toFixed(2)} ₼</span></div>
                        <div class="detail-item"><strong>Borc Qalığı:</strong> <span class="negative">${remainingDebt.toFixed(2)} ₼</span></div>
                    </div>
                    
                    <h4 style="margin-bottom:10px;">Alınan Məhsullar</h4>
                    <table class="data-table" style="width:100%;">
                        <thead><tr><th>#</th><th>Məhsul</th><th>Alış Qiyməti</th><th>IMEI 1</th><th>IMEI 2</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>`;

                if (remainingDebt > 0.01) {
                    detailsHtml += `<div style="text-align: right; margin-top: 1rem;"><button class="btn btn-warning" style="color:white;" onclick="openSupplierPaymentModalForPurchase(${purchaseId}, ${purchase.supplierId})">Ödəniş Et</button></div>`;
                }

                document.getElementById('purchaseDetailsContent').innerHTML = detailsHtml;
                openModal(purchaseDetailsModal);
            }

            // Global functions for modals (accessible from onclick in dynamic HTML)
            window.openPaymentModalForSale = (saleId, customerId) => {
                const customer = getCustomers().find(c => c.id === customerId);
                const sale = getSales().find(s => s.id === saleId);
                if (!customer || !sale) return;

                closeModal(saleDetailsModal);
                
                acceptPaymentForm.reset();
                
                const customerSelect = document.getElementById('paymentCustomerSelect');
                customerSelect.innerHTML = `<option value="${customerId}">${customer.name} (Borc: ${customer.debt.toFixed(2)} ₼)</option>`;
                customerSelect.value = customerId;
                
                const remainingDebt = sale.totalAmount - sale.initialPayment;
                const saleSelect = document.getElementById('paymentSaleSelect');
                saleSelect.innerHTML = `<option value="${saleId}" data-debt="${remainingDebt.toFixed(2)}">#${sale.id} - ${sale.type} - Borc: ${remainingDebt.toFixed(2)} ₼</option>`;
                saleSelect.value = saleId;
                document.getElementById('payment-sale-group').style.display = 'block';

                document.getElementById('paymentAmount').value = remainingDebt.toFixed(2);
                document.getElementById('paymentAmount').max = remainingDebt.toFixed(2);

                openModal(acceptPaymentModal);
            };

            window.openSupplierPaymentModalForPurchase = (purchaseId, supplierId) => {
                const supplier = getSuppliers().find(s => s.id === supplierId);
                const purchase = getPurchases().find(p => p.id === purchaseId);
                if(!supplier || !purchase) return;

                const paidAmount = getTransactions().filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === purchaseId).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const remainingDebt = purchase.totalAmount - paidAmount;

                closeModal(purchaseDetailsModal);

                paySupplierForm.reset();
                document.getElementById('paymentSupplierSelect').innerHTML = `<option value="${supplierId}">${supplier.name} (Borc: ${supplier.balance.toFixed(2)} ₼)</option>`;
                document.getElementById('paymentSupplierSelect').value = supplierId;
                
                const paymentPurchaseSelect = document.getElementById('paymentPurchaseSelect');
                paymentPurchaseSelect.innerHTML = `<option value="${purchaseId}" data-debt="${remainingDebt.toFixed(2)}">#${purchaseId} - Borc: ${remainingDebt.toFixed(2)} ₼</option>`;
                paymentPurchaseSelect.value = purchaseId;
                document.getElementById('payment-purchase-group').style.display = 'block';

                const paymentInput = document.getElementById('supplierPaymentAmount');
                paymentInput.value = remainingDebt.toFixed(2);
                paymentInput.max = remainingDebt.toFixed(2);
                
                openModal(paySupplierModal);
            };

            function showSupplierDebtDetails(supplierId) {
                const purchases = getPurchases();
                const transactions = getTransactions();
                const supplier = getSuppliers().find(s => s.id === supplierId);
                if (!supplier) return;
                
                const supplierPurchases = purchases.filter(p => p.supplierId === supplierId);
                let totalSupplierDebt = 0;
                let rowsHtml = '';
                
                supplierPurchases.forEach((p, index) => {
                    const paidAmount = transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === p.id).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    const remainingDebt = p.totalAmount - paidAmount;
                    if(remainingDebt > 0.01) {
                        totalSupplierDebt += remainingDebt;
                        rowsHtml += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${p.id}</td>
                                <td>${p.date.split(',')[0]}</td>
                                <td>${p.totalAmount.toFixed(2)} ₼</td>
                                <td class="positive">${paidAmount.toFixed(2)} ₼</td>
                                <td class="negative">${remainingDebt.toFixed(2)} ₼</td>
                                <td><button class="btn btn-warning pay-supplier-debt-btn" data-id="${p.id}" data-supplierid="${supplier.id}" style="color:white; background:var(--warning-color); padding: 0.5rem 1rem;">Ödəniş et</button></td>
                            </tr>`;
                    }
                });

                let detailsHtml = `
                    <h3>Təchizatçı: ${supplier.name}</h3>
                    <div class="detail-info">
                        <div class="detail-item"><strong>Ümumi Alış Borcu:</strong> <span class="negative">${totalSupplierDebt.toFixed(2)} ₼</span></div>
                        <div class="detail-item"><strong>Telefon:</strong> <span>${supplier.phone || '-'}</span></div>
                    </div>
                    <h4 style="margin-top: 1rem;">Alış Qaimələri</h4>
                    <table class="data-table" style="margin-top: 1rem; font-size: 0.9rem;">
                        <thead><tr><th>#</th><th>Alış ID</th><th>Tarix</th><th>Məbləğ</th><th>Ödənilib</th><th>Borc Qalığı</th><th></th></tr></thead>
                        <tbody>${rowsHtml}</tbody>
                        <tfoot>
                            <tr><td colspan="5" style="text-align:right;">CƏMİ BORC:</td><td class="negative">${totalSupplierDebt.toFixed(2)} ₼</td><td></td></tr>
                        </tfoot>
                    </table>`;
                
                document.getElementById('supplierDebtDetailsContent').innerHTML = detailsHtml;
                openModal(supplierDebtDetailsModal);
            }

            function deleteSale(saleId) {
                if (!confirm('Satışı silməyə əminsiniz? Bu, bütün əlaqəli məlumatları siləcək!')) return;
                
                const sales = getSales();
                const stock = getStock();
                const customers = getCustomers();
                const transactions = getTransactions();

                const saleIndex = sales.findIndex(s => s.id === saleId);
                if (saleIndex === -1) return;

                const saleToDelete = sales[saleIndex];
                
                stock.forEach(item => {
                    if(item.saleId === saleId) {
                        item.isSold = false;
                        item.saleId = null;
                        item.salePrice = 0;
                    }
                });

                const customer = customers.find(c => c.id === saleToDelete.customerId);
                if (customer) {
                    customer.debt = parseFloat((customer.debt - (saleToDelete.totalAmount - saleToDelete.initialPayment)).toFixed(2));
                }

                const relatedTransactions = transactions.filter(t => t.details && t.details.saleId === saleId);
                relatedTransactions.forEach(tr => {
                    if (tr.details.cashType === 'Nağd Kassa') {
                        DATA.cashBalance.naqd = parseFloat((DATA.cashBalance.naqd - tr.amount).toFixed(2));
                    } else if (tr.details.cashType === 'POS Kassa') {
                        DATA.cashBalance.pos = parseFloat((DATA.cashBalance.pos - tr.amount).toFixed(2));
                    }
                });
                
                DATA.transactions = transactions.filter(t => t.details.saleId !== saleId);
                DATA.sales.splice(saleIndex, 1);

                saveToStorage();
                alert('Satış uğurla silindi!');
                renderPage('reports');
            }

            function deletePurchase(purchaseId) {
                if (!confirm('Alışı silməyə əminsiniz? Bu, bütün əlaqəli məlumatları siləcək!')) return;
                
                const purchases = getPurchases();
                const stock = getStock();
                const suppliers = getSuppliers();
                const transactions = getTransactions();

                const purchaseIndex = purchases.findIndex(p => p.id === purchaseId);
                if (purchaseIndex === -1) return;
                
                const purchaseToDelete = purchases[purchaseIndex];
                const hasSoldItems = stock.some(s => s.purchaseId === purchaseToDelete.id && s.isSold);

                if(hasSoldItems) {
                    alert('Bu alışa aid satılmış məhsul var. Silinə bilməz!');
                    return;
                }

                const supplier = suppliers.find(s => s.id === purchaseToDelete.supplierId);
                if (supplier) {
                    const paidAmount = transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === purchaseId).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    const remainingDebt = purchaseToDelete.totalAmount - paidAmount;
                    supplier.balance = parseFloat((supplier.balance - remainingDebt).toFixed(2));
                }

                DATA.stock = stock.filter(s => s.purchaseId !== purchaseId);
                
                const relatedTransactions = transactions.filter(t => t.details && t.details.purchaseId === purchaseId);
                relatedTransactions.forEach(tr => {
                    if (tr.details.cashType === 'Nağd Kassa') {
                        DATA.cashBalance.naqd = parseFloat((DATA.cashBalance.naqd - tr.amount).toFixed(2));
                    } else if (tr.details.cashType === 'POS Kassa') {
                        DATA.cashBalance.pos = parseFloat((DATA.cashBalance.pos - tr.amount).toFixed(2));
                    }
                });
                
                DATA.transactions = transactions.filter(t => t.details.purchaseId !== purchaseId);
                DATA.purchases.splice(purchaseIndex, 1);

                saveToStorage();
                alert('Alış uğurla silindi!');
                renderPage('reports');
            }

            function deleteTransaction(id) {
                const transactions = getTransactions();
                const transactionToDelete = transactions.find(t => t.id === id);
                
                if (!transactionToDelete) return;

                if (confirm(`"${transactionToDelete.description}" əməliyyatını silməyə əminsiniz?`)) {
                    
                    if (transactionToDelete.details && transactionToDelete.details.customerId && transactionToDelete.amount > 0) {
                        const customers = getCustomers();
                        const sales = getSales();
                        let customer = customers.find(c => c.id === transactionToDelete.details.customerId);
                        let sale = sales.find(s => s.id === transactionToDelete.details.saleId);

                        if (customer) {
                            customer.debt = parseFloat((customer.debt + transactionToDelete.amount).toFixed(2));
                        }
                        if (sale) {
                            sale.initialPayment = parseFloat((sale.initialPayment - transactionToDelete.amount).toFixed(2));
                            if (sale.payments) {
                                sale.payments = sale.payments.filter(p => p.transactionId !== id);
                            }
                        }
                    } else if (transactionToDelete.details && transactionToDelete.details.supplierId && transactionToDelete.amount < 0) {
                        let suppliers = getSuppliers();
                        let supplier = suppliers.find(s => s.id === transactionToDelete.details.supplierId);
                        if (supplier) {
                            const paidAmount = Math.abs(transactionToDelete.amount);
                            supplier.balance = parseFloat((supplier.balance + paidAmount).toFixed(2));
                        }
                    }
                    
                    if (transactionToDelete.details.cashType === 'Nağd Kassa') {
                        DATA.cashBalance.naqd = parseFloat((DATA.cashBalance.naqd - transactionToDelete.amount).toFixed(2));
                    } else if (transactionToDelete.details.cashType === 'POS Kassa') {
                        DATA.cashBalance.pos = parseFloat((DATA.cashBalance.pos - transactionToDelete.amount).toFixed(2));
                    }

                    DATA.transactions = transactions.filter(t => t.id !== id);
                    saveToStorage();
                    renderPage(document.querySelector('.sidebar nav a.active').dataset.page);
                }
            }
            
            // --- General Helpers for Date Formatting and Filtering ---
            const parseDate = (dateStr) => {
                const [datePart] = dateStr.split(',');
                const [day, month, year] = datePart.split('.').map(Number);
                return new Date(year, month - 1, day);
            };

            const isDateInRange = (dateStr, startDate, endDate) => {
                if (!dateStr) return true;
                const date = parseDate(dateStr);
                const start = startDate ? parseDate(startDate) : null;
                const end = endDate ? parseDate(endDate) : null;
                
                let matches = true;
                if (start) matches = matches && date >= start;
                if (end) {
                    const endPlusOne = new Date(end);
                    endPlusOne.setDate(endPlusOne.getDate() + 1);
                    matches = matches && date < endPlusOne;
                }
                return matches;
            };

            // --- Page Setup Functions ---

            function setupHomePage() {
                const sales = getSales();
                const purchases = getPurchases();
                const transactions = getTransactions();
                const stock = getStock();
                
                const totalSalesIncome = sales.reduce((sum, sale) => sum + sale.totalAmount, 0);
                const totalOtherIncome = transactions.filter(t => t.type === 'Digər Mədaxil').reduce((sum, t) => sum + t.amount, 0);
                const totalTurnover = totalSalesIncome + totalOtherIncome;
                
                const totalPurchaseCost = purchases.reduce((sum, purchase) => sum + purchase.totalAmount, 0);
                const totalExpenses = transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const otherExpenses = transactions.filter(t => t.type.includes('xərc')).reduce((sum, t) => sum + Math.abs(t.amount), 0);

                const netProfit = totalSalesIncome - totalPurchaseCost - otherExpenses;
                
                const stockValue = stock.filter(item => !item.isSold).reduce((sum, item) => sum + item.purchasePrice, 0);

                const soldProductsCount = stock.filter(item => item.isSold).length;
                const inStockProductsCount = stock.filter(item => !item.isSold).length;
                
                document.getElementById('total-turnover').textContent = `${totalSalesIncome.toFixed(2)} ₼`;
                document.getElementById('total-expense').textContent = `${totalExpenses.toFixed(2)} ₼`;
                document.getElementById('net-profit').textContent = `${netProfit.toFixed(2)} ₼`;
                document.getElementById('net-profit').classList.toggle('negative', netProfit < 0);
                document.getElementById('stock-value').textContent = `${stockValue.toFixed(2)} ₼`;
                document.getElementById('sold-products').textContent = `${soldProductsCount} ədəd`;
                document.getElementById('in-stock-products').textContent = `${inStockProductsCount} ədəd`;
            }

            function setupProductsPage() {
                const productTableBody = appContainer.querySelector('#productTableBody');
                const addProductBtn = appContainer.querySelector('#addProductBtn');
                const productSearch = appContainer.querySelector('#productSearch');
                const tfoot = productTableBody.nextElementSibling;

                const renderProducts = () => {
                    const query = productSearch.value.toLowerCase();
                    let products = getProducts();
                    if (query) {
                        products = products.filter(p => p.name.toLowerCase().includes(query) || p.id.toString().includes(query));
                    }
                    
                    const fragment = document.createDocumentFragment();
                    if (products.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="4" style="text-align:center;">Məhsul tapılmadı.</td>';
                        fragment.appendChild(tr);
                        tfoot.innerHTML = '';
                    } else {
                        products.forEach((p, index) => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${index + 1}</td><td>${p.id}</td><td>${p.name}</td><td>${p.category || '-'}</td><td class="actions-cell"><button class="btn-edit" data-id="${p.id}">✏️</button><button class="btn-delete" data-id="${p.id}">🗑️</button></td>`;
                            fragment.appendChild(tr);
                        });
                    }
                    productTableBody.innerHTML = '';
                    productTableBody.appendChild(fragment);
                };
                
                addProductBtn.addEventListener('click', () => { addProductForm.reset(); openModal(addProductModal); });
                productTableBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const id = parseInt(btn.dataset.id);
                    if (btn.classList.contains('btn-delete')) {
                        const stockItems = getStock();
                        const isUsedInStock = stockItems.some(item => item.productId === id);
                        if (isUsedInStock) {
                            alert('Bu məhsul anbarda olduğu üçün silinə bilməz!');
                            return;
                        }
                        if (confirm('Məhsulu silməyə əminsiniz?')) {
                            DATA.products = DATA.products.filter(p => p.id !== id);
                            saveToStorage();
                            renderProducts();
                        }
                    }
                    if (btn.classList.contains('btn-edit')) {
                        const product = getProducts().find(p => p.id === id);
                        if (product) {
                            document.getElementById('editProductId').value = product.id;
                            document.getElementById('editProductName').value = product.name;
                            document.getElementById('editProductCategory').value = product.category || '';
                            openModal(editProductModal);
                        }
                    }
                });
                productSearch.addEventListener('input', renderProducts);
                renderProducts();
            }

            function setupStockPage() {
                const stockTableBody = appContainer.querySelector('#stockTableBody');
                const stockSearch = appContainer.querySelector('#stockSearch');
                
                const renderStock = () => {
                    const query = stockSearch.value.toLowerCase();
                    let stockItems = getStock();
                    const products = getProducts();
                    const suppliers = getSuppliers();

                    if (query) {
                        stockItems = stockItems.filter(item => {
                            const product = products.find(p => p.id === item.productId);
                            const productName = product ? product.name.toLowerCase() : 'silinmis mehsul';
                            return (productName.includes(query)) ||
                                   (item.imei1 && item.imei1.toLowerCase().includes(query)) ||
                                   (item.imei2 && item.imei2.toLowerCase().includes(query));
                        });
                    }
                    
                    const fragment = document.createDocumentFragment();
                    if (stockItems.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="8" style="text-align:center;">Anbarda məhsul tapılmadı.</td>';
                        fragment.appendChild(tr);
                    } else {
                        stockItems.forEach((item, index) => {
                            const product = products.find(p => p.id === item.productId);
                            const supplier = suppliers.find(s => s.id === item.supplierId);
                            const statusText = item.isSold ? 'Satılıb' : 'Anbarda';
                            const statusClass = item.isSold ? 'satilib' : 'anbarda';
                            
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${product ? product.name : 'Silinmiş Məhsul'}</td>
                                <td>${item.purchaseDate.split(',')[0]}</td>
                                <td>${supplier ? supplier.name : 'Silinmiş Təchizatçı'}</td>
                                <td>${item.purchasePrice.toFixed(2)} ₼</td>
                                <td>${item.imei1 || '-'}</td>
                                <td>${item.imei2 || '-'}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            `;
                            fragment.appendChild(tr);
                        });
                    }
                    stockTableBody.innerHTML = '';
                    stockTableBody.appendChild(fragment);
                };

                stockSearch.addEventListener('input', renderStock);
                renderStock();
            }

            function setupCustomersPage() {
                const customerTableBody = appContainer.querySelector('#customerTableBody');
                const addCustomerBtn = appContainer.querySelector('#addCustomerBtn');
                const customerSearch = appContainer.querySelector('#customerSearch');
                const tfoot = customerTableBody.nextElementSibling;
                
                const populateGuarantorSelects = () => {
                    const customers = getCustomers();
                    const addGuarantorSelect = document.getElementById('customerGuarantorModal');
                    const editGuarantorSelect = document.getElementById('editCustomerGuarantor');
                    
                    const optionsHtml = customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                    addGuarantorSelect.innerHTML = '<option value="">-- Zamin Seçin --</option>' + optionsHtml;
                    editGuarantorSelect.innerHTML = '<option value="">-- Zamin Seçin --</option>' + optionsHtml;
                };

                const renderCustomers = () => {
                    const query = customerSearch.value.toLowerCase();
                    let customers = getCustomers();
                    const sales = getSales();
                    
                    if(query){
                        customers = customers.filter(c => c.name.toLowerCase().includes(query) || c.phone.includes(query));
                    }
                    
                    let totalDebt = 0;
                    const fragment = document.createDocumentFragment();

                    if (customers.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="7" style="text-align:center;">Müştəri tapılmadı.</td>';
                        fragment.appendChild(tr);
                        tfoot.innerHTML = '';
                    } else {
                        customers.forEach((c, index) => {
                            totalDebt += c.debt;
                            const totalSalesAmount = sales.filter(s => s.customerId === c.id).reduce((sum, s) => sum + s.totalAmount, 0);

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${c.id}</td>
                                <td>${c.name}</td>
                                <td>${c.phone}</td>
                                <td class="${c.debt > 0.01 ? 'negative' : 'positive'}">${c.debt.toFixed(2)} ₼</td>
                                <td>${totalSalesAmount.toFixed(2)} ₼</td>
                                <td class="actions-cell">
                                    <button class="btn-details customer-details-btn" data-id="${c.id}" title="Ətraflı Məlumat" style="color: var(--primary-color);">ℹ️</button>
                                    <button class="btn-edit" data-id="${c.id}" title="Redaktə Et">✏️</button>
                                    <button class="btn-delete" data-id="${c.id}" title="Sil">🗑️</button>
                                </td>
                            `;
                            fragment.appendChild(tr);
                        });
                        tfoot.innerHTML = `<tr><td colspan="4" style="text-align:right;">CƏMİ BORC:</td><td class="${totalDebt > 0.01 ? 'negative' : 'positive'}">${totalDebt.toFixed(2)} ₼</td><td></td><td></td></tr>`;
                    }
                    customerTableBody.innerHTML = '';
                    customerTableBody.appendChild(fragment);
                };
                
                addCustomerBtn.addEventListener('click', () => {
                    addCustomerForm.reset();
                    populateGuarantorSelects();
                    openModal(addCustomerModal);  
                });
                
                customerSalesHistoryModal.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (btn && btn.classList.contains('payment-history-btn')) {
                        const saleId = parseInt(btn.dataset.id);
                        const sale = getSales().find(s => s.id === saleId);
                        if (!sale) return;
                        
                        const paymentHistoryTitle = document.getElementById('payment-history-title');
                        const paymentHistoryContent = document.getElementById('paymentHistoryContent');
                        paymentHistoryTitle.textContent = `Satış #${sale.id} - Ödəniş Tarixçəsi`;
                        
                        const payments = (sale.payments || []);
                        const paymentsHtml = payments.map((p, index) => `<tr><td>${index + 1}</td><td>${p.date.split(',')[0]}</td><td>${p.type}</td><td>${p.amount.toFixed(2)} ₼</td></tr>`).join('');

                        const totalPayments = payments.reduce((sum, p) => sum + p.amount, 0);

                        paymentHistoryContent.innerHTML = `
                            <table class="data-table">
                                <thead><tr><th>#</th><th>Tarix</th><th>Kassa Növü</th><th>Məbləğ</th></tr></thead>
                                <tbody>
                                    ${payments.length === 0 ? `<tr><td colspan="4" style="text-align:center;">Hələ ödəniş edilməyib.</td></tr>` : paymentsHtml}
                                </tbody>
                                <tfoot>
                                    <tr><td colspan="3" style="text-align:right;">CƏMİ ÖDƏNİŞ:</td><td class="positive">${totalPayments.toFixed(2)} ₼</td></tr>
                                </tfoot>
                            </table>`;
                        
                        openModal(paymentHistoryModal);
                    }
                });

                customerTableBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const id = parseInt(btn.dataset.id);
                    if (btn.classList.contains('customer-details-btn')) {
                        const customer = getCustomers().find(c => c.id === id);
                        if (!customer) return;
                        const sales = getSales().filter(s => s.customerId === id).reverse();
                        const allCustomers = getCustomers();

                        let guarantorName = "Seçilməyib";
                        if(customer.guarantorId) {
                            const guarantor = allCustomers.find(g => g.id === customer.guarantorId);
                            if(guarantor) guarantorName = guarantor.name;
                        }
                        
                        const totalSalesAmount = sales.reduce((sum, s) => sum + s.totalAmount, 0);
                        const totalPaidAmount = sales.reduce((sum, s) => sum + s.initialPayment, 0);
                        const creditTurnover = sales.filter(s => s.type === 'Kredit').reduce((sum, s) => sum + s.totalAmount, 0);
                        const corporateTurnover = sales.filter(s => s.type === 'Korporativ').reduce((sum, s) => sum + s.totalAmount, 0);
                        const invoiceTurnover = sales.filter(s => s.type === 'Açıq Qaimə').reduce((sum, s) => sum + s.totalAmount, 0);
                        const cashTurnover = sales.filter(s => ['Nağd', 'POS Terminal'].includes(s.type)).reduce((sum, s) => sum + s.totalAmount, 0);

                        const historyTitle = document.getElementById('customer-history-title');
                        const historyContent = document.getElementById('customerSalesHistoryContent');
                        historyTitle.textContent = `${customer.name} - Ətraflı Məlumat`;

                        let summaryCardsHtml = `
                            <div class="summary-cards" style="margin-bottom: 2rem;">
                                <div class="card"><h3>Ümumi Dövriyyə</h3><p>${totalSalesAmount.toFixed(2)} ₼</p></div>
                                <div class="card"><h3>Cəmi Ödənilən</h3><p class="positive">${totalPaidAmount.toFixed(2)} ₼</p></div>
                                <div class="card"><h3>Ümumi Qalıq Borc</h3><p class="negative">${customer.debt.toFixed(2)} ₼</p></div>
                                <div class="card"><h3>Kredit Dövriyyəsi</h3><p>${creditTurnover.toFixed(2)} ₼</p></div>
                                <div class="card"><h3>Korporativ Dövriyyəsi</h3><p>${corporateTurnover.toFixed(2)} ₼</p></div>
                                <div class="card"><h3>Açıq Qaimə Dövriyyəsi</h3><p>${invoiceTurnover.toFixed(2)} ₼</p></div>
                                <div class="card"><h3>Nağd Satış Dövriyyəsi</h3><p>${cashTurnover.toFixed(2)} ₼</p></div>
                            </div>`;

                        let customerInfoHtml = `
                            <div style="background: #f9fafb; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border-color); margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div class="detail-item"><strong>Ş/V Seriya:</strong> <span>${customer.sv_seria || 'Qeyd edilməyib'}</span></div>
                                <div class="detail-item"><strong>FİN Kodu:</strong> <span>${customer.fin || 'Qeyd edilməyib'}</span></div>
                                <div class="detail-item"><strong>Telefon:</strong> <span>${customer.phone || 'Qeyd edilməyib'}</span></div>
                                <div class="detail-item"><strong>Zamin:</strong> <span>${guarantorName}</span></div>
                                <div class="detail-item" style="grid-column: 1 / -1;"><strong>Ünvan:</strong> <span>${customer.unvan || 'Qeyd edilməyib'}</span></div>
                            </div>`;
                        
                        let salesHistoryHtml = `
                            <h4>Satış Tarixçəsi</h4>
                            <table class="data-table" style="margin-top: 1rem; font-size: 0.8rem;">
                                <thead><tr><th>#</th><th>Satış ID</th><th>Tarix</th><th>Növ</th><th>Yekun Məbləğ</th><th>Ödənilib</th><th>Borc Qalığı</th><th></th></tr></thead>
                                <tbody>`;
                        
                        const allProducts = getProducts();
                        if (sales.length === 0) {
                            salesHistoryHtml += '<tr><td colspan="8" style="text-align:center;">Bu müştərinin satış tarixçəsi yoxdur.</td></tr>';
                        } else {
                            sales.forEach((sale, index) => {
                                const debt = (sale.totalAmount - sale.initialPayment);
                                const productDetailsHtml = sale.items.map(item => {
                                    const product = allProducts.find(p => p.id === item.productId);
                                    return `
                                        <tr>
                                            <td>${product ? product.name : 'Silinmiş Məhsul'}</td>
                                            <td>${item.imei1 || '-'}</td>
                                            <td>${item.imei2 || '-'}</td>
                                            <td>${item.salePrice.toFixed(2)} ₼</td>
                                        </tr>`;
                                }).join('');

                                salesHistoryHtml += `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${sale.id}</td>
                                        <td>${sale.date.split(',')[0]}</td>
                                        <td>${sale.type}</td>
                                        <td>${sale.totalAmount.toFixed(2)} ₼</td>
                                        <td class="positive">${sale.initialPayment.toFixed(2)} ₼</td>
                                        <td class="${debt > 0.01 ? 'negative' : ''}">${debt.toFixed(2)} ₼</td>
                                        <td class="actions-cell">
                                            <button class="btn btn-warning payment-history-btn" data-id="${sale.id}" style="padding: 0.5rem; color:#212121; box-shadow: none;">Ödəniş Tarixçəsi</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="8" style="padding-top: 0;">
                                            <div class="product-details">
                                                <strong>Satılan Məhsullar:</strong>
                                                <table class="data-table" style="width: 100%; margin-top: 0.5rem;">
                                                    <thead><tr><th>Məhsul Adı</th><th>IMEI 1</th><th>IMEI 2</th><th>Qiymət</th></tr></thead>
                                                    <tbody>${productDetailsHtml}</tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>`;
                            });
                        }
                        const totalSale = sales.reduce((sum, s) => sum + s.totalAmount, 0);
                        const totalPaid = sales.reduce((sum, s) => sum + s.initialPayment, 0);
                        const totalDebtRem = sales.reduce((sum, s) => sum + (s.totalAmount - s.initialPayment), 0);
                        salesHistoryHtml += `</tbody>
                            <tfoot><tr><td colspan="4" style="text-align:right;">CƏMİ:</td><td>${totalSale.toFixed(2)} ₼</td><td>${totalPaid.toFixed(2)} ₼</td><td class="negative">${totalDebtRem.toFixed(2)} ₼</td><td></td></tr></tfoot>
                            </table>`;
                        
                        historyContent.innerHTML = summaryCardsHtml + customerInfoHtml + salesHistoryHtml;
                        openModal(customerSalesHistoryModal);
                        return;
                    }
                    if (btn.classList.contains('btn-delete')) {
                        const customer = getCustomers().find(c => c.id === id);
                        if (customer.debt > 0) {
                            alert('Bu müştərinin borcu olduğu üçün silinə bilməz!');
                            return;
                        }
                        if (confirm('Müştərini silməyə əminsiniz?')) {
                            DATA.customers.find(c => c.id === id).isActive = false;
                            saveToStorage();
                            renderCustomers();
                        }
                    }
                    if (btn.classList.contains('btn-edit')) {
                        const customer = getCustomers().find(c => c.id === id);
                        if (customer) {
                            populateGuarantorSelects();
                            document.getElementById('editCustomerId').value = customer.id;
                            document.getElementById('editCustomerName').value = customer.name;
                            document.getElementById('editCustomerSv').value = customer.sv_seria || '';
                            document.getElementById('editCustomerFin').value = customer.fin || '';
                            document.getElementById('editCustomerAddress').value = customer.unvan || '';
                            document.getElementById('editCustomerPhone').value = customer.phone;
                            document.getElementById('editCustomerGuarantor').value = customer.guarantorId || '';
                            openModal(editCustomerModal);
                        }
                    }
                });

                customerSearch.addEventListener('input', renderCustomers);
                renderCustomers();
            }

            function setupSuppliersPage() {
                const supplierTableBody = appContainer.querySelector('#supplierTableBody');
                const addSupplierBtn = appContainer.querySelector('#addSupplierBtn');
                const supplierSearch = appContainer.querySelector('#supplierSearch');
                const tfoot = supplierTableBody.nextElementSibling;
                const renderSuppliers = () => {
                    const query = supplierSearch.value.toLowerCase();
                    let suppliers = getSuppliers();
                    if(query) {
                        suppliers = suppliers.filter(s => s.name.toLowerCase().includes(query) || (s.phone && s.phone.includes(query)));
                    }
                    
                    let totalBalance = 0;
                    const fragment = document.createDocumentFragment();

                    if (suppliers.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="6" style="text-align:center;">Təchizatçı tapılmadı.</td>';
                        fragment.appendChild(tr);
                        tfoot.innerHTML = '';
                    } else {
                        suppliers.forEach((s, index) => {
                            const balance = s.balance || 0;
                            totalBalance += balance;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${index + 1}</td><td>${s.id}</td><td>${s.name}</td><td>${s.phone || '-'}</td><td class="${balance > 0.01 ? 'negative' : 'positive'}">${balance.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-edit" data-id="${s.id}">✏️</button><button class="btn-delete" data-id="${s.id}">🗑️</button></td></tr>`;
                            fragment.appendChild(tr);
                        });
                        tfoot.innerHTML = `<tr><td colspan="4" style="text-align:right;">CƏMİ BORCUMUZ:</td><td class="${totalBalance > 0.01 ? 'negative' : 'positive'}">${totalBalance.toFixed(2)} ₼</td><td></td></tr>`;
                    }
                    supplierTableBody.innerHTML = '';
                    supplierTableBody.appendChild(fragment);
                };
                addSupplierBtn.addEventListener('click', () => { addSupplierForm.reset(); openModal(addSupplierModal); });
                supplierTableBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const id = parseInt(btn.dataset.id);
                    if (btn.classList.contains('btn-delete')) {
                        const supplier = getSuppliers().find(s => s.id === id);
                        if ((supplier.balance || 0) > 0) {
                            alert('Bu təchizatçıya borc olduğu üçün silinə bilməz!');
                            return;
                        }
                        if (confirm('Təchizatçını silməyə əminsiniz?')) {
                            DATA.suppliers.find(s => s.id === id).isActive = false;
                            saveToStorage();
                            renderSuppliers();
                        }
                    }
                    if (btn.classList.contains('btn-edit')) {
                        const supplier = getSuppliers().find(s => s.id === id);
                        if (supplier) {
                            document.getElementById('editSupplierId').value = supplier.id;
                            document.getElementById('editSupplierName').value = supplier.name;
                            document.getElementById('editSupplierPhone').value = supplier.phone;
                            openModal(editSupplierModal);
                        }
                    }
                });
                supplierSearch.addEventListener('input', renderSuppliers);
                renderSuppliers();
            }
            
            function setupSalesPage() {
                const saleTabs = appContainer.querySelector('#sale-tabs');
                const saleViews = appContainer.querySelectorAll('.sale-view');
                const forms = {
                    cash: appContainer.querySelector('#cashSaleForm'),
                    credit: appContainer.querySelector('#creditSaleForm'),
                    corporate: appContainer.querySelector('#corporateSaleForm')
                };
                
                const carts = { cash: [], credit: [], corporate: [] };
                let activeTab = 'cash';
                
                const populateDropdowns = (view) => {
                    const customers = getCustomers();
                    const customerSelect = view.querySelector('.sale-customer');
                    
                    const currentCustomerId = customerSelect.value;
                    customerSelect.innerHTML = '<option value="">-- Müştəri Seçin --</option>';
                    if (activeTab === 'cash') {
                        customerSelect.innerHTML += '<option value="0">Nağd Alıcı</option>';
                    }
                    customers.forEach(c => { customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
                    customerSelect.value = currentCustomerId;
                };

                const calculateTotal = (cart, view) => {
                    const total = cart.reduce((sum, item) => sum + (parseFloat(item.salePrice) || 0), 0);
                    view.querySelector('.summary-total').textContent = `${total.toFixed(2)} ₼`;

                    const tfoot = view.querySelector('.cart-table-body').nextElementSibling;
                    tfoot.innerHTML = `<tr><td colspan="4" style="text-align:right;">CƏMİ:</td><td>${total.toFixed(2)} ₼</td><td></td></tr>`;

                    if (view.id === 'corporate-sale-view' || view.id === 'credit-sale-view') {
                        const initialPayment = parseFloat(view.querySelector('.initial-payment').value) || 0;
                        const debt = total - initialPayment;
                        const debtTotalEl = view.querySelector('.debt-total');
                        if (debtTotalEl) {
                            debtTotalEl.textContent = `${debt.toFixed(2)} ₼`;
                        }
                    }
                    return total;
                };

                const renderCart = (cart, view) => {
                    const cartBody = view.querySelector('.cart-table-body');
                    const fragment = document.createDocumentFragment();

                    if (cart.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="6" style="text-align:center;">Səbət boşdur</td>';
                        fragment.appendChild(tr);
                    } else {
                        cart.forEach((item, index) => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<tr>
                                <td>${index + 1}</td>
                                <td>${item.name}</td>
                                <td>${item.imei1 || '-'}</td>
                                <td>${item.imei2 || '-'}</td>
                                <td><input type="number" class="cart-price-input" data-id="${item.stockId}" value="${(item.salePrice || 0).toFixed(2)}" step="0.01" min="0"></td>
                                <td class="actions-cell"><button type="button" class="btn-delete cart-remove-btn" data-id="${item.stockId}">🗑️</button></td>
                            </tr>`;
                            fragment.appendChild(tr);
                        });
                    }
                    cartBody.innerHTML = '';
                    cartBody.appendChild(fragment);

                    calculateTotal(cart, view);
                    if (activeTab === 'credit') generatePaymentSchedule();
                };
                
                const generatePaymentSchedule = () => {
                    const view = forms.credit;
                    const scheduleDiv = view.querySelector('#payment-schedule');
                    const total = calculateTotal(carts.credit, view);
                    const initialPayment = parseFloat(view.querySelector('.initial-payment').value) || 0;
                    const loanTerm = parseInt(view.querySelector('.loan-term').value);

                    if (total <= 0 || total < initialPayment) {
                        scheduleDiv.innerHTML = '';
                        return;
                    }

                    const loanAmount = total - initialPayment;
                    const monthlyPayment = loanAmount / loanTerm;

                    let scheduleHtml = '<h4>Ödəniş Cədvəli</h4><table class="data-table" style="margin-top: 1rem;"><thead><tr><th>Ödəniş Tarixi</th><th>Aylıq Ödəniş</th></tr></thead><tbody>';
                    let currentDate = new Date();
                    for (let i = 1; i <= loanTerm; i++) {
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        scheduleHtml += `<tr><td>${currentDate.toLocaleDateString('az-AZ')}</td><td>${monthlyPayment.toFixed(2)} ₼</td></tr>`;
                    }
                    scheduleHtml += '</tbody></table>';
                    scheduleDiv.innerHTML = scheduleHtml;
                };

                appContainer.addEventListener('input', (e) => {
                    const activeView = forms[activeTab];
                    if (!activeView.contains(e.target)) return;

                    if (e.target.classList.contains('cart-price-input')) {
                        const stockId = parseFloat(e.target.dataset.id);
                        const cart = carts[activeTab];
                        const item = cart.find(i => i.stockId === stockId);
                        if (!item) return;

                        item.salePrice = parseFloat(e.target.value) || 0;
                        renderCart(cart, activeView); // Recalculate and rerender to update total
                    }
                    if (e.target.classList.contains('initial-payment') || e.target.classList.contains('loan-term')) {
                        calculateTotal(carts[activeTab], activeView);
                        if (activeTab === 'credit') {
                                generatePaymentSchedule();
                        }
                    }
                });
                
                forms.cash.querySelector('.payment-type').addEventListener('change', (e) => {
                    const cashTypeGroup = forms.cash.querySelector('#cash-sale-cash-type-group');
                    if (e.target.value === 'Açıq Qaimə') {
                        cashTypeGroup.style.display = 'none';
                    } else {
                        cashTypeGroup.style.display = 'block';
                    }
                });

                appContainer.addEventListener('click', (e) => {
                    const activeView = forms[activeTab];
                    if (!activeView.contains(e.target)) return;

                    const btn = e.target.closest('button');
                    if (!btn) return;

                    if(btn.classList.contains('cart-remove-btn')) {
                        const stockId = parseFloat(btn.dataset.id);
                        const stockItem = getStock().find(s => s.id === stockId);
                        if(stockItem) stockItem.salePrice = 0; // Reset salePrice in stock item
                        carts[activeTab] = carts[activeTab].filter(i => i.stockId !== stockId);
                        renderCart(carts[activeTab], activeView);
                    }
                    if (btn.classList.contains('add-customer-quick')) {
                        addCustomerForm.reset();
                        const guarantorSelect = document.getElementById('customerGuarantorModal');
                        const customers = getCustomers();
                        guarantorSelect.innerHTML = '<option value="">-- Zamin Seçin --</option>';
                        customers.forEach(c => { guarantorSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
                        openModal(addCustomerModal);
                    }
                });

                saleTabs.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    saleTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    activeTab = button.dataset.saleType;

                    saleViews.forEach(view => {
                        view.style.display = view.id.startsWith(activeTab) ? 'block' : 'none';
                    });
                    
                    if (activeTab === 'cash') {
                         forms.cash.querySelector('#cash-sale-cash-type-group').style.display = forms.cash.querySelector('.payment-type').value === 'Açıq Qaimə' ? 'none' : 'block';
                    }
                    
                    renderCart(carts[activeTab], forms[activeTab]);
                    populateDropdowns(forms[activeTab]);
                });

                const handleImeiSearch = (e) => {
                    const imei = e.target.value.trim().toUpperCase();
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (imei.length > 0) {
                            const stockItems = getStock();
                            const products = getProducts();
                            const cart = carts[activeTab];

                            const availableItem = stockItems.find(item => 
                                (item.imei1 === imei || item.imei2 === imei) && !item.isSold
                            );
                            
                            if (availableItem) {
                                const product = products.find(p => p.id === availableItem.productId);
                                const existingItem = cart.find(item => item.stockId === availableItem.id);

                                if (!existingItem) {
                                    cart.push({
                                        stockId: availableItem.id,
                                        name: product.name,
                                        imei1: availableItem.imei1,
                                        imei2: availableItem.imei2,
                                        salePrice: availableItem.salePrice || 0,
                                        productId: product.id
                                    });
                                    renderCart(cart, forms[activeTab]);
                                } else {
                                    alert('Bu IMEI-ə aid məhsul artıq səbətdədir.');
                                }
                            } else {
                                alert('Məhsul anbarda tapılmadı və ya artıq satılıb.');
                            }
                            e.target.value = '';
                        }
                    }
                };
                
                appContainer.querySelector('#imeiSearchInput').addEventListener('keydown', handleImeiSearch);
                appContainer.querySelector('#imeiSearchInputCredit').addEventListener('keydown', handleImeiSearch);
                appContainer.querySelector('#imeiSearchInputCorporate').addEventListener('keydown', handleImeiSearch);

                const saveSale = (options) => {
                    const { cart, customerId, customerName, type, totalAmount, initialPayment, debt, loanTerm, monthlyPayment, cashType } = options;
                    
                    let stockItems = getStock();
                    const soldItems = [];
                    const newSaleId = Date.now();
                    
                    cart.forEach(cartItem => {
                        const itemInStock = stockItems.find(s => s.id === cartItem.stockId);
                        if (itemInStock) {
                            itemInStock.isSold = true;
                            itemInStock.salePrice = cartItem.salePrice;
                            itemInStock.saleId = newSaleId; 
                            soldItems.push({ 
                                stockId: itemInStock.id, 
                                productId: itemInStock.productId,
                                name: cartItem.name,
                                salePrice: cartItem.salePrice,
                                imei1: itemInStock.imei1,
                                imei2: itemInStock.imei2
                            });
                        }
                    });

                    if (debt > 0.01 && customerId !== 0) {
                        let customer = DATA.customers.find(c => c.id === customerId);
                        if (customer) {
                            customer.debt = parseFloat((customer.debt + debt).toFixed(2));
                        }
                    }
                    
                    const newSale = {
                        id: newSaleId, customerId, customerName, type, totalAmount, initialPayment,
                        items: soldItems,
                        date: new Date().toLocaleString('az-AZ'),
                        loanTerm: loanTerm || null,
                        monthlyPayment: monthlyPayment || null,
                        payments: []
                    };
                    
                    if (initialPayment > 0.01) {
                        const finalCashType = type === 'Açıq Qaimə' ? 'İlkin Ödəniş' : cashType;
                        const transaction = addTransaction(`Satış İlkin Ödəniş (${type})`, `Satış #${newSale.id} - ${customerName} ilk ödənişi`, initialPayment, cashType, { customerId: newSale.customerId, saleId: newSale.id });

                        newSale.payments.push({
                            date: new Date().toLocaleString('az-AZ'),
                            amount: initialPayment,
                            type: finalCashType,
                            transactionId: transaction.id
                        });
                    } else if (type !== 'Açıq Qaimə' && type !== 'Kredit') {
                        // Tam ödənilmiş Nağd/POS Satış üçün Tranzaksiya
                        addTransaction(`Tam Satış Ödənişi (${type})`, `Satış #${newSale.id} - ${customerName} tam ödənişi`, totalAmount, cashType, { customerId: newSale.customerId, saleId: newSale.id });
                    }

                    DATA.sales.push(newSale);
                    saveToStorage();
                };


                forms.cash.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const cart = carts.cash;
                    const view = forms.cash;
                    const customerId = parseInt(view.querySelector('.sale-customer').value);
                    const paymentType = view.querySelector('.payment-type').value;
                    const cashType = view.querySelector('.cash-type').value;
                    if (cart.length === 0 || isNaN(customerId) || (customerId === 0 && paymentType !== 'Nağd' && paymentType !== 'POS Terminal')) {
                        alert('Müştəri seçin və səbətə məhsul əlavə edin!');
                        return;
                    }
                    
                    const totalAmount = calculateTotal(cart, view);
                    if(totalAmount <= 0) {
                        alert('Satış məbləği 0-dan böyük olmalıdır!');
                        return;
                    }
                    
                    const isDebt = paymentType === 'Açıq Qaimə';
                    const initialPayment = isDebt ? 0 : totalAmount;
                    const debt = totalAmount - initialPayment;

                    if (isDebt && customerId === 0) {
                        alert('Açıq Qaimə satışı üçün "Nağd Alıcı" seçilə bilməz!');
                        return;
                    }
                    
                    const customer = getCustomers().find(c => c.id === customerId);
                    const customerName = customerId === 0 ? "Nağd Alıcı" : (customer ? customer.name : "Silinmiş Müştəri");

                    saveSale({ cart, customerId, customerName, type: paymentType, totalAmount, initialPayment, debt, cashType });
                    alert('Satış uğurla tamamlandı!');
                    
                    carts.cash = [];
                    view.reset();
                    view.querySelector('.sale-customer').value = '0';
                    view.querySelector('#cash-sale-cash-type-group').style.display = 'block';
                    renderCart(carts.cash, view);
                    populateDropdowns(view);
                });

                forms.credit.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const cart = carts.credit;
                    const view = forms.credit;
                    const customerId = parseInt(view.querySelector('.sale-customer').value);
                    if (cart.length === 0 || !customerId) {
                        alert('Müştəri seçin və səbətə məhsul əlavə edin!');
                        return;
                    }

                    const totalAmount = calculateTotal(cart, view);
                    if(totalAmount <= 0) {
                        alert('Satış məbləği 0-dan böyük olmalıdır!');
                        return;
                    }
                    const initialPayment = parseFloat(view.querySelector('.initial-payment').value) || 0;
                    const loanTerm = parseInt(view.querySelector('.loan-term').value);
                    const cashType = view.querySelector('.cash-type').value;
                    const debt = totalAmount - initialPayment;

                    if (initialPayment > totalAmount) {
                        alert('İlkin ödəniş ümumi məbləğdən böyük ola bilməz!');
                        return;
                    }

                    const monthlyPayment = debt / loanTerm;
                    const customer = getCustomers().find(c => c.id === customerId);
                    const customerName = customer ? customer.name : "Silinmiş Müştəri";

                    saveSale({ cart, customerId, customerName, type: "Kredit", totalAmount, initialPayment, debt, loanTerm, monthlyPayment, cashType });
                    alert('Kredit satışı uğurla rəsmiləşdirildi!');
                    
                    carts.credit = [];
                    view.reset();
                    view.querySelector('.initial-payment').value = '0';
                    renderCart(carts.credit, view);
                    populateDropdowns(view);
                    generatePaymentSchedule();
                });

                forms.corporate.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const cart = carts.corporate;
                    const view = forms.corporate;
                    const customerId = parseInt(view.querySelector('.sale-customer').value);
                    if (cart.length === 0 || !customerId) {
                        alert('Müştəri seçin və səbətə məhsul əlavə edin!');
                        return;
                    }

                    const totalAmount = calculateTotal(cart, view);
                    if(totalAmount <= 0) {
                        alert('Satış məbləği 0-dan böyük olmalıdır!');
                        return;
                    }
                    const initialPayment = parseFloat(view.querySelector('.initial-payment').value) || 0;
                    const cashType = view.querySelector('.cash-type').value;
                    const debt = totalAmount - initialPayment;
                    
                    if (initialPayment > totalAmount) {
                        alert('İlkin ödəniş ümumi məbləğdən çox ola bilməz!');
                        return;
                    }

                    const customer = getCustomers().find(c => c.id === customerId);
                    const customerName = customer ? customer.name : "Silinmiş Müştəri";

                    saveSale({ cart, customerId, customerName, type: "Korporativ", totalAmount, initialPayment, debt, cashType });
                    alert('Korporativ satış uğurla tamamlandı!');
                    
                    carts.corporate = [];
                    view.reset();
                    view.querySelector('.initial-payment').value = '0';
                    renderCart(carts.corporate, view);
                    populateDropdowns(view);
                });
                
                populateDropdowns(forms.cash);
            }

            function setupPurchasesPage() {
                const purchaseForm = appContainer.querySelector('#purchaseForm');
                const purchaseSupplierSelect = appContainer.querySelector('#purchaseSupplierSelect');
                const purchaseProductSelect = appContainer.querySelector('#purchaseProductSelect');
                const addPurchaseItemBtn = appContainer.querySelector('#addPurchaseItemBtn');
                const purchaseItemsContainer = appContainer.querySelector('#purchase-items-container');
                const purchaseTotalEl = appContainer.querySelector('#purchaseTotal');
                let currentPurchaseItems = [];
                
                const initializePurchasePage = () => {
                    const suppliers = getSuppliers();
                    purchaseSupplierSelect.innerHTML = '<option value="">-- Təchizatçı Seçin --</option>' + suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    
                    const products = getProducts();
                    purchaseProductSelect.innerHTML = '<option value="">-- Məhsul Seçin --</option>' + products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    
                    currentPurchaseItems = [];
                    renderPurchaseItems();
                    purchaseForm.reset();
                };
                
                const calculatePurchaseTotal = () => {
                    const total = currentPurchaseItems.reduce((sum, item) => sum + (parseFloat(item.purchasePrice) || 0), 0);
                    purchaseTotalEl.textContent = `${total.toFixed(2)} ₼`;
                    return total;
                };

                const renderPurchaseItems = () => {
                    const fragment = document.createDocumentFragment();

                    currentPurchaseItems.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = 'item-card';
                        div.style = 'border: 1px solid var(--border-color); padding: 1rem; border-radius: 0.75rem; margin-top: 1rem;';
                        div.innerHTML = `
                            <h4>${item.productName} #${index + 1}</h4>
                            <div class="form-group">
                                <label>Alış Qiyməti (₼)</label>
                                <input type="number" class="purchase-price-input" data-index="${index}" value="${item.purchasePrice || ''}" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>IMEI 1</label>
                                <input type="text" class="purchase-imei1-input" data-index="${index}" value="${item.imei1 || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>IMEI 2</label>
                                <input type="text" class="purchase-imei2-input" data-index="${index}" value="${item.imei2 || ''}">
                            </div>
                            <button type="button" class="btn btn-danger remove-purchase-item-btn" data-index="${index}" style="margin-top: 1rem;">Sil</button>
                        `;
                        fragment.appendChild(div);
                    });
                    purchaseItemsContainer.innerHTML = '';
                    purchaseItemsContainer.appendChild(fragment);

                    calculatePurchaseTotal();
                };

                addPurchaseItemBtn.addEventListener('click', () => {
                    const productId = parseInt(purchaseProductSelect.value);
                    if (!productId) {
                        alert('Zəhmət olmasa, məhsul seçin!');
                        return;
                    }
                    const product = getProducts().find(p => p.id === productId);
                    if (!product) return;

                    currentPurchaseItems.push({
                        productId: product.id,
                        productName: product.name,
                        purchasePrice: null,
                        imei1: '',
                        imei2: ''
                    });
                    renderPurchaseItems();
                });

                purchaseItemsContainer.addEventListener('input', (e) => {
                    const input = e.target;
                    const index = parseInt(input.dataset.index);
                    if (input.classList.contains('purchase-price-input')) {
                        currentPurchaseItems[index].purchasePrice = parseFloat(input.value) || null;
                    } else if (input.classList.contains('purchase-imei1-input')) {
                        currentPurchaseItems[index].imei1 = input.value.trim().toUpperCase();
                    } else if (input.classList.contains('purchase-imei2-input')) {
                        currentPurchaseItems[index].imei2 = input.value.trim().toUpperCase();
                    }
                    calculatePurchaseTotal();
                });

                purchaseItemsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('.remove-purchase-item-btn');
                    if (btn) {
                        const index = parseInt(btn.dataset.index);
                        currentPurchaseItems.splice(index, 1);
                        renderPurchaseItems();
                    }
                });

                purchaseForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const supplierId = parseInt(purchaseSupplierSelect.value);
                    if (!supplierId || currentPurchaseItems.length === 0) {
                        alert("Təchizatçı seçin və siyahıya məhsul əlavə edin!");
                        return;
                    }

                    const stock = getStock();
                    const imeiSet = new Set(stock.map(item => item.imei1).concat(stock.map(item => item.imei2)).filter(Boolean).map(imei => imei.trim().toUpperCase()));
                    
                    for (const item of currentPurchaseItems) {
                        if (!item.imei1) {
                            alert(`Məhsulun IMEI 1 kodu boş ola bilməz!`);
                            return;
                        }
                        const upperImei1 = item.imei1.trim().toUpperCase();
                        if (imeiSet.has(upperImei1)) {
                            alert(`Dublikat IMEI 1 kodu aşkarlandı: ${item.imei1}`);
                            return;
                        }
                        if (item.imei2) {
                            const upperImei2 = item.imei2.trim().toUpperCase();
                            if (imeiSet.has(upperImei2)) {
                                alert(`Dublikat IMEI 2 kodu aşkarlandı: ${item.imei2}`);
                                return;
                            }
                            if(upperImei1 === upperImei2) {
                                alert(`IMEI 1 və IMEI 2 kodları eyni ola bilməz: ${item.imei1}`);
                                return;
                            }
                        }
                        imeiSet.add(upperImei1);
                        if (item.imei2) imeiSet.add(item.imei2.trim().toUpperCase());
                    }

                    const totalAmount = calculatePurchaseTotal();
                    let supplier = getSuppliers().find(s => s.id === supplierId);
                    if (!supplier) return;
                    
                    const newPurchaseId = Date.now();
                    const products = getProducts();

                    currentPurchaseItems.forEach(item => {
                        const product = products.find(p => p.id === item.productId);
                        const newStockItem = {
                            id: Date.now() + Math.random(),
                            productId: item.productId,
                            productName: product.name,
                            supplierId: supplier.id,
                            purchaseId: newPurchaseId,
                            purchaseDate: new Date().toLocaleString('az-AZ'),
                            purchasePrice: item.purchasePrice,
                            salePrice: 0, 
                            imei1: item.imei1.trim().toUpperCase(),
                            imei2: item.imei2.trim().toUpperCase(),
                            isSold: false,
                            saleId: null
                        };
                        DATA.stock.push(newStockItem);
                    });
                    
                    supplier.balance = parseFloat(((supplier.balance || 0) + totalAmount).toFixed(2));
                    
                    const newPurchase = {
                        id: newPurchaseId,
                        supplierId,
                        supplierName: supplier.name,
                        items: currentPurchaseItems.map(item => ({...item, price: item.purchasePrice, imei1: item.imei1.trim().toUpperCase(), imei2: item.imei2.trim().toUpperCase()})),
                        totalAmount,
                        date: new Date().toLocaleString('az-AZ')
                    };
                    DATA.purchases.push(newPurchase);
                    saveToStorage();
                    alert('Alış uğurla tamamlandı!');
                    initializePurchasePage();
                });
                initializePurchasePage();
            }

            function setupReportsPage() {
                const reportTabs = appContainer.querySelector('#report-tabs');
                const salesReportView = appContainer.querySelector('#sales-report-view');
                const purchasesReportView = appContainer.querySelector('#purchases-report-view');
                const financialReportView = appContainer.querySelector('#financial-report-view');
                
                const salesHistoryTableBody = appContainer.querySelector('#salesHistoryTableBody');
                const purchasesHistoryTableBody = appContainer.querySelector('#purchasesHistoryTableBody');
                const financialHistoryTableBody = appContainer.querySelector('#financialHistoryTableBody');
                
                const salesReportSearch = appContainer.querySelector('#salesReportSearch');
                const purchasesReportSearch = appContainer.querySelector('#purchasesReportSearch');
                const financialReportSearch = appContainer.querySelector('#financialReportSearch');
                
                const reportStartDate = appContainer.querySelector('#reportStartDate');
                const reportEndDate = appContainer.querySelector('#reportEndDate');
                
                let activeReport = 'sales';

                const renderAllReports = () => {
                    const startDate = reportStartDate.value;
                    const endDate = reportEndDate.value;
                    
                    if (activeReport === 'sales') renderAllSales(startDate, endDate);
                    else if (activeReport === 'purchases') renderPurchases(startDate, endDate);
                    else if (activeReport === 'financial') renderFinancial(startDate, endDate);
                };

                const renderAllSales = (startDate, endDate) => {
                    const query = salesReportSearch.value.toLowerCase();
                    let sales = getSales().filter(s => isDateInRange(s.date, startDate, endDate)).reverse();
                    
                    if (query) {
                        sales = sales.filter(s => s.customerName.toLowerCase().includes(query) || s.totalAmount.toFixed(2).includes(query) || s.id.toString().includes(query));
                    }
                    
                    const fragment = document.createDocumentFragment();
                    let totalSales = 0;

                    if (sales.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="7" style="text-align:center;">Satış tapılmadı.</td>';
                        fragment.appendChild(tr);
                    } else {
                        sales.forEach((sale, index) => {
                            totalSales += sale.totalAmount;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${index + 1}</td><td>${sale.id}</td><td>${sale.date.split(',')[0]}</td><td>${sale.customerName}</td><td><span style="background:${['Kredit', 'Korporativ', 'Açıq Qaimə'].includes(sale.type) ? 'var(--warning-color)' : 'var(--success-color)'}; color:white; padding: 4px 10px; border-radius:6px; font-size:12px;">${sale.type}</span></td><td>${sale.totalAmount.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-details" data-id="${sale.id}" data-type="sale">Detallar</button> <button class="btn-delete delete-sale-btn" data-id="${sale.id}">🗑️</button></td></tr>`;
                            fragment.appendChild(tr);
                        });
                    }
                    salesHistoryTableBody.innerHTML = '';
                    salesHistoryTableBody.appendChild(fragment);

                    const tfoot = salesHistoryTableBody.nextElementSibling;
                    tfoot.innerHTML = `<tr><td colspan="5" style="text-align:right;">CƏMİ:</td><td>${totalSales.toFixed(2)} ₼</td><td></td></tr>`;
                };

                const renderPurchases = (startDate, endDate) => {
                    const query = purchasesReportSearch.value.toLowerCase();
                    let purchases = getPurchases().filter(p => isDateInRange(p.date, startDate, endDate)).reverse();
                    
                    if (query) {
                        purchases = purchases.filter(p => p.supplierName.toLowerCase().includes(query) || p.totalAmount.toFixed(2).includes(query) || p.id.toString().includes(query));
                    }
                    
                    const fragment = document.createDocumentFragment();
                    let totalPurchases = 0;

                    if (purchases.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<tr><td colspan="6" style="text-align:center;">Alış tapılmadı.</td></tr>';
                        fragment.appendChild(tr);
                    } else {
                        purchases.forEach((purchase, index) => {
                            totalPurchases += purchase.totalAmount;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${index + 1}</td><td>${purchase.id}</td><td>${purchase.date.split(',')[0]}</td><td>${purchase.supplierName}</td><td>${purchase.totalAmount.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-details" data-id="${purchase.id}" data-type="purchase">Detallar</button> <button class="btn-delete delete-purchase-btn" data-id="${purchase.id}">🗑️</button></td></tr>`;
                            fragment.appendChild(tr);
                        });
                    }
                    purchasesHistoryTableBody.innerHTML = '';
                    purchasesHistoryTableBody.appendChild(fragment);

                    const tfoot = purchasesHistoryTableBody.nextElementSibling;
                    tfoot.innerHTML = `<tr><td colspan="4" style="text-align:right;">CƏMİ:</td><td>${totalPurchases.toFixed(2)} ₼</td><td></td></tr>`;
                };

                const renderFinancial = (startDate, endDate) => {
                    const query = financialReportSearch.value.toLowerCase();
                    let transactions = getTransactions().filter(t => isDateInRange(t.date, startDate, endDate)).reverse();
                    
                    if (query) {
                        transactions = transactions.filter(t => t.description.toLowerCase().includes(query) || t.type.toLowerCase().includes(query) || t.id.toString().includes(query));
                    }
                    
                    const fragment = document.createDocumentFragment();
                    let totalAmount = 0;

                    if (transactions.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="8" style="text-align:center;">Əməliyyat tapılmadı.</td>';
                        fragment.appendChild(tr);
                    } else {
                        transactions.forEach((tr, index) => {
                            totalAmount += tr.amount;
                            const trEl = document.createElement('tr');
                            trEl.innerHTML = `<td>${index + 1}</td><td>${tr.id}</td><td>${tr.date.split(',')[0]}</td><td>${tr.details.cashType}</td><td>${tr.type}</td><td>${tr.description}</td><td class="${tr.amount >= 0 ? 'positive' : 'negative'}">${tr.amount.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-delete finance-delete-btn" data-id="${tr.id}">🗑️</button></td></tr>`;
                            fragment.appendChild(trEl);
                        });
                    }
                    financialHistoryTableBody.innerHTML = '';
                    financialHistoryTableBody.appendChild(fragment);

                    const tfoot = financialHistoryTableBody.nextElementSibling;
                    tfoot.innerHTML = `<tr><td colspan="6" style="text-align:right;">YEKUN BALANS:</td><td class="${totalAmount >= 0 ? 'positive' : 'negative'}">${totalAmount.toFixed(2)} ₼</td><td></td></tr>`;
                };

                reportTabs.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    reportTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    activeReport = button.dataset.report;
                    
                    salesReportView.style.display = 'none';
                    purchasesReportView.style.display = 'none';
                    financialReportView.style.display = 'none';

                    if (activeReport === 'sales') { salesReportView.style.display = 'block'; renderAllSales(reportStartDate.value, reportEndDate.value); } 
                    else if (activeReport === 'purchases') { purchasesReportView.style.display = 'block'; renderPurchases(reportStartDate.value, reportEndDate.value); }
                    else if (activeReport === 'financial') { financialReportView.style.display = 'block'; renderFinancial(reportStartDate.value, reportEndDate.value); }
                });

                reportStartDate.addEventListener('change', renderAllReports);
                reportEndDate.addEventListener('change', renderAllReports);
                
                appContainer.querySelector('#salesReportSearch').addEventListener('input', renderAllReports);
                appContainer.querySelector('#purchasesReportSearch').addEventListener('input', renderAllReports);
                appContainer.querySelector('#financialReportSearch').addEventListener('input', renderAllReports);
                
                appContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    if (btn.classList.contains('delete-sale-btn')) {
                        const id = parseInt(btn.dataset.id);
                        deleteSale(id);
                    }
                    if (btn.classList.contains('delete-purchase-btn')) {
                        const id = parseInt(btn.dataset.id);
                        deletePurchase(id);
                    }
                    if (btn.classList.contains('finance-delete-btn')) {
                        const id = parseInt(btn.dataset.id);
                        deleteTransaction(id);
                    }
                });
                renderAllSales(reportStartDate.value, reportEndDate.value);
            }

            function setupFinancePage() {
                const currentCashBalanceEl = appContainer.querySelector('#current-cash-balance');
                const cashBalanceNaqdEl = appContainer.querySelector('#cash-balance-naqd');
                const cashBalancePosEl = appContainer.querySelector('#cash-balance-pos');
                const totalReceivablesEl = appContainer.querySelector('#total-receivables');
                const totalPayablesEl = appContainer.querySelector('#total-payables');
                const transactionsTableBody = appContainer.querySelector('#transactionsTableBody');
                const tfoot = transactionsTableBody.nextElementSibling;
                const btnIncome = appContainer.querySelector('#btnIncome');
                const btnExpense = appContainer.querySelector('#btnExpense');
                const adminActions = appContainer.querySelector('#admin-actions');
                
                const isAdmin = localStorage.getItem('isAdmin') === 'true';
                adminActions.style.display = isAdmin ? 'flex' : 'none';

                const renderFinancePage = () => {
                    const transactions = getTransactions();
                    const customers = getCustomers();
                    const suppliers = getSuppliers();
                    
                    const cashBalanceNaqd = DATA.cashBalance.naqd || 0;
                    const cashBalancePos = DATA.cashBalance.pos || 0;
                    const totalCashBalance = cashBalanceNaqd + cashBalancePos;
                    
                    cashBalanceNaqdEl.textContent = `${cashBalanceNaqd.toFixed(2)} ₼`;
                    cashBalanceNaqdEl.classList.toggle('negative', cashBalanceNaqd < 0);
                    
                    cashBalancePosEl.textContent = `${cashBalancePos.toFixed(2)} ₼`;
                    cashBalancePosEl.classList.toggle('negative', cashBalancePos < 0);
                    
                    currentCashBalanceEl.textContent = `${totalCashBalance.toFixed(2)} ₼`;
                    currentCashBalanceEl.classList.toggle('negative', totalCashBalance < 0);
                    
                    const totalReceivables = customers.reduce((sum, cust) => sum + (cust.debt || 0), 0);
                    totalReceivablesEl.textContent = `${totalReceivables.toFixed(2)} ₼`;
                    
                    const totalPayables = suppliers.reduce((sum, sup) => sum + (sup.balance || 0), 0);
                    totalPayablesEl.textContent = `${totalPayables.toFixed(2)} ₼`;
                    totalPayablesEl.classList.toggle('negative', totalPayables > 0.01);
                    
                    const fragment = document.createDocumentFragment();
                    transactions.slice().reverse().forEach((tr, index) => {
                        const trEl = document.createElement('tr');
                        trEl.innerHTML = `<td>${index + 1}</td><td>${tr.date.split(',')[0]}</td><td>${tr.details.cashType}</td><td>${tr.type}</td><td>${tr.description}</td><td class="${tr.amount >= 0 ? 'positive' : 'negative'}">${tr.amount.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-delete finance-delete-btn" data-id="${tr.id}">🗑️</button></td></tr>`;
                        fragment.appendChild(trEl);
                    });
                    transactionsTableBody.innerHTML = '';
                    transactionsTableBody.appendChild(fragment);

                    tfoot.innerHTML = `<tr><td colspan="5" style="text-align:right;">YEKUN BALANS:</td><td class="${totalCashBalance >= 0 ? 'positive' : 'negative'}">${totalCashBalance.toFixed(2)} ₼</td><td></td></tr>`;
                };

                if(isAdmin) {
                    appContainer.querySelector('#btnBackupData').addEventListener('click', () => {
                        const backupData = { ...DATA };
                        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `biznes-panel-backup-${new Date().toISOString().slice(0, 10)}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    });
                    appContainer.querySelector('#btnFixData').addEventListener('click', () => {
                        if (confirm('Diqqət! Bu əməliyyat bütün müştəri və təchizatçı borclarını yenidən hesablayacaq. Davam etmək istəyirsiniz?')) {
                            recalculateAllDebtsAndBalances();
                        }
                    });
                    appContainer.querySelector('#btnResetData').addEventListener('click', () => {
                        if (confirm('XƏBƏRDARLIQ: Bütün məlumatları (məhsullar, müştərilər, təchizatçılar, satışlar və s.) silmək istədiyinizə əminsiniz? Bu əməliyyat geri qaytarıla bilməz.')) {
                            localStorage.clear();
                            alert('Bütün məlumatlar silindi. Səhifə yenilənəcək.');
                            location.reload();
                        }
                    });
                }
                btnIncome.addEventListener('click', () => { openModal(incomeTypeModal); });
                btnExpense.addEventListener('click', () => { openModal(expenseTypeModal); });
                document.getElementById('btnAcceptPayment').addEventListener('click', () => {
                    closeModal(incomeTypeModal);
                    const cDebt = getCustomers().filter(c => c.debt > 0.01);
                    const select = document.getElementById('paymentCustomerSelect');
                    select.innerHTML = '<option value="">-- Müştəri Seçin --</option>';
                    cDebt.forEach(c => { select.innerHTML += `<option value="${c.id}">${c.name} (Borc: ${c.debt.toFixed(2)} ₼)</option>`; });
                    acceptPaymentForm.reset();
                    document.getElementById('paymentSaleSelect').innerHTML = '';
                    document.getElementById('payment-sale-group').style.display = 'none';
                    openModal(acceptPaymentModal);
                });
                document.getElementById('btnOtherIncome').addEventListener('click', () => { closeModal(incomeTypeModal); otherIncomeForm.reset(); openModal(otherIncomeModal); });
                document.getElementById('btnPaySupplier').addEventListener('click', () => {
                    closeModal(expenseTypeModal);
                    const sBal = getSuppliers().filter(s => (s.balance || 0) > 0.01);
                    const select = document.getElementById('paymentSupplierSelect');
                    select.innerHTML = '<option value="">-- Təchizatçı Seçin --</option>';
                    sBal.forEach(s => { select.innerHTML += `<option value="${s.id}">${s.name} (Borc: ${s.balance.toFixed(2)} ₼)</option>`; });
                    paySupplierForm.reset();
                    document.getElementById('paymentPurchaseSelect').innerHTML = '';
                    document.getElementById('payment-purchase-group').style.display = 'none';
                    openModal(paySupplierModal);
                });
                document.getElementById('btnOtherExpense').addEventListener('click', () => { closeModal(expenseTypeModal); addExpenseForm.reset(); openModal(addExpenseModal); });
                transactionsTableBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (btn && btn.classList.contains('finance-delete-btn')) {
                        const id = parseInt(btn.dataset.id);
                        deleteTransaction(id);
                    }
                });
                renderFinancePage();
            }

            function setupDebtsPage() {
                const debtTabs = appContainer.querySelector('#debt-tabs');
                const customerDebtsView = appContainer.querySelector('#customer-debts-view');
                const supplierDebtsView = appContainer.querySelector('#supplier-debts-view');
                const customerDebtTableBody = appContainer.querySelector('#customerDebtTableBody');
                const supplierDebtTableBody = appContainer.querySelector('#supplierDebtTableBody');
                const customerDebtSearch = appContainer.querySelector('#customerDebtSearch');
                const supplierDebtSearch = appContainer.querySelector('#supplierDebtSearch');
                const customerDebtTfoot = customerDebtTableBody.nextElementSibling;
                const supplierDebtTfoot = supplierDebtTableBody.nextElementSibling;
                
                let currentDebtType = 'customer-credit';
                
                const renderCustomerDebts = (filterType) => {
                    const sales = getSales();
                    let filteredSales = sales.filter(s => {
                        const debt = s.totalAmount - s.initialPayment;
                        let matchesFilter = debt > 0.001;
                        if (filterType === 'customer-credit') {
                            matchesFilter = matchesFilter && s.type === 'Kredit';
                        } else if (filterType === 'customer-corporate') {
                            matchesFilter = matchesFilter && s.type === 'Korporativ';
                        } else if (filterType === 'customer-invoice') {
                            matchesFilter = matchesFilter && s.type === 'Açıq Qaimə';
                        }
                        return matchesFilter;
                    }).reverse();
                    
                    const query = customerDebtSearch.value.toLowerCase();
                    if(query) {
                        filteredSales = filteredSales.filter(s => s.customerName.toLowerCase().includes(query) || s.id.toString().includes(query) || s.date.includes(query));
                    }
                    
                    const fragment = document.createDocumentFragment();
                    let totalAmount = 0, totalPaid = 0, totalDebt = 0;

                    if (filteredSales.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="9" style="text-align:center;">Borclu müştəri tapılmadı.</td>';
                        fragment.appendChild(tr);
                        customerDebtTfoot.innerHTML = '';
                    } else {
                        filteredSales.forEach((sale, index) => {
                            const debt = (sale.totalAmount - sale.initialPayment);
                            totalAmount += sale.totalAmount;
                            totalPaid += sale.initialPayment;
                            totalDebt += debt;

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${index + 1}</td><td>${sale.id}</td><td>${sale.date.split(',')[0]}</td><td>${sale.customerName}</td><td>${sale.totalAmount.toFixed(2)} ₼</td><td>${sale.initialPayment.toFixed(2)} ₼</td><td class="negative">${debt.toFixed(2)} ₼</td>
                                <td class="actions-cell">
                                    <button class="btn btn-details" data-id="${sale.id}" data-type="sale" title="Satış detalları">ℹ️</button>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn btn-success pay-customer-debt-btn" data-id="${sale.customerId}" data-saleid="${sale.id}" style="padding: 0.5rem 1rem;">Ödəniş et</button>
                                </td>
                            `;
                            fragment.appendChild(tr);
                        });
                        customerDebtTfoot.innerHTML = `<tr><td colspan="4" style="text-align:right;">CƏMİ:</td><td>${totalAmount.toFixed(2)} ₼</td><td>${totalPaid.toFixed(2)} ₼</td><td class="negative">${totalDebt.toFixed(2)} ₼</td><td colspan="2"></td></tr>`;
                    }
                    customerDebtTableBody.innerHTML = '';
                    customerDebtTableBody.appendChild(fragment);
                };

                const renderSupplierDebts = () => {
                    const purchases = getPurchases();
                    const suppliers = getSuppliers();
                    const transactions = getTransactions();

                    let consolidatedDebts = {};
                    purchases.forEach(p => {
                        const paidAmount = transactions.filter(t => t.type === 'Təchizatçıya Ödəniş' && t.details && t.details.purchaseId === p.id).reduce((sum, t) => sum + Math.abs(t.amount), 0);
                        const remainingDebt = p.totalAmount - paidAmount;

                        if(remainingDebt > 0.01) {
                            if (!consolidatedDebts[p.supplierId]) {
                                const supplier = suppliers.find(s => s.id === p.supplierId);
                                consolidatedDebts[p.supplierId] = {
                                    id: p.supplierId,
                                    supplierName: supplier.name,
                                    totalPurchases: 0,
                                    totalPaid: 0,
                                    totalDebt: 0
                                };
                            }
                            consolidatedDebts[p.supplierId].totalPurchases += p.totalAmount;
                            consolidatedDebts[p.supplierId].totalPaid += paidAmount;
                            consolidatedDebts[p.supplierId].totalDebt += remainingDebt;
                        }
                    });

                    const query = supplierDebtSearch.value.toLowerCase();
                    let filteredConsolidatedDebts = Object.values(consolidatedDebts)
                        .filter(s => s.supplierName.toLowerCase().includes(query) || s.totalDebt.toFixed(2).includes(query))
                        .sort((a,b) => b.totalDebt - a.totalDebt);
                    
                    const fragment = document.createDocumentFragment();
                    let totalAmount = 0;
                    let totalPaid = 0;
                    let totalDebt = 0;

                    if (filteredConsolidatedDebts.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="7" style="text-align:center;">Borclu təchizatçı tapılmadı.</td>';
                        fragment.appendChild(tr);
                        supplierDebtTfoot.innerHTML = '';
                    } else {
                        filteredConsolidatedDebts.forEach((debt, index) => {
                            totalAmount += debt.totalPurchases;
                            totalPaid += debt.totalPaid;
                            totalDebt += debt.totalDebt;

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${debt.supplierName}</td>
                                <td>${debt.totalPurchases.toFixed(2)} ₼</td>
                                <td>${debt.totalPaid.toFixed(2)} ₼</td>
                                <td class="negative">${debt.totalDebt.toFixed(2)} ₼</td>
                                <td class="actions-cell">
                                    <button class="btn btn-details supplier-debt-details-btn" data-id="${debt.id}" data-type="supplier-debt-details" title="Qaimə detalları">ℹ️</button>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn btn-warning pay-supplier-debt-btn" data-id="${debt.id}" style="color:white; background:var(--warning-color); padding: 0.5rem 1rem;">Ödəniş et</button>
                                </td>
                            `;
                            fragment.appendChild(tr);
                        });
                        supplierDebtTfoot.innerHTML = `<tr><td colspan="2" style="text-align:right;">CƏMİ:</td><td>${totalAmount.toFixed(2)} ₼</td><td>${totalPaid.toFixed(2)} ₼</td><td class="negative">${totalDebt.toFixed(2)} ₼</td><td colspan="2"></td></tr>`;
                    }
                    supplierDebtTableBody.innerHTML = '';
                    supplierDebtTableBody.appendChild(fragment);
                };

                debtTabs.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    debtTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentDebtType = button.dataset.debtType;
                    
                    customerDebtsView.style.display = 'none';
                    supplierDebtsView.style.display = 'none';

                    if (currentDebtType === 'supplier') {
                        supplierDebtsView.style.display = 'block';
                        renderSupplierDebts();
                    } else {
                        customerDebtsView.style.display = 'block';
                        renderCustomerDebts(currentDebtType);
                    }
                });

                appContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;

                    if (btn.classList.contains('pay-customer-debt-btn')) {
                           const customerId = parseInt(btn.dataset.id);
                           const saleId = parseInt(btn.dataset.saleid);
                           openPaymentModalForSale(saleId, customerId);
                    }
                    
                    if (btn.classList.contains('pay-supplier-debt-btn') && !btn.dataset.supplierid) { 
                        const supplierId = parseInt(btn.dataset.id);
                        const supplier = getSuppliers().find(s => s.id === supplierId);
                        if (!supplier) return;
                        
                        paySupplierForm.reset();
                        document.getElementById('paymentSupplierSelect').innerHTML = `<option value="${supplierId}">${supplier.name} (Borc: ${supplier.balance.toFixed(2)} ₼)</option>`;
                        document.getElementById('paymentSupplierSelect').value = supplierId;
                        
                        document.getElementById('paymentSupplierSelect').dispatchEvent(new Event('change'));
                        
                        const paymentInput = document.getElementById('supplierPaymentAmount');
                        paymentInput.value = supplier.balance.toFixed(2);
                        paymentInput.max = supplier.balance.toFixed(2);
                        
                        openModal(paySupplierModal);
                    }
                });
                
                supplierDebtDetailsModal.addEventListener('click', (e) => {
                    const btn = e.target.closest('button.pay-supplier-debt-btn');
                     if(btn) {
                        const purchaseId = parseInt(btn.dataset.id);
                        const supplierId = parseInt(btn.dataset.supplierid);
                        openSupplierPaymentModalForPurchase(purchaseId, supplierId);
                     }
                });

                customerDebtSearch.addEventListener('input', () => {
                    renderCustomerDebts(currentDebtType);
                });
                supplierDebtSearch.addEventListener('input', renderSupplierDebts);
                
                const debtView = appContainer.querySelector('.debt-view');
                debtView.addEventListener('click', (e) => {
                        const btn = e.target.closest('button.btn-details');
                        if (btn) {
                            const id = parseInt(btn.dataset.id);
                            const type = btn.dataset.type;
                            if (type === 'sale') {
                                showSaleDetails(id);
                            } else if (type === 'supplier-debt-details') {
                                showSupplierDebtDetails(id);
                            }
                        }
                });

                debtTabs.querySelector(`[data-debt-type="${currentDebtType}"]`).click();
            }

            appContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.classList.contains('btn-details') && btn.dataset.id && btn.dataset.type) {
                    const id = parseInt(btn.dataset.id);
                    const type = btn.dataset.type;
                    if (type === 'sale') {
                        showSaleDetails(id);
                    } else if (type === 'purchase') {
                        showPurchaseDetails(id);
                    }
                }
            });

            renderPage('home');
        });
    </script>
</body>
</html>
