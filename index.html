<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BAKFON — Satış & Anbar Sistemi (Tam + Təklif)</title>
<style>
  :root{
    --bg:#f3f6fb; --text:#0b1220; --card:#ffffff; --border:#e1e6f0; --muted:#51607a; --primary:#dc2626;
    --ring:#60a5fa; --shadow:0 8px 22px rgba(2,6,23,.06); --radius:14px; --table:#cbd5e1;
    --sidebar:#d2daea; --sidebar-dark:#c6d1e6; --sidebar-text:#0b1220; --topbar:#e6eefb;
    --danger:#ef4444; --success:#16a34a; --info:#0ea5e9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:16px;line-height:1.55}

  .app{display:grid;grid-template-rows:56px 1fr;height:100%}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--topbar);border-bottom:1px solid #0f172a14;box-shadow:var(--shadow)}
  .brand{font-weight:800}
  .top-actions{display:flex;gap:8px;align-items:center}

  .shell{display:grid;grid-template-columns:270px 1fr;height:100%}
  .sidebar{background:var(--sidebar);padding:14px 12px;border-right:1px solid #c5d0e4}
  .navgroup{margin-bottom:10px;font-size:12px;color:#334155;font-weight:800;opacity:.8}
  .navbtn{width:100%;text-align:left;padding:10px 12px;border-radius:12px;border:1px solid #c3cee4;background:#ffffffcc;cursor:pointer;font-weight:700;margin-bottom:8px;color:var(--sidebar-text)}
  .navbtn:hover{background:#fff}
  .navbtn.active{background:var(--sidebar-dark)}

  .content{padding:16px;overflow:auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;box-shadow:var(--shadow)}
  .row{display:grid;gap:14px}
  @media(min-width:720px){.row{grid-template-columns:repeat(12,1fr)}}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  label{font-size:13px;color:#334155;font-weight:600}
  input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #cfd5e1;background:#fff;outline:none;transition:box-shadow .12s,border-color .12s}
  input:focus,select:focus,textarea:focus,.btn:focus{box-shadow:0 0 0 3px rgba(96,165,250,.35);border-color:var(--ring)}
  .btn{border:1px solid #cbd5e1;background:#f1f5f9;color:#0f172a;padding:11px 16px;border-radius:12px;cursor:pointer;transition:.15s;box-shadow:var(--shadow);font-weight:700}
  .btn:hover{transform:translateY(-1px)}.btn:active{transform:translateY(0)}
  .btn.primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border-color:#0284c7;color:#fff}
  .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#15803d;color:#fff}
  .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#b91c1c;color:#fff}
  .btn.ghost{background:#fff}
  .muted{color:var(--muted);font-size:14px}
  .tag{display:inline-block;border:1px solid #cbd5e1;border-radius:999px;padding:3px 8px;font-size:12px;margin-right:6px}
  .notice{padding:12px;border-radius:12px;margin:8px 0}
  .notice.warn{background:#fff1f2;border:1px solid #fecaca;color:#991b1b}
  .notice.info{background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8}
  .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.12)}

  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  thead th{background:#f8fafc;padding:10px;font-weight:700;font-size:14px;border-bottom:1px solid var(--border);text-align:right}
  tbody td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:right}
  tbody tr:nth-child(odd){background:rgba(2,6,23,.02)}
  tfoot td{padding:10px;background:#f1f5f9;font-weight:700;border-top:1px solid var(--border);text-align:right}

  /* Print */
  .print-root{font-family:"Times New Roman",Times,serif;color:#111}
  .print-a4{width:210mm;min-height:297mm;margin:0 auto;padding:20mm 17mm 18mm}
  .print-title{font-size:18pt;font-weight:700;text-align:center;text-transform:uppercase}
  .print-subtop{display:flex;justify-content:space-between;margin:6mm 0 4mm;font-size:11pt}
  .print-table{width:100%;border-collapse:collapse;font-size:11pt}
  .print-table th,.print-table td{border:1px solid var(--table);padding:5px 7px}
  .sign-cols{display:flex;justify-content:space-between;gap:16mm;margin-top:12mm}
  .sigline{display:block;border-bottom:1px solid #111;height:18px;margin-top:18px}
  .page-break{page-break-after:always}
  @media print{ .sidebar,.topbar,.btn,.modal{display:none !important} .content{padding:0} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">BAKFON — Satış & Anbar</div>
    <div class="top-actions">
      <button id="btnOpenOffer" class="btn primary">Təklif</button>
      <div class="muted">Yerlı demo (localStorage)</div>
    </div>
  </div>

  <div class="shell">
    <aside class="sidebar" id="sidebar">
      <div class="navgroup">Naviqasiya</div>
      <button class="navbtn active" data-view="home">Ana Səhifə</button>
      <button class="navbtn" data-view="calc">Kalkulyator</button>
      <button class="navbtn" data-view="finalize">Rəsmiləşdir</button>
      <button class="navbtn" data-view="customers">Müştərilər</button>
      <button class="navbtn" data-view="offers">Təkliflər</button>
      <div class="navgroup">Əməliyyat</div>
      <button class="navbtn" data-view="inventory">Anbar</button>
      <button class="navbtn" data-view="purchases">Alışlar</button>
      <button class="navbtn" data-view="sales">Satışlar</button>
      <div class="navgroup">Hesabat & Kadr</div>
      <button class="navbtn" data-view="reports">Hesabatlar</button>
      <button class="navbtn" data-view="overdue">Gecikmələr</button>
      <button class="navbtn" data-view="employees">Əməkdaşlar</button>
      <button class="navbtn" data-view="users">İstifadəçilər</button>
      <button class="navbtn" data-view="payroll">Bonus & Əməkhaqqı</button>
    </aside>

    <main class="content">
      <!-- HOME -->
      <section id="view-home" class="card" style="min-height:140px"><h3>XOŞ GƏLMİSİNİZ</h3><p class="muted">Soldakı menyudan modul seçin. Yuxarı sağda <b>Təklif</b> düyməsi ilə yeni təklif yarada bilərsiniz.</p></section>

      <!-- KALKULYATOR -->
      <section id="view-calc" class="card" style="display:none">
        <h3>Kredit kalkulyatoru</h3>
        <div id="calcAlert" class="notice warn" style="display:none"></div>
        <div class="row">
          <div class="col-4"><label>Məhsul dəyəri (AZN)</label><input id="price" type="number" min="0" step="0.01" placeholder="0.00"/></div>
          <div class="col-3"><label>Müddət (ay)</label><select id="months"><option value="">— Seçin —</option><option>3</option><option>6</option><option>9</option><option>12</option><option>15</option><option>18</option></select></div>
          <div class="col-3"><label>Risk qrupu</label><select id="risk"><option value="">— Seçin —</option><option value="low">Aşağı risk (A)</option><option value="med">Orta risk (B)</option><option value="high">Yüksək risk (C)</option></select></div>
          <div class="col-3"><label>Aylıq əmək haqqı (AZN)</label><input id="salary" type="number" min="1" step="1"/></div>
          <div class="col-3"><label>Digər öhdəliklər (AZN)</label><input id="oblig" type="number" min="0" step="1" value="0"/></div>
          <div class="col-12" style="display:flex;gap:10px;flex-wrap:wrap"><button id="btnCalc" class="btn success">Hesabla</button><button id="btnCalcReset" class="btn danger">Sıfırla</button></div>
        </div>
        <div class="row">
          <div class="col-6 card"><h3>Xülasə</h3><div id="summary"></div></div>
          <div class="col-6 card"><h3>Ödəniş cədvəli</h3><div id="scheduleWrap" style="max-height:360px;overflow:auto"></div></div>
        </div>
      </section>

      <!-- RƏSMİLƏŞDİR -->
      <section id="view-finalize" class="card" style="display:none">
        <h3>Müştəri məlumatları</h3>
        <div id="finalizeAlert" class="notice warn" style="display:none"></div>
        <div class="row">
          <div class="col-4"><label>Müştəri A.S.A.</label><input id="custName" required></div>
          <div class="col-4"><label>Əlaqə nömrəsi</label><input id="custPhone" required></div>
          <div class="col-4"><label>Məhsul adı/model</label><input id="prodName" required></div>
          <div class="col-3"><label>Ş/V seriya və nömrəsi</label><input id="idSerial" required></div>
          <div class="col-3"><label>FIN kodu</label><input id="finCode" required></div>
          <div class="col-3"><label>Doğum tarixi</label><input id="birthDate" type="date" required></div>
          <div class="col-3"><label>Ünvan</label><input id="address" required></div>
          <div class="col-4"><label>IMEI 1</label><input id="imei1" required></div>
          <div class="col-4"><label>IMEI 2</label><input id="imei2"></div>
          <div class="col-4"><label>Müqavilə №</label><input id="contractNo" required></div>
          <div class="col-3"><label>Filial</label><input id="branch" value="Nəsimi" required></div>
          <div class="col-3"><label>Valyuta</label><select id="currency"><option>AZN</option></select></div>
          <div class="col-3"><label>Kreditin verilmə tarixi</label><input id="startDate" type="date" required></div>
          <div class="col-3"><label>Satıcı nümayəndə (yalnız Zəmanət)</label><select id="sellerRep"><option value="">— Seçin —</option><option>Vəliməmmədov Niyazi Səhhət oğlu</option><option>Abaszadə Mədət Yusif oğlu</option></select></div>
          <div class="col-3"><label>Satış növü</label><select id="saleType"><option value="">— Seçin —</option><option value="kredit">Kredit</option><option value="nagd">Nağd</option><option value="pos">POS</option><option value="korporativ">Korporativ</option></select></div>
          <div class="col-12" style="display:flex;gap:10px;flex-wrap:wrap"><button id="btnSaveCustomer" class="btn primary">Yadda saxla</button><button id="btnFinalizeReset" class="btn danger">Sıfırla</button></div>
        </div>
      </section>

      <!-- MÜŞTƏRİLƏR -->
      <section id="view-customers" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap"><h3 style="margin:0">Müştərilər</h3><button id="btnAddCustomer" class="btn success">Müştəri əlavə et</button></div>
        <div class="row card" style="margin:12px 0">
          <div class="col-4"><label>Ad üzrə axtar</label><input id="searchName"></div>
          <div class="col-4"><label>Mobil nömrə üzrə axtar</label><input id="searchPhone"></div>
          <div class="col-4"><label>FIN kod üzrə axtar</label><input id="searchFin"></div>
        </div>
        <div id="customersWrap"></div>
      </section>

      <!-- TƏKLİFLƏR -->
      <section id="view-offers" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 style="margin:0">Təkliflər</h3>
          <button class="btn primary" id="btnOfferNew">Yeni təklif</button>
        </div>
        <div id="offersWrap" class="card" style="margin-top:12px"></div>
      </section>

      <!-- ANBAR -->
      <section id="view-inventory" class="card" style="display:none">
        <h3>Anbar</h3>
        <div class="row">
          <div class="col-3"><label>SKU</label><input id="invSku"></div>
          <div class="col-3"><label>Ad</label><input id="invName"></div>
          <div class="col-3"><label>Satış qiyməti (AZN)</label><input id="invPrice" type="number" step="0.01"></div>
          <div class="col-3"><label>Maya (AZN)</label><input id="invCost" type="number" step="0.01"></div>
          <div class="col-3"><label>Miqdar</label><input id="invQty" type="number" step="1"></div>
          <div class="col-12"><button id="btnAddInv" class="btn primary">Məhsul əlavə/yenilə</button></div>
        </div>
        <div class="row card" style="margin:12px 0"><div class="col-4"><label>Axtarış</label><input id="invSearch" placeholder="SKU / Ad"></div></div>
        <div id="inventoryWrap"></div>
      </section>

      <!-- ALIŞLAR -->
      <section id="view-purchases" class="card" style="display:none">
        <h3>Alışlar</h3>
        <div class="row">
          <div class="col-3"><label>Tarix</label><input id="purDate" type="date"></div>
          <div class="col-3"><label>SKU</label><input id="purSku"></div>
          <div class="col-3"><label>Miqdar</label><input id="purQty" type="number"></div>
          <div class="col-3"><label>Maya (AZN)</label><input id="purCost" type="number" step="0.01"></div>
          <div class="col-12"><button id="btnAddPurchase" class="btn primary">Alış əlavə et</button></div>
        </div>
        <div id="purchaseWrap" class="card"></div>
      </section>

      <!-- SATIŞLAR -->
      <section id="view-sales" class="card" style="display:none">
        <h3>Satışlar</h3>
        <div class="row">
          <div class="col-3"><label>Tarix</label><input id="saleDate" type="date"></div>
          <div class="col-3"><label>Müştəri FIN</label><input id="saleFin" placeholder="FIN"></div>
          <div class="col-3"><label>SKU</label><input id="saleSku"></div>
          <div class="col-3"><label>Miqdar</label><input id="saleQty" type="number" value="1"></div>
          <div class="col-3"><label>Satış qiyməti (AZN)</label><input id="salePrice" type="number" step="0.01"></div>
          <div class="col-3"><label>İMEİ</label><input id="saleImei"></div>
          <div class="col-3"><label>Satış növü</label><select id="saleTypeSel"><option value="kredit">Kredit</option><option value="nagd">Nağd</option><option value="pos">POS</option><option value="korporativ">Korporativ</option></select></div>
          <div class="col-3"><label>Əməkdaş</label><input id="saleEmployee" placeholder="Satışçı adı"></div>
          <div class="col-12"><button id="btnAddSale" class="btn success">Satışı qeyd et</button></div>
        </div>
        <div id="salesWrap" class="card"></div>
      </section>

      <!-- HESABATLAR -->
      <section id="view-reports" class="card" style="display:none">
        <h3>Hesabatlar</h3>
        <div class="row">
          <div class="col-3"><label>Başlanğıc</label><input id="repFrom" type="date"></div>
          <div class="col-3"><label>Bitiş</label><input id="repTo" type="date"></div>
          <div class="col-3"><label>Əməkdaş</label><input id="repEmployee" placeholder="(opsional)"></div>
          <div class="col-3"><label>SKU</label><input id="repSku" placeholder="(opsional)"></div>
          <div class="col-12"><button id="btnRunReport" class="btn primary">Hesabatı hazırla</button></div>
        </div>
        <div id="reportWrap" class="card"></div>
      </section>

      <!-- GECİKMƏLƏR -->
      <section id="view-overdue" class="card" style="display:none">
        <h3>Gecikmələr</h3>
        <p class="muted">Ödəniş tarixindən ≥1 gün keçmiş və ödənməmiş taksitlər.</p>
        <div id="overdueWrap" class="card"></div>
      </section>

      <!-- ƏMƏKDAŞLAR -->
      <section id="view-employees" class="card" style="display:none">
        <h3>Əməkdaşlar</h3>
        <div class="row">
          <div class="col-3"><label>Ad Soyad</label><input id="empName"></div>
          <div class="col-3"><label>Baz maaş (AZN)</label><input id="empBase" type="number" step="0.01"></div>
          <div class="col-3"><label>Bonus % (mənfəətdən)</label><input id="empBonusPct" type="number" step="0.01" placeholder="məs: 10"></div>
          <div class="col-3"><label>Status</label><select id="empStatus"><option value="aktiv">Aktiv</option><option value="passiv">Passiv</option></select></div>
          <div class="col-12"><button id="btnAddEmp" class="btn primary">Əlavə / Yenilə</button></div>
        </div>
        <div id="empWrap" class="card"></div>
      </section>

      <!-- İSTİFADƏÇİLƏR -->
      <section id="view-users" class="card" style="display:none">
        <h3>İstifadəçilər</h3>
        <div class="row">
          <div class="col-3"><label>Login</label><input id="usrLogin"></div>
          <div class="col-3"><label>Ad Soyad</label><input id="usrName"></div>
          <div class="col-3"><label>Rol</label><select id="usrRole"><option>Admin</option><option>Kassir</option><option>Satış</option></select></div>
          <div class="col-3"><label>Status</label><select id="usrStatus"><option value="aktiv">Aktiv</option><option value="passiv">Passiv</option></select></div>
          <div class="col-12"><button id="btnAddUser" class="btn primary">Əlavə / Yenilə</button></div>
        </div>
        <div id="usersWrap" class="card"></div>
      </section>

      <!-- BONUS & ƏMƏKHAQQI -->
      <section id="view-payroll" class="card" style="display:none">
        <h3>Bonus & Əməkhaqqı (aylıq)</h3>
        <div class="row">
          <div class="col-3"><label>Başlanğıc</label><input id="payFrom" type="date"></div>
          <div class="col-3"><label>Bitiş</label><input id="payTo" type="date"></div>
          <div class="col-12"><button id="btnRunPayroll" class="btn primary">Hesabla</button></div>
        </div>
        <div id="payrollWrap" class="card"></div>
      </section>

    </main>
  </div>
</div>

<!-- MODAL: TƏKLİF FORMU -->
<div class="modal" id="offerModal" aria-hidden="true" style="display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.35);z-index:50">
  <div class="modal-card">
    <div class="modal-head">
      <h3 style="margin:0">Təklif formu</h3>
      <button class="x" id="offerClose">Bağla ✕</button>
    </div>
    <div class="row">
      <div class="col-6"><label>Təklif edən tərəf</label><input id="ofFrom" placeholder="Baktel Electronics MMC"></div>
      <div class="col-6"><label>Təklif olunan tərəf</label><input id="ofTo" placeholder="Müştəri / Şirkət adı"></div>
      <div class="col-3"><label>Tarix</label><input id="ofDate" type="date"></div>
      <div class="col-3"><label>Təklif №</label><input id="ofNo" placeholder="Auto"></div>
      <div class="col-6"><label>Qeydlər (opsional)</label><input id="ofNote" placeholder=""></div>
      <div class="col-6"><label>Direktor (çap üçün)</label><input id="ofDirector" placeholder="İlqar Mahmudov"></div>
      <div class="col-6"><label>Kimə (çap sətri)</label><input id="ofToLine" placeholder="Şirkət / şöbə / şəxs"></div>

      <div class="col-12 card" style="margin-top:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Məhsullar</strong>
          <div style="display:flex;gap:8px">
            <button class="btn" id="ofAddRow">Sətir əlavə et</button>
            <button class="btn danger" id="ofClearRows">Hamısını sil</button>
          </div>
        </div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:6%;text-align:center">#</th>
                <th style="text-align:left">Məhsul / Təsvir</th>
                <th>Say</th>
                <th>Qiymət (AZN)</th>
                <th>Cəm (AZN)</th>
                <th>Sil</th>
              </tr>
            </thead>
            <tbody id="ofBody"></tbody>
            <tfoot>
              <tr><td colspan="4" style="text-align:right">Cəmi</td><td id="ofSub" style="font-weight:800">0.00 ₼</td><td></td></tr>
              <tr><td colspan="4" style="text-align:right">ƏDV (18%)</td><td id="ofVat">0.00 ₼</td><td></td></tr>
              <tr><td colspan="4" style="text-align:right">Yekun məbləğ</td><td id="ofGrand" style="font-weight:900">0.00 ₼</td><td></td></tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="col-12" style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn success" id="ofSave">Yadda saxla</button>
        <button class="btn" id="ofSavePrint">Yadda saxla & Çap</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== UTIL ===== */
const $=id=>document.getElementById(id);
const nowISO=()=>{const t=new Date();const m=String(t.getMonth()+1).padStart(2,'0');const d=String(t.getDate()).padStart(2,'0');return `${t.getFullYear()}-${m}-${d}`};
const ddmmyyyy=d=>{const dt=(d instanceof Date)?d:new Date(d);const dd=String(dt.getDate()).padStart(2,'0');const mm=String(dt.getMonth()+1).padStart(2,'0');return `${dd}.${mm}.${dt.getFullYear()}`};
const fmtAZN=n=> new Intl.NumberFormat('az-AZ',{style:'currency',currency:'AZN',maximumFractionDigits:2}).format(Number(n)||0);
const COMPANY={name:"Baktel Electronics",address:"Bakı şəh., Nəsimi ray., Nizami küç., 119",contact:"Əlaqə: Call Center (*7010), Mobil: +994102017010"};
const K={CUST:'bakfon_customers_v3', PROD:'bakfon_products_v2', PUR:'bakfon_purchases_v2', SALE:'bakfon_sales_v3', EMP:'bakfon_employees_v2', USR:'bakfon_users_v2', OFFER:'bakfon_offers_v1'};
const getJSON=(k,def=[])=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(e){return def}};
const setJSON=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== NAV ===== */
function show(viewId){
  ['view-home','view-calc','view-finalize','view-customers','view-offers','view-inventory','view-purchases','view-sales','view-reports','view-overdue','view-employees','view-users','view-payroll'].forEach(id=>$(id).style.display=(id===viewId?'block':'none'));
  document.querySelectorAll('.navbtn').forEach(b=>{const t='view-'+b.dataset.view; b.classList.toggle('active',t===viewId)});
}
function goto(id){show(id)}
$('sidebar').addEventListener('click',e=>{const btn=e.target.closest('.navbtn'); if(!btn) return; goto('view-'+btn.dataset.view)});

/* ===== CALC ===== */
const MAX_DSR=0.40, POLICY={low:.20,med:.30,high:.50};
function calc(){
  ['price','months','risk','salary','oblig'].forEach(id=>$(id).classList.remove('invalid'));
  const price=Number($('price').value||0), months=Number($('months').value||0), risk=$('risk').value;
  const salary=Number($('salary').value||0), oblig=Number($('oblig').value||0);
  const errs=[]; if(!price){errs.push('Məhsul dəyərini daxil edin.');$('price').classList.add('invalid')}
  if(!months){errs.push('Müddəti seçin.');$('months').classList.add('invalid')}
  if(!risk){errs.push('Risk qrupunu seçin.');$('risk').classList.add('invalid')}
  if(!salary){errs.push('Aylıq əmək haqqını daxil edin.');$('salary').classList.add('invalid')}
  if($('oblig').value===''){errs.push('Digər öhdəlikləri daxil edin.');$('oblig').classList.add('invalid')}
  if(errs.length){const a=$('calcAlert');a.style.display='block';a.innerHTML='• '+errs.join('<br>• ');return}else{$('calcAlert').style.display='none'}
  const base=POLICY[risk]??POLICY.med; const net=Math.max(0,salary-oblig);
  let down=Math.max(50,price*base); if(down>price) down=price; let principal=price-down; let monthly=months?principal/months:0;
  const maxMonthly=net*MAX_DSR; if(monthly>maxMonthly){principal=maxMonthly*months;down=price-principal;monthly=principal/months}
  const rows=[];let bal=principal; const sd=$('startDate')?.value?new Date($('startDate').value):new Date(); const day=sd.getDate();
  for(let i=1;i<=months;i++){const d=new Date(sd); d.setMonth(d.getMonth()+i); d.setDate(day); bal=Math.max(0,bal-monthly); rows.push({i,date:d,monthly,bal})}
  $('summary').innerHTML=`<div>Məhsul: <b>${fmtAZN(price)}</b></div><div>İlkin: <b>${fmtAZN(down)}</b></div><div>Kredit: <b>${fmtAZN(principal)}</b></div><div>Aylıq: <b>${fmtAZN(monthly)}</b></div><div>Maks. aylıq (40%): <b>${fmtAZN(maxMonthly)}</b></div>`;
  $('scheduleWrap').innerHTML=`<table><thead><tr><th>#</th><th>Tarix</th><th>Aylıq</th><th>Qalıq</th></tr></thead><tbody>${rows.map(r=>`<tr><td>${r.i}</td><td>${ddmmyyyy(r.date)}</td><td>${fmtAZN(r.monthly)}</td><td>${fmtAZN(r.bal)}</td></tr>`).join('')}</tbody></table>`;
  window.__calcSnapshot={price,months,risk,salary,oblig,down,principal,monthly, schedule:rows};
}
function resetCalc(){['price','months','risk','salary','oblig'].forEach(id=>$(id).value='');$('summary').innerHTML='';$('scheduleWrap').innerHTML='';$('calcAlert').style.display='none';window.__calcSnapshot=null}

/* ===== CUSTOMERS ===== */
const ensureStartDate=()=>{const sd=$('startDate'); if(sd && !sd.value) sd.value=nowISO()};
function collectCustomer(requireCalc=true){
  const get=id=>($(id).value||'').trim();
  const must=['custName','custPhone','prodName','idSerial','finCode','birthDate','address','imei1','contractNo','branch','currency','startDate','sellerRep','saleType'];
  const errs=[]; must.forEach(id=>{if(!$(id).value){errs.push(id);$(id).classList.add('invalid')}else{$(id).classList.remove('invalid')}});
  if(errs.length){const a=$('finalizeAlert');a.style.display='block';a.innerHTML='• Bütün mütləq xanaları doldurun.';return null}else{$('finalizeAlert').style.display='none'}
  const calc=window.__calcSnapshot||null; if(requireCalc && !calc){const a=$('finalizeAlert');a.style.display='block';a.innerHTML='• Əvvəlcə Kalkulyatorda hesablayın.';return null}
  return {custName:get('custName'),custPhone:get('custPhone'),prodName:get('prodName'),idSerial:get('idSerial'),finCode:get('finCode'),birthDate:get('birthDate'),address:get('address'),imei1:get('imei1'),imei2:get('imei2'),contractNo:get('contractNo'),branch:get('branch')||'Nəsimi',currency:get('currency')||'AZN',startDate:get('startDate')||nowISO(),sellerRep:get('sellerRep'),saleType:get('saleType'),createdAt:new Date().toISOString(),calc};
}
const loadCustomers=()=>getJSON(K.CUST,[]); const saveCustomers=v=>setJSON(K.CUST,v);
function upsertCustomer(c){const list=loadCustomers(); const ix=list.findIndex(x=>x.finCode===c.finCode); if(ix>=0){const prev=list[ix].sales||[]; list[ix]={...c, sales:prev};}else list.push({...c, sales:[]}); saveCustomers(list)}
function saveCustomerOnly(){const c=collectCustomer(true); if(!c) return; upsertCustomer(c); alert('Müştəri yadda saxlandı'); resetFinalize(); renderCustomers(); goto('view-customers')}
function resetFinalize(){['custName','custPhone','prodName','idSerial','finCode','birthDate','address','imei1','imei2','contractNo','currency','sellerRep','saleType'].forEach(id=>$(id).value=''); $('branch').value='Nəsimi'; ensureStartDate(); $('finalizeAlert').style.display='none'}
function fillFinalize(c){const set=(id,v)=>{if($(id)) $(id).value=v||''}; set('custName',c.custName);set('custPhone',c.custPhone);set('prodName',c.prodName);set('idSerial',c.idSerial);set('finCode',c.finCode);set('birthDate',c.birthDate);set('address',c.address);set('imei1',c.imei1);set('imei2',c.imei2);set('contractNo',c.contractNo);set('branch',c.branch);set('currency',c.currency);set('startDate',c.startDate);set('sellerRep',c.sellerRep);set('saleType',c.saleType); window.__calcSnapshot=c.calc||null}
function renderCustomers(){
  const wrap=$('customersWrap'); const list=loadCustomers();
  const qn=($('searchName').value||'').toLowerCase(), qp=($('searchPhone').value||'').toLowerCase(), qf=($('searchFin').value||'').toLowerCase();
  const view=list.filter(x=>{const okN=!qn||(x.custName||'').toLowerCase().includes(qn); const okP=!qp||(x.custPhone||'').toLowerCase().includes(qp); const okF=!qf||(x.finCode||'').toLowerCase().includes(qf); return okN&&okP&&okF});
  if(!view.length){wrap.innerHTML='<div class="card">Heç bir müştəri tapılmadı.</div>';return}
  wrap.innerHTML=view.map(c=>`<div class="card" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center"><div><div style="font-weight:700">${c.custName}</div><div class="muted">FIN: ${c.finCode} • ${c.custPhone} • ${c.prodName} • Satış növü: ${(c.saleType||'').toUpperCase()}</div></div><div style="display:flex;gap:8px"><button class="btn" data-act="info" data-fin="${c.finCode}">ℹ️ Info</button><button class="btn primary" data-act="reprint" data-fin="${c.finCode}">Yenidən Çap</button><button class="btn success" data-act="resell" data-fin="${c.finCode}">Satış et</button><button class="btn" data-act="edit" data-fin="${c.finCode}">Düzəliş</button><button class="btn danger" data-act="del" data-fin="${c.finCode}">Sil</button></div></div></div>`).join('');
  wrap.querySelectorAll('button[data-act]').forEach(b=>{b.addEventListener('click',()=>{const fin=b.dataset.fin, act=b.dataset.act; const list=loadCustomers(); const c=list.find(x=>x.finCode===fin); if(!c) return; if(act==='info') showCustomerInfo(c); if(act==='reprint'){ const html=buildDocs(c); openPrint(html); } if(act==='edit'){ goto('view-finalize'); fillFinalize(c);} if(act==='del'){ if(confirm('Müştəri silinsin?')){ saveCustomers(list.filter(x=>x.finCode!==fin)); renderCustomers(); } } if(act==='resell'){ goto('view-sales'); $('saleFin').value=c.finCode; $('saleDate').value=nowISO(); alert(`Yeni satış: ${c.custName}`);} });});
}
function showCustomerInfo(c){
  const sales=c.sales||[]; const lines = sales.length? sales.map((s,i)=>`#${i+1} — ${ddmmyyyy(s.date||c.startDate)} • ${s.sku||'-'} • ${fmtAZN(s.price||0)} • IMEI: ${s.imei||c.imei1||'-'}`).join('\n') : 'Satış yoxdur.';
  alert(`Müştəri: ${c.custName}\nFIN: ${c.finCode}\nMobil: ${c.custPhone}\n\nSATIŞLAR:\n${lines}`);
}

/* ===== INVENTORY / PURCHASES / SALES / REPORTS / OVERDUE / EMP / USERS / PAYROLL ===== */
const loadProducts=()=>getJSON(K.PROD,[]), saveProducts=v=>setJSON(K.PROD,v);
function addOrUpdateProduct(){const sku=$('invSku').value.trim(), name=$('invName').value.trim(), price=Number($('invPrice').value||0), cost=Number($('invCost').value||0), qty=Number($('invQty').value||0); if(!sku||!name){alert('SKU və Ad tələb olunur.');return;} const list=loadProducts(); const ix=list.findIndex(p=>p.sku===sku); if(ix>=0){ list[ix]={...list[ix], name, price, cost, qty:(Number(list[ix].qty)||0)+qty}; } else list.push({sku,name,price,cost,qty}); saveProducts(list); renderInventory(); ['invSku','invName','invPrice','invCost','invQty'].forEach(id=>$(id).value=''); }
function renderInventory(){const wrap=$('inventoryWrap'); const q=($('invSearch').value||'').toLowerCase(); const list=loadProducts().filter(p=>!q||p.sku.toLowerCase().includes(q)||(p.name||'').toLowerCase().includes(q)); if(!list.length){wrap.innerHTML='<div class="card">Məhsul yoxdur.</div>';return} wrap.innerHTML=`<table><thead><tr><th>SKU</th><th>Ad</th><th>Qiymət</th><th>Maya</th><th>Miqdar</th></tr></thead><tbody>${list.map(p=>`<tr><td style="text-align:left">${p.sku}</td><td style="text-align:left">${p.name}</td><td>${fmtAZN(p.price)}</td><td>${fmtAZN(p.cost)}</td><td>${p.qty}</td></tr>`).join('')}</tbody></table>`; }
const loadPurchases=()=>getJSON(K.PUR,[]), savePurchases=v=>setJSON(K.PUR,v);
function renderPurchases(){const list=loadPurchases(); $('purchaseWrap').innerHTML = list.length? `<table><thead><tr><th>Tarix</th><th>SKU</th><th>Miqdar</th><th>Maya</th></tr></thead><tbody>${list.map(p=>`<tr><td>${ddmmyyyy(p.date)}</td><td>${p.sku}</td><td>${p.qty}</td><td>${fmtAZN(p.cost)}</td></tr>`).join('')}</tbody></table>` : 'Məlumat yoxdur.'; }
function addPurchase(){const date=$('purDate').value||nowISO(), sku=$('purSku').value.trim(), qty=Number($('purQty').value||0), cost=Number($('purCost').value||0); if(!sku||qty<=0||cost<=0){alert('Məlumatları düzgün daxil edin.');return;} const p=loadPurchases(); p.push({date,sku,qty,cost}); savePurchases(p); const prods=loadProducts(); const ix=prods.findIndex(x=>x.sku===sku); if(ix>=0){ prods[ix].qty=(Number(prods[ix].qty)||0)+qty; prods[ix].cost=cost; } else prods.push({sku,name:sku,price:cost*1.2,cost,qty}); saveProducts(prods); renderPurchases(); renderInventory(); ['purSku','purQty','purCost'].forEach(id=>$(id).value=''); }
const loadSales=()=>getJSON(K.SALE,[]), saveSales=v=>setJSON(K.SALE,v);
function renderSales(){const list=loadSales(); $('salesWrap').innerHTML = list.length? `<table><thead><tr><th>Tarix</th><th>FIN</th><th>SKU</th><th>Miq.</th><th>Qiymət</th><th>IMEI</th><th>Əməkdaş</th></tr></thead><tbody>${list.map(s=>`<tr><td>${ddmmyyyy(s.date)}</td><td>${s.fin}</td><td>${s.sku}</td><td>${s.qty}</td><td>${fmtAZN(s.price)}</td><td>${s.imei||'-'}</td><td>${s.employee||'-'}</td></tr>`).join('')}</tbody></table>` : 'Məlumat yoxdur.'; }
function addSale(){
  const date=$('saleDate').value||nowISO(), fin=$('saleFin').value.trim(), sku=$('saleSku').value.trim(), qty=Number($('saleQty').value||0), price=Number($('salePrice').value||0), imei=$('saleImei').value.trim(), saleType=$('saleTypeSel').value, employee=$('saleEmployee').value.trim(); if(!fin||!sku||qty<=0||price<=0){alert('Satış məlumatlarını tam daxil edin.');return;}
  const customers=loadCustomers(); const cust=customers.find(c=>c.finCode===fin); if(!cust){alert('Bu FIN ilə müştəri yoxdur. Əvvəlcə Rəsmiləşdir bölməsində yaradın.');return;}
  const prods=loadProducts(); const pr=prods.find(p=>p.sku===sku); if(!pr||(Number(pr.qty)||0)<qty){alert('Anbarda kifayət qədər stok yoxdur.');return;}
  const saleId='S'+Date.now(); const sale={id:saleId,date,fin,sku,qty,price,imei,saleType,employee}; const sales=loadSales(); sales.push(sale); saveSales(sales); pr.qty=Number(pr.qty)-qty; saveProducts(prods); renderSales(); renderInventory();
  cust.sales=cust.sales||[]; cust.sales.push({id:saleId,date,sku,qty,price,imei,saleType,employee, payments:[]}); const ix=customers.findIndex(x=>x.finCode===fin); customers[ix]=cust; setJSON(K.CUST,customers);
  ['saleSku','saleQty','salePrice','saleImei','saleEmployee'].forEach(id=>$(id).value=''); alert('Satış qeyd olundu.');
}
function runReport(){
  const from=$('repFrom').value||nowISO(), to=$('repTo').value||nowISO(); const emp=($('repEmployee').value||'').toLowerCase(); const sku=($('repSku').value||'').toLowerCase();
  const sales=loadSales().filter(s=> s.date>=from && s.date<=to && (!emp || (s.employee||'').toLowerCase().includes(emp)) && (!sku || (s.sku||'').toLowerCase().includes(sku)));
  const purchases=loadPurchases().filter(p=> p.date>=from && p.date<=to); const prods=loadProducts();
  let totalSales=0, totalSalesCost=0; sales.forEach(s=>{ totalSales += s.price*s.qty; const pr=prods.find(x=>x.sku===s.sku); const c=(pr?.cost)||0; totalSalesCost += c*s.qty; });
  const totalPurch = purchases.reduce((a,b)=>a+b.cost*b.qty,0); const profit = totalSales - totalSalesCost; const stockVal = prods.reduce((a,p)=>a+(Number(p.qty)||0)*(Number(p.cost)||0),0);
  const byEmp={}; sales.forEach(s=>{ const pr=prods.find(p=>p.sku===s.sku); const cost=(pr?.cost)||0; const pft=(s.price-cost)*s.qty; const key=s.employee||'Naməlum'; byEmp[key]=(byEmp[key]||0)+pft; });
  const empRows = Object.entries(byEmp).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<tr><td style='text-align:left'>${k}</td><td>${fmtAZN(v)}</td></tr>`).join('');
  $('reportWrap').innerHTML = `<div class='row'>
    <div class='col-6 card'><h4>Satışlar</h4><div>${fmtAZN(totalSales)}</div><div class='muted'>Mənfəət: ${fmtAZN(profit)} (maya: ${fmtAZN(totalSalesCost)})</div></div>
    <div class='col-6 card'><h4>Alışlar</h4><div>${fmtAZN(totalPurch)}</div><div class='muted'>Stok dəyəri: ${fmtAZN(stockVal)}</div></div>
    <div class='col-12 card'><h4>Əməkdaş üzrə mənfəət</h4>${empRows?`<table><thead><tr><th style='text-align:left'>Əməkdaş</th><th>Mənfəət</th></tr></thead><tbody>${empRows}</tbody></table>`:'Məlumat yoxdur.'}</div>
  </div>`;
}
function isOverdue(date){ const due=new Date(date); const today=new Date(); const oneDay=24*3600*1000; return (today - due) >= oneDay }
function renderOverdue(){ const el=$('overdueWrap'); if(!el) return; el.innerHTML='(Demo)'; }
const loadEmployees=()=>getJSON(K.EMP,[]), saveEmployees=v=>setJSON(K.EMP,v); const loadUsers=()=>getJSON(K.USR,[]), saveUsers=v=>setJSON(K.USR,v);
function renderEmployees(){const list=loadEmployees(); const el=$('empWrap'); if(!el) return; el.innerHTML = list.length? `<table><thead><tr><th>Ad</th><th>Baz maaş</th><th>Bonus %</th><th>Status</th></tr></thead><tbody>${list.map(e=>`<tr><td style='text-align:left'>${e.name}</td><td>${fmtAZN(e.base)}</td><td>${e.bonusPct}%</td><td>${e.status}</td></tr>`).join('')}</tbody></table>` : 'Məlumat yoxdur.'}
function addOrUpdateEmployee(){const name=$('empName').value.trim(), base=Number($('empBase').value||0), pct=Number($('empBonusPct').value||0), status=$('empStatus').value; if(!name){alert('Ad tələb olunur');return;} const list=loadEmployees(); const ix=list.findIndex(e=>e.name.toLowerCase()===name.toLowerCase()); if(ix>=0) list[ix]={...list[ix], base, bonusPct:pct, status}; else list.push({name,base,bonusPct:pct,status}); saveEmployees(list); renderEmployees(); ['empName','empBase','empBonusPct'].forEach(id=>$(id).value=''); }
function renderUsers(){const list=loadUsers(); const el=$('usersWrap'); if(!el) return; el.innerHTML = list.length? `<table><thead><tr><th>Login</th><th>Ad Soyad</th><th>Rol</th><th>Status</th></tr></thead><tbody>${list.map(u=>`<tr><td style='text-align:left'>${u.login}</td><td style='text-align:left'>${u.name}</td><td>${u.role}</td><td>${u.status}</td></tr>`).join('')}</tbody></table>` : 'Məlumat yoxdur.'}
function addOrUpdateUser(){const login=$('usrLogin').value.trim(), name=$('usrName').value.trim(), role=$('usrRole').value, status=$('usrStatus').value; if(!login||!name){alert('Login və Ad tələb olunur');return;} const list=loadUsers(); const ix=list.findIndex(u=>u.login.toLowerCase()===login.toLowerCase()); if(ix>=0) list[ix]={...list[ix], name, role, status}; else list.push({login,name,role,status}); saveUsers(list); renderUsers(); ['usrLogin','usrName'].forEach(id=>$(id).value=''); }
function runPayroll(){ /* ehtiyac olduqda tamamlaya bilərik */ }

/* ===== TƏKLİFLƏR ===== */
const loadOffers=()=>getJSON(K.OFFER,[]);
const saveOffers=v=>setJSON(K.OFFER,v);

function openOfferModal(offerId=null){
  const m=$('offerModal'); m.style.display='flex';
  $('ofDate').value = nowISO();
  $('ofFrom').value = 'Baktel Electronics MMC';
  $('ofTo').value = '';
  $('ofNo').value = '';
  $('ofNote').value = '';
  $('ofDirector').value = 'İlqar Mahmudov';
  $('ofToLine').value = '';
  $('ofBody').innerHTML = '';
  addOfferRow();
  m.dataset.editing = offerId? String(offerId): '';
  if(offerId){
    const o = loadOffers().find(x=>String(x.id)===String(offerId));
    if(o){ $('ofFrom').value=o.from; $('ofTo').value=o.to; $('ofDate').value=o.date; $('ofNo').value=o.no||''; $('ofNote').value=o.note||''; $('ofDirector').value=o.director||'İlqar Mahmudov'; $('ofToLine').value=o.toLine||o.to||''; $('ofBody').innerHTML=''; (o.items||[]).forEach(it=> addOfferRow(it.name,it.qty,it.price)); renumberOfferRows(); recalcOfferTotals(); }
  }else{ renumberOfferRows(); recalcOfferTotals(); }
}
function closeOfferModal(){ const m=$('offerModal'); m.style.display='none'; m.dataset.editing='';}

function addOfferRow(name='',qty=1,price=0){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td class="of-idx" style="text-align:center">-</td>
    <td style="text-align:left"><input class="of-name" placeholder="Məhsul / model / təsvir" value="${name}"></td>
    <td><input class="of-qty" type="number" min="1" step="1" value="${qty}"></td>
    <td><input class="of-price" type="number" min="0" step="0.01" value="${price}"></td>
    <td class="of-line">0.00 ₼</td>
    <td><button class="btn danger of-del">Sil</button></td>`;
  $('ofBody').appendChild(tr);
  tr.querySelectorAll('input').forEach(inp=> inp.addEventListener('input',recalcOfferTotals));
  tr.querySelector('.of-del').addEventListener('click',()=>{ tr.remove(); renumberOfferRows(); recalcOfferTotals(); });
  renumberOfferRows(); recalcOfferTotals();
}
function clearOfferRows(){ $('ofBody').innerHTML=''; renumberOfferRows(); recalcOfferTotals(); }
function renumberOfferRows(){ [...document.querySelectorAll('#ofBody tr')].forEach((tr,i)=>{ const c=tr.querySelector('.of-idx'); if(c) c.textContent=String(i+1); }); }

function recalcOfferTotals(){
  let sub=0;
  [...document.querySelectorAll('#ofBody tr')].forEach(tr=>{
    const qty=Number(tr.querySelector('.of-qty')?.value||0);
    const price=Number(tr.querySelector('.of-price')?.value||0);
    const line=qty*price; tr.querySelector('.of-line').textContent=fmtAZN(line);
    sub+=line;
  });
  const vat=sub*0.18, grand=sub+vat;
  $('ofSub').textContent=fmtAZN(sub);
  $('ofVat').textContent=fmtAZN(vat);
  $('ofGrand').textContent=fmtAZN(grand);
  return {sub,vat,grand};
}
function collectOffer(){
  const from=$('ofFrom').value.trim(), to=$('ofTo').value.trim(), date=$('ofDate').value||nowISO(), no=$('ofNo').value.trim(), note=$('ofNote').value.trim();
  const director=$('ofDirector').value.trim()||'İlqar Mahmudov'; const toLine=$('ofToLine').value.trim()||to;
  if(!from||!to){ alert('“Təklif edən” və “Təklif olunan” xanaları doldurun.'); return null; }
  const items=[...document.querySelectorAll('#ofBody tr')].map(tr=>({name:tr.querySelector('.of-name')?.value?.trim()||'', qty:Number(tr.querySelector('.of-qty')?.value||0), price:Number(tr.querySelector('.of-price')?.value||0)})).filter(it=>it.name && it.qty>0 && it.price>=0);
  if(!items.length){ alert('Ən azı bir məhsul əlavə edin.'); return null; }
  const totals=recalcOfferTotals();
  return {from,to,date,no,note,director,toLine,items, sub:totals.sub, vat:totals.vat, total:totals.grand};
}
function saveOffer(returnId=false){
  const data=collectOffer(); if(!data) return null;
  const list=loadOffers(); let id=$('offerModal').dataset.editing||'';
  if(id){ const ix=list.findIndex(x=>String(x.id)===String(id)); if(ix>=0) list[ix]={...list[ix],...data}; }
  else{ id='Q'+Date.now(); list.push({id,...data,createdAt:new Date().toISOString()}); }
  saveOffers(list); renderOffers(); closeOfferModal(); alert('Təklif yadda saxlandı.'); return returnId? id : true;
}
function renderOffers(){
  const wrap=$('offersWrap'); if(!wrap) return; const list=loadOffers().sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  if(!list.length){ wrap.innerHTML='Təklif yoxdur.'; return; }
  wrap.innerHTML=`<table><thead><tr><th style="text-align:left">№</th><th style="text-align:left">Tərəflər</th><th>Tarix</th><th>Cəmi</th><th>ƏDV</th><th>Yekun</th><th>Əməliyyat</th></tr></thead><tbody>${list.map(o=>`<tr><td style="text-align:left">${o.no||o.id}</td><td style="text-align:left">${o.from} → ${o.to}</td><td>${ddmmyyyy(o.date)}</td><td>${fmtAZN(o.sub||0)}</td><td>${fmtAZN(o.vat||0)}</td><td>${fmtAZN(o.total||0)}</td><td><button class="btn" data-act="view" data-id="${o.id}">Bax / Düzəlt</button><button class="btn" data-act="print" data-id="${o.id}">Çap</button><button class="btn danger" data-act="del" data-id="${o.id}">Sil</button></td></tr>`).join('')}</tbody></table>`;
  wrap.querySelectorAll('button[data-act]').forEach(b=>{ b.addEventListener('click',()=>{const id=b.dataset.id,act=b.dataset.act; const list=loadOffers(); const o=list.find(x=>String(x.id)===String(id)); if(!o) return; if(act==='view') openOfferModal(id); if(act==='del'){ if(confirm('Təklif silinsin?')){ saveOffers(list.filter(x=>x.id!==id)); renderOffers(); } } if(act==='print') openOfferPrint(o); }); });
}

/* ==== ÇAP (TƏKLİF) ==== */
function openOfferPrint(o){
  const rows=(o.items||[]).map((it,i)=>`<tr><td style="text-align:center">${i+1}</td><td style="text-align:left">${escapeHtml(it.name)}</td><td style="text-align:right">${num(it.price)}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">${num(it.qty*it.price)}</td></tr>`).join('');
  const html = `
  <div class='print-a4 print-root'>
    <style>
      .phdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6mm}
      .ph-left{display:flex;gap:8px;align-items:center}
      .logo{width:24mm;height:24mm;display:inline-block}
      .brand{font-size:16pt;font-weight:800}
      .addr{font-size:10pt;line-height:1.4;text-align:right}
      .kline{margin:3mm 0 5mm;font-size:11pt}
      .kline div{margin:2mm 0}
      .ptitle{font-size:16pt;font-weight:800;text-align:center;margin:2mm 0 4mm}
      .print-table th,.print-table td{border:1px solid #cbd5e1;padding:6px 8px}
      .print-table thead th{background:#f3f6fb}
    </style>
    <div class="phdr">
      <div class="ph-left">
        ${svgLogo()}
        <div class="brand">${COMPANY.name}</div>
      </div>
      <div class="addr">Ünvan: ${COMPANY.address}<br/>${COMPANY.contact}</div>
    </div>
    <div class="kline">
      <div><b>Tarix:</b> ${ddmmyyyy(o.date)}</div>
      <div><b>Kimə:</b> ${escapeHtml(o.toLine||o.to||'')}</div>
    </div>
    <div class="ptitle">Təklif</div>
    <table class="print-table" style="width:100%;font-size:11pt">
      <thead><tr><th style="width:7%;text-align:center">#</th><th style="text-align:left">Məhsul</th><th style="width:18%;text-align:right">Vahidin qiyməti (AZN)</th><th style="width:12%;text-align:center">Miqdar</th><th style="width:18%;text-align:right">Cəmi (ƏDV-siz)</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <table style="width:100%;margin-top:4mm;font-size:11pt">
      <tr><td style="text-align:right;width:70%"><b>Cəmi</b></td><td style="text-align:right;width:30%">${fmtAZN(o.sub||0)}</td></tr>
      <tr><td style="text-align:right">ƏDV 18%</td><td style="text-align:right">${fmtAZN(o.vat||0)}</td></tr>
      <tr><td style="text-align:right"><b>Yekun</b></td><td style="text-align:right"><b>${fmtAZN(o.total||0)}</b></td></tr>
    </table>
    <div class='sign-cols'>
      <div style="flex:1"><div><b>Direktor:</b> ${escapeHtml(o.director||'İlqar Mahmudov')}</div><span class='sigline'></span></div>
      <div style="flex:1"><div><b>İmza:</b></div><span class='sigline'></span></div>
    </div>
  </div>`;
  const w=window.open('','_blank'); w.document.write(`<!doctype html><meta charset='utf-8'><title>Təklif</title><body class='print-root'>${html}</body>`); w.document.close(); w.focus(); w.print();
}
function svgLogo(){return `<svg class="logo" viewBox="0 0 100 100"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#f59e0b"/><stop offset="1" stop-color="#ea580c"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#g)" /><path d="M30 60h40v8H30zM45 25h10v35H45z" fill="#fff"/></svg>`}
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }
function num(n){ return (Number(n)||0).toLocaleString('az-AZ',{minimumFractionDigits:2,maximumFractionDigits:2}); }

/* ===== INIT ===== */
window.addEventListener('DOMContentLoaded',()=>{
  // NAV
  goto('view-home');
  // Calc
  $('btnCalc').addEventListener('click',calc); $('btnCalcReset').addEventListener('click',resetCalc);
  // Finalize
  $('btnSaveCustomer').addEventListener('click',saveCustomerOnly); $('btnFinalizeReset').addEventListener('click',resetFinalize); $('btnAddCustomer').addEventListener('click',()=>{ensureStartDate(); goto('view-finalize')}); ensureStartDate();
  // Customers
  ['searchName','searchPhone','searchFin'].forEach(id=>$(id).addEventListener('input',renderCustomers)); renderCustomers();
  // Inventory
  $('btnAddInv').addEventListener('click',addOrUpdateProduct); $('invSearch').addEventListener('input',renderInventory); renderInventory();
  // Purchases
  $('btnAddPurchase').addEventListener('click',addPurchase); $('purDate').value=nowISO(); renderPurchases();
  // Sales
  $('btnAddSale').addEventListener('click',addSale); $('saleDate').value=nowISO(); renderSales();
  // Reports
  $('btnRunReport').addEventListener('click',runReport); $('repFrom').value=nowISO(); $('repTo').value=nowISO();
  // Overdue
  renderOverdue();
  // Employees & Users
  $('btnAddEmp').addEventListener('click',addOrUpdateEmployee); $('btnAddUser').addEventListener('click',addOrUpdateUser); renderEmployees(); renderUsers();
  // Payroll
  $('payFrom') && ($('payFrom').value=nowISO()); $('payTo') && ($('payTo').value=nowISO());

  // OFFERS
  $('btnOpenOffer').addEventListener('click',()=> openOfferModal());
  $('btnOfferNew').addEventListener('click',()=> openOfferModal());
  $('offerClose').addEventListener('click',closeOfferModal);
  $('ofAddRow').addEventListener('click',()=> addOfferRow());
  $('ofClearRows').addEventListener('click',clearOfferRows);
  $('ofDate').value=nowISO();
  $('ofSave').addEventListener('click',()=> saveOffer());
  $('ofSavePrint').addEventListener('click',()=>{ const id=saveOffer(true); if(!id) return; const o=loadOffers().find(x=>x.id===id); if(o) openOfferPrint(o); });
  renderOffers();
});
</script>
</body>
</html>
