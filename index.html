<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KREDİT KALKULYATORU</title>
  <style>
    :root{ 
      --bg:#f7f9fc; --text:#0f172a; --card:#ffffff; --border:#e7eaf0; --muted:#51607a; --primary:#dc2626;
      --pill-bg:#eef2ff; --pill-border:#c7d2fe; --input-bg:#ffffff; --input-border:#cfd5e1; --shadow:0 6px 18px rgba(2,6,23,.06);
      --radius:14px; --warn-bg:#fff1f2; --warn-border:#fecaca; --warn-text:#991b1b;
      --ok-bg:#f0fdf4; --ok-border:#bbf7d0; --ok-text:#14532d; --nav:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:16px;line-height:1.55}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:center;gap:10px;margin:0 0 10px 0}
    header h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px;color:var(--primary)}

    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:16px}
    .tab{border:1px solid var(--border);background:#fff;color:#0f172a;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700;box-shadow:var(--shadow)}
    .tab.active{background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#fff;border-color:#0284c7}

    h2{font-size:22px;font-weight:700;color:#111827;margin:6px 0 0}
    h3{font-size:18px;font-weight:700;color:#111827;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;box-shadow:var(--shadow)}
    .row{display:grid;gap:14px}
    @media(min-width:720px){.row{grid-template-columns:repeat(12,1fr)}}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    label{font-size:13px;color:#334155;font-weight:600}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text)}
    .btn{border:1px solid #cbd5e1;background:#f1f5f9;color:#0f172a;padding:11px 16px;border-radius:12px;cursor:pointer;transition:.15s ease;box-shadow:var(--shadow);font-weight:700}
    .btn.sm{padding:6px 10px;font-size:12px}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#15803d;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#b91c1c;color:#fff}
    .btn.primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border-color:#0284c7;color:#fff}
    .btn.ghost{background:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--pill-border);padding:6px 10px;border-radius:999px;background:var(--pill-bg);color:#3730a3;font-size:12px}
    .pill.risk-low{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .pill.risk-med{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .pill.risk-high{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .muted{color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:#f8fafc;padding:12px 10px;font-weight:700;font-size:14px;color:#111827;border-bottom:1px solid var(--border);text-align:right}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);font-size:13px;text-align:right}
    tbody tr:nth-child(odd){background:rgba(2,6,23,.02)}
    canvas{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .bar > span{display:block;height:100%;background:#22c55e}
    .bar.warn > span{background:#ef4444}
    .notice{padding:12px;border-radius:12px;margin-top:8px}
    .notice.warn{background:var(--warn-bg);border:1px solid var(--warn-border);color:var(--warn-text)}
    .notice.ok{background:var(--ok-bg);border:1px solid var(--ok-border);color:var(--ok-text)}
    .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.12)}
    .inline-check{display:flex;align-items:center;gap:6px;justify-content:flex-start}
    .inline-check label{margin:0}
    .inline-check .big-check{width:18px;height:18px;accent-color:#16a34a;transform:scale(1.15);transform-origin:left center;margin-right:2px}
    @media print{ .btn, .nav, #view-dashboard { display:none } .wrap{max-width:1000px} header{margin-bottom:0} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>KREDİT KALKULYATORU</h1>
    </header>

    <!-- Naviqasiya -->
    <nav class="nav">
      <button class="tab active" id="tab-dashboard" onclick="go('dashboard')">Dashboard</button>
      <button class="tab" id="tab-calculator" onclick="go('calculator')">Kalkulyator</button>
      <button class="tab" id="tab-sales" onclick="go('sales')">Satış</button>
    </nav>

    <!-- DASHBOARD (ilk görünən) -->
    <main id="view-dashboard">
      <section class="card">
        <h3>Xoş gəldiniz!</h3>
        <p class="muted">Tez başlanğıc üçün aşağıdakı qısa keçidlərdən istifadə edin.</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px">
          <div class="card" style="margin:0;display:flex;flex-direction:column;gap:8px">
            <h3>Kredit Kalkulyatoru</h3>
            <p class="muted">Müştəri üçün kredit/aylıq ödənişi hesabla.</p>
            <div><button class="btn primary" onclick="go('calculator')">Aç</button></div>
          </div>
          <div class="card" style="margin:0;display:flex;flex-direction:column;gap:8px">
            <h3>Satış</h3>
            <p class="muted">Yeni satış qeydi əlavə et və siyahıya bax.</p>
            <div><button class="btn" onclick="go('sales')">Aç</button></div>
          </div>
        </div>
      </section>
      <section class="card">
        <h3>Qısa göstəricilər</h3>
        <div class="row">
          <div class="col-4"><h2 id="dash-total-sales">0</h2><div class="muted">Satış sayı</div></div>
          <div class="col-4"><h2 id="dash-total-amount">0 AZN</h2><div class="muted">Toplam məbləğ</div></div>
          <div class="col-4"><h2 id="dash-last-sale">—</h2><div class="muted">Son satış</div></div>
        </div>
      </section>
    </main>

    <!-- KALKULYATOR (modul #1) -->
    <main id="view-calculator" style="display:none">
      <section id="calc" class="card">
        <div id="calcAlert" class="notice warn" style="display:none"></div>
        <div class="row">
          <div class="col-4">
            <label>Məhsul dəyəri (AZN)</label>
            <input id="price" type="number" min="0" step="0.01" value="1000" />
          </div>
          <div class="col-3">
            <label>Müddət (ay)</label>
            <select id="months">
              <option value="3">3</option>
              <option value="6">6</option>
              <option value="9">9</option>
              <option value="12" selected>12</option>
              <option value="15">15</option>
              <option value="18">18</option>
            </select>
          </div>
          <div class="col-3">
            <label>Risk qrupu</label>
            <select id="risk" required>
              <option value="">-- Seçin --</option>
              <option value="low">Aşağı risk (A)</option>
              <option value="med">Orta risk (B)</option>
              <option value="high">Yüksək risk (C)</option>
            </select>
          </div>
          <div class="col-3">
            <label>Aylıq əmək haqqı (AZN)</label>
            <input id="salary" type="number" min="1" step="1" value="" required />
          </div>
          <div class="col-3">
            <label>Digər öhdəliklər (AZN)</label>
            <input id="oblig" type="number" min="0" step="1" value="" required />
          </div>
          <div class="col-12 inline-check">
            <input class="big-check" type="checkbox" id="addIncomeChk" onchange="toggleExtraIncome()" />
            <label for="addIncomeChk">Əlavə gəlir var?</label>
          </div>
          <div class="col-3" id="addIncomeTypeWrap" style="display:none">
            <label>Əlavə gəlir növü</label>
            <select id="addIncomeType" disabled onchange="onIncomeTypeChange()">
              <option value="">-- Seçin --</option>
              <option value="muavinet">Müavinət</option>
              <option value="bonus">Bonus</option>
              <option value="kiraye">Kirayə gəliri</option>
              <option value="freelance">Freelance</option>
              <option value="parttime">Müvəqqəti əlavə iş</option>
            </select>
          </div>
          <div class="col-3" id="addIncomeAmtWrap" style="display:none">
            <label>Əlavə gəlir məbləği (AZN)</label>
            <input id="addIncomeAmt" type="number" min="1" step="1" value="" disabled />
          </div>
          <div class="col-12" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn success" onclick="calc()">Hesabla</button>
            <button class="btn danger" onclick="resetForm()">Sıfırla</button>
            <button class="btn ghost" onclick="exportPrint()">PDF (Çap)</button>
          </div>
        </div>
      </section>

      <div class="layout">
        <section class="card" id="summary"></section>
        <section class="card">
          <h3>Ödəniş cədvəli</h3>
          <div id="scheduleWrap" style="overflow:auto;max-height:420px"></div>
        </section>
      </div>

      <section class="card"><canvas id="chart" height="220"></canvas></section>
    </main>

    <!-- SATIŞ modulu -->
    <main id="view-sales" style="display:none">
      <section class="card">
        <h3>Yeni satış</h3>
        <div class="row">
          <div class="col-4">
            <label>Müştəri adı</label>
            <input id="s_name" type="text" placeholder="Ad Soyad" />
          </div>
          <div class="col-4">
            <label>Məhsul</label>
            <input id="s_product" type="text" placeholder="Məhsul adı/model" />
          </div>
          <div class="col-4">
            <label>Məbləğ (AZN)</label>
            <input id="s_amount" type="number" min="0" step="0.01" placeholder="0.00" />
          </div>
          <div class="col-12" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn primary" onclick="addSale()">Qeyd et</button>
            <button class="btn" onclick="clearSaleForm()">Təmizlə</button>
          </div>
        </div>
      </section>
      <section class="card">
        <h3>Satış siyahısı</h3>
        <div id="salesTableWrap"></div>
      </section>
    </main>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ===== Utils
    const fmtAZN = n=> (new Intl.NumberFormat('az-AZ',{style:'currency',currency:'AZN',maximumFractionDigits:2})).format(n||0);
    const toNum = id=> Number((document.getElementById(id)?.value) ?? 0);

    // ===== Router (Dashboard/Kalkulyator/Satış)
    function go(view){
      const map={dashboard:'view-dashboard', calculator:'view-calculator', sales:'view-sales'};
      for(const k in map){
        const el=document.getElementById(map[k]);
        if(el) el.style.display = (k===view)?'block':'none';
      }
      ['dashboard','calculator','sales'].forEach(v=>{
        const t=document.getElementById('tab-'+v);
        if(t) t.classList.toggle('active', v===view);
      });
      if(view==='dashboard') renderDashboard();
      if(view==='sales') renderSales();
    }

    // ===== Policy & limits (kalkulyator)
    const POLICY_RISK_ONLY = { low: 0.20, med: 0.30, high: 0.50 };
    const MIN_DOWN_AZN = 50;
    const MAX_OBLIG_SHARE = 0.50;
    const MAX_DSR = 0.40;

    function getDownPayment(price, riskKey, salary=0, oblig=0){
      const base = POLICY_RISK_ONLY[riskKey] ?? POLICY_RISK_ONLY.med;
      salary = Number(salary)||0; oblig = Number(oblig)||0;
      const net = Math.max(0, salary - oblig);
      const ratio = salary>0 ? net / salary : 0;
      let mod = 0;
      if(ratio >= 0.70) mod = -0.10; else if(ratio >= 0.50) mod = -0.05; else if(ratio >= 0.35) mod = 0.00; else if(ratio >= 0.20) mod = +0.10; else mod = +0.20;
      if(riskKey==='high') mod *= 0.7;
      const pct = Math.min(0.85, Math.max(0.10, base + mod));
      let down = price * pct;
      if(down < MIN_DOWN_AZN) down = MIN_DOWN_AZN;
      if(down > price) down = price;
      return { down, pct, base, ratio, net };
    }

    function exportPrint(){
      const w=window.open('','_blank');
      const summary=document.getElementById('summary').innerHTML;
      const sched=document.getElementById('scheduleWrap').innerHTML;
      w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>Kredit Çap</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto; padding:16px} h1{margin:0 0 8px} .muted{color:#64748b}
        table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:8px;text-align:right} th{text-align:right;background:#f8fafc}
        th:first-child,td:first-child{text-align:left}
        .block{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:8px 0}
        </style></head><body>
        <h1>Kredit hesablaması</h1>
        <div class='muted'>${new Date().toLocaleString('az-AZ')}</div>
        <div class='block'>${summary}</div>
        <div class='block'>${sched}</div>
      </body></html>`);
      w.document.close(); w.focus(); w.print();
    }

    // Əlavə gəlir UI
    function toggleExtraIncome(){
      const chk=document.getElementById('addIncomeChk');
      const typeWrap=document.getElementById('addIncomeTypeWrap');
      const amtWrap=document.getElementById('addIncomeAmtWrap');
      const typeSel=document.getElementById('addIncomeType');
      const amtInp=document.getElementById('addIncomeAmt');
      if(!chk||!typeWrap||!amtWrap||!typeSel||!amtInp) return;
      const on=!!chk.checked;
      typeWrap.style.display= on? 'block':'none';
      typeSel.disabled = !on; if(!on) typeSel.value='';
      amtWrap.style.display = 'none';
      amtInp.disabled = true; amtInp.value='';
    }
    function onIncomeTypeChange(){
      const typeSel=document.getElementById('addIncomeType');
      const amtWrap=document.getElementById('addIncomeAmtWrap');
      const amtInp=document.getElementById('addIncomeAmt');
      if(!typeSel||!amtWrap||!amtInp) return;
      if(typeSel.value){ amtWrap.style.display='block'; amtInp.disabled=false; }
      else { amtWrap.style.display='none'; amtInp.disabled=true; amtInp.value=''; }
    }

    let chart=null;

    function calc(){
      ['risk','salary','oblig','addIncomeType','addIncomeAmt'].forEach(id=>document.getElementById(id)?.classList.remove('invalid'));
      const riskEl=document.getElementById('risk');
      const salaryEl=document.getElementById('salary');
      const obligEl=document.getElementById('oblig');
      const chk=document.getElementById('addIncomeChk');
      const typeSel=document.getElementById('addIncomeType');
      const amtInp=document.getElementById('addIncomeAmt');

      const risk=riskEl?.value||''; const salaryStr=salaryEl?.value||''; const obligStr=obligEl?.value||'';
      if(!risk || salaryStr==='' || obligStr===''){
        if(!risk) riskEl.classList.add('invalid');
        if(salaryStr==='') salaryEl.classList.add('invalid');
        if(obligStr==='') obligEl.classList.add('invalid');
        const alertBox=document.getElementById('calcAlert'); if(alertBox){ alertBox.style.display='block'; alertBox.textContent='Zəhmət olmasa Risk qrupu, Əmək haqqı və Digər öhdəlikləri daxil edin.'; }
        return;
      }

      let extra=0; let extraDesc='';
      if(chk?.checked){
        if(!typeSel.value){ typeSel.classList.add('invalid'); alert('Əlavə gəlir növünü seçin.'); return; }
        extraDesc = typeSel.options[typeSel.selectedIndex].text;
        if(amtInp.value===''){ amtInp.classList.add('invalid'); alert('Əlavə gəlir məbləğini daxil edin.'); return; }
        extra = Math.max(0, Number(amtInp.value)||0);
        if(extra<=0){ amtInp.classList.add('invalid'); alert('Əlavə gəlir məbləği 0-dan böyük olmalıdır.'); return; }
      }

      const price=toNum('price');
      const months=toNum('months');
      const salary=Number(document.getElementById('salary').value||0) + extra;
      const oblig=Number(document.getElementById('oblig').value||0);
      if(months<=0){ alert('Müddət ən az 1 ay olmalıdır.'); return; }

      const dti = (salary>0)? (oblig/salary) : (oblig>0? Infinity : 0);
      const dtiWarn = dti > MAX_OBLIG_SHARE;

      const baseRes = getDownPayment(price, risk, salary, oblig);
      let down = baseRes.down; let pct = baseRes.pct; const base = baseRes.base; const ratio = baseRes.ratio; const net = baseRes.net;
      let principal = Math.max(0, price - down);
      let monthly = months>0 ? principal / months : 0;

      const maxMonthly = Math.max(0, net * MAX_DSR);
      const needsAdj = monthly > maxMonthly + 1e-9;
      let autoAdj = false, prevDown = down, prevMonthly = monthly;
      if(needsAdj){
        const requiredPrincipal = Math.max(0, maxMonthly * months);
        const newDownRaw = price - requiredPrincipal;
        down = Math.min(price, Math.max(MIN_DOWN_AZN, Math.max(prevDown, newDownRaw)));
        pct = price>0 ? (down/price) : 0;
        principal = Math.max(0, price - down);
        monthly = months>0 ? principal / months : 0;
        autoAdj = true;
      }

      let bal = principal; const rows=[]; const sd=new Date();
      for(let i=1;i<=months;i++){
        bal=Math.max(0,bal-monthly);
        const d=new Date(sd); d.setMonth(d.getMonth()+i);
        rows.push({i,date:d.toISOString().slice(0,10),monthly,bal});
      }

      const riskCls = risk==='low'?'risk-low':(risk==='high'?'risk-high':'risk-med');
      const dtiHtml = dtiWarn
        ? `<div class="notice warn">Diqqət: Öhdəlik/Gəlir = ${(dti*100).toFixed(0)}% (hədd ${Math.round(MAX_OBLIG_SHARE*100)}%). Yüksək risk göstəricisi.</div>`
        : '';
      const extraHtml = extra>0 ? `<div class="pill">Əlavə gəlir: ${extraDesc} — ${fmtAZN(extra)}</div>` : '';

      document.getElementById('calcAlert').style.display='none';
      document.getElementById('summary').innerHTML=`
        <h3>Xülasə</h3>
        ${dtiHtml}
        <div class="row">
          <div class="col-6"><div class="pill ${riskCls}">Risk: ${risk.toUpperCase()}</div>${extraHtml}<h2>${fmtAZN(price)}</h2><div class="muted">Məhsul dəyəri</div></div>
          <div class="col-6"><div class="pill">İlkin ödəniş</div>
            <h2>${fmtAZN(down)} <span class="muted">(${(pct*100).toFixed(0)}%)</span></h2>
            ${autoAdj?`<div class="notice ok">DSR həddinə görə ilkin ödəniş <strong>avtomatik artırılıb</strong>. Əvvəl: ${fmtAZN(prevDown)}, Aylıq: ${fmtAZN(prevMonthly)} → ${fmtAZN(monthly)}</div>`:''}
          </div>
          <div class="col-6"><div class="pill">Kredit</div><h2>${fmtAZN(principal)}</h2></div>
          <div class="col-6"><div class="pill">Aylıq</div><h2>${fmtAZN(monthly)}</h2></div>
          <div class="col-12"><div class="muted">Risk baza payı: ${(base*100).toFixed(0)}% • Net gəlir: ${fmtAZN(net)} (${(ratio*100).toFixed(0)}%)</div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col-12">
            <div class="muted">Borclanma yükü (DSR) — aylıq ödəniş / net gəlir</div>
            <div class="bar ${monthly>maxMonthly?'warn':''}"><span style="width:${Math.min(100, net? (monthly/net)*100 : 0)}%"></span></div>
            <div class="muted" style="margin-top:4px">Maks. aylıq icazə verilən: <strong>${fmtAZN(maxMonthly)}</strong></div>
          </div>
        </div>`;

      document.getElementById('scheduleWrap').innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Tarix</th><th>Aylıq</th><th>Qalıq</th></tr></thead>
          <tbody>
            ${rows.map(r=>`<tr><td>${r.i}</td><td>${r.date}</td><td>${fmtAZN(r.monthly)}</td><td>${fmtAZN(r.bal)}</td></tr>`).join('')}
          </tbody>
        </table>`;

      const labels=rows.map(r=>r.i); const dataBal=rows.map(r=>Number(r.bal.toFixed(2)));
      const ctx=document.getElementById('chart'); if(chart) chart.destroy();
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Qalıq borc',data:dataBal}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},elements:{line:{tension:.25}}}});
    }

    function resetForm(){
      ['price','months','risk','salary','oblig','addIncomeType','addIncomeAmt'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        if(id==='months') el.value=3; else if(id==='risk' || id==='addIncomeType') el.value=''; else el.value='';
        el.classList.remove('invalid');
      });
      const chk=document.getElementById('addIncomeChk');
      const typeWrap=document.getElementById('addIncomeTypeWrap');
      const amtWrap=document.getElementById('addIncomeAmtWrap');
      const typeSel=document.getElementById('addIncomeType');
      const amtInp=document.getElementById('addIncomeAmt');
      if(chk){ chk.checked=false; }
      if(typeWrap){ typeWrap.style.display='none'; }
      if(amtWrap){ amtWrap.style.display='none'; }
      if(typeSel){ typeSel.disabled=true; }
      if(amtInp){ amtInp.disabled=true; }

      document.getElementById('summary').innerHTML="";
      document.getElementById('scheduleWrap').innerHTML="";
      if(chart){ chart.destroy(); chart=null; }
    }

    // ===== Satış sadə state
    const state={ sales: [] };
    const LS_KEY='bakfon_sales_v1';
    function saveSales(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state.sales)); }catch(e){ console.warn('localStorage save error',e);} }
    function loadSales(){
      try{
        const raw=localStorage.getItem(LS_KEY);
        if(!raw) return;
        const arr=JSON.parse(raw);
        if(Array.isArray(arr)){
          state.sales = arr.map(x=>({ ...x, ts: x.ts? new Date(x.ts): new Date() }));
        }
      }catch(e){ console.warn('localStorage load error',e); }
    }

    function addSale(){
      const name=(document.getElementById('s_name').value||'').trim();
      const product=(document.getElementById('s_product').value||'').trim();
      const amount=Number(document.getElementById('s_amount').value||0);
      if(!name||!product||!(amount>0)){ alert('Zəhmət olmasa bütün satış sahələrini doldurun.'); return; }
      const rec={ id: Date.now(), name, product, amount, ts:new Date() };
      state.sales.unshift(rec);
      saveSales();
      clearSaleForm();
      renderSales();
      renderDashboard();
    }
    function clearSaleForm(){
      ['s_name','s_product','s_amount'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    }
    function renderSales(){
      const wrap=document.getElementById('salesTableWrap');
      if(!wrap) return;
      if(state.sales.length===0){ wrap.innerHTML='<div class="muted">Hələ satış yoxdur.</div>'; return; }
      const rows=state.sales.map((s,i)=>`<tr>
        <td>${i+1}</td>
        <td style="text-align:left">${s.name}</td>
        <td style="text-align:left">${s.product}</td>
        <td>${fmtAZN(s.amount)}</td>
        <td>${new Date(s.ts).toLocaleString('az-AZ')}</td>
        <td><button class="btn danger sm" onclick="deleteSale(${s.id})">Sil</button></td>
      </tr>`).join('');
      wrap.innerHTML=`<table><thead><tr><th>#<\/th><th>Müştəri<\/th><th>Məhsul<\/th><th>Məbləğ<\/th><th>Tarix<\/th><th>Əməliyyat<\/th><\/tr><\/thead><tbody>${rows}<\/tbody><\/table>`;
    }
    function deleteSale(id){
      const rec=state.sales.find(s=>s.id===id);
      if(!rec) return;
      const ok=confirm(`"${rec.name}" müştərisini silmək istəyirsiniz? Bu əməliyyat geri qaytarılmır.`);
      if(!ok) return;
      state.sales = state.sales.filter(s=>s.id!==id);
      saveSales();
      renderSales();
      renderDashboard();
    }
    function setupSalesEvents(){
      const wrap=document.getElementById('salesTableWrap');
      if(!wrap || wrap.__hasDelHandler) return;
      wrap.addEventListener('click', (e)=>{
        const btn=e.target.closest('button[data-del]');
        if(!btn) return;
        const id=Number(btn.getAttribute('data-del'));
        if(id) deleteSale(id);
      });
      wrap.__hasDelHandler=true;
    }
    function renderDashboard(){
      const total = state.sales.length;
      const sum = state.sales.reduce((a,b)=>a+b.amount,0);
      const last = state.sales[0]?.ts ? new Date(state.sales[0].ts).toLocaleString('az-AZ') : '—';
      const fmt=n=> new Intl.NumberFormat('az-AZ').format(n||0);
      const el1=document.getElementById('dash-total-sales'); if(el1) el1.textContent = fmt(total);
      const el2=document.getElementById('dash-total-amount'); if(el2) el2.textContent = fmtAZN(sum);
      const el3=document.getElementById('dash-last-sale'); if(el3) el3.textContent = last;
    }

    // Global expose (onclick üçün)
    window.go=go; window.calc=calc; window.resetForm=resetForm; window.exportPrint=exportPrint; window.toggleExtraIncome=toggleExtraIncome; window.onIncomeTypeChange=onIncomeTypeChange; window.deleteSale=deleteSale;

    // İlk açılışda Dashboard
    window.addEventListener('load',()=>{
      loadSales();
      renderDashboard();
      renderSales();
      setupSalesEvents();
      go('dashboard');
    });

    // (Optional) Konsol üçün qeyri-invaziv yoxlamalar — UI-də görünmür
    function runSanity(){
      if(typeof go!=='function') throw new Error('go funksiyası yoxdur');
      go('sales'); go('dashboard');
      console.log('Sanity OK: router işləyir ✅');
    }
    window.runSanity = runSanity;
  </script>
</body>
</html>
