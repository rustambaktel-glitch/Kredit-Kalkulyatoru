<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kredit Kalkulyatoru</title>
  <style>
    :root{ --bg:#0f172a; --card:#0b1226; --border:#18203a; --muted:#94a3b8 }
    *{box-sizing:border-box}
    body{margin:0;background:#0b1020;color:#f8fafc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0 0 12px 0;font-size:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px}
    .row{display:grid;gap:10px}
    @media(min-width:720px){.row{grid-template-columns:repeat(12,1fr)}}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    label{font-size:13px;color:#cbd5e1}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0a1224;color:#e2e8f0}
    input:focus,select:focus{outline:2px solid #334155;border-color:#334155}
    .btn{border:1px solid #1f2937;background:#0d1326;color:#e5e7eb;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#1e293b,#0b1227);border-color:#1f2b48}
    .pill{display:inline-block;border:1px solid #27324f;padding:6px 10px;border-radius:999px;background:#0b1225;color:#c7d2fe;font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:8px;font-size:13px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    canvas{background:#0a1224;border:1px solid #1f2937;border-radius:12px;padding:8px}
    .kbd{background:#111827;border:1px solid #1f2937;padding:2px 6px;border-radius:6px;font-size:12px;color:#e5e7eb}
    .test-pass{color:#bbf7d0} .test-fail{color:#fecaca}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Yalnız Kredit Kalkulyatoru</h1>
    <div class="card">
      <div class="muted">Formul: <strong>Aylıq</strong> = (Məhsul dəyəri − Avtomatik <strong>İlkin ödəniş</strong>) ÷ Müddət. İlkin ödəniş iş yeri <strong>riskinə</strong> (və istəsən əməkhaqqına) görə avtomatik hesablanır.</div>
    </div>

    <section id="calc" class="card">
      <div class="row">
        <div class="col-3">
          <label>Məhsul dəyəri (AZN)</label>
          <input id="price" type="number" min="0" step="0.01" value="1000" />
        </div>
        <div class="col-3">
          <label>Müddət (ay)</label>
          <input id="months" type="number" min="1" step="1" value="12" />
        </div>
        <div class="col-3">
          <label>Risk qrupu</label>
          <select id="risk">
            <option value="low">Aşağı risk (A)</option>
            <option value="med" selected>Orta risk (B)</option>
            <option value="high">Yüksək risk (C)</option>
          </select>
        </div>
        <div class="col-3">
          <label>Aylıq əmək haqqı (AZN)</label>
          <input id="salary" type="number" min="0" step="1" value="800" />
        </div>
        <div class="col-3">
          <label>Hesablamanın qaydası</label>
          <select id="mode">
            <option value="riskOnly" selected>Yalnız risk qrupuna görə</option>
            <option value="riskSalary">Risk + əmək haqqına görə</option>
          </select>
        </div>
        <div class="col-12" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn primary" onclick="calc()">Hesabla (Enter)</button>
          <button class="btn" onclick="exportCSV()">CSV export</button>
          <span class="muted">Qısa yol: <span class="kbd">Enter</span></span>
        </div>
      </div>
    </section>

    <section class="card" id="summary"></section>
    <section class="card"><canvas id="chart" height="140"></canvas></section>
    <section class="card">
      <h3>Ödəniş cədvəli</h3>
      <div id="scheduleWrap" style="overflow:auto;max-height:360px"></div>
    </section>

    <section class="card">
      <h3>Daxili testlər</h3>
      <div class="muted">Modul sadələşdirildiyi üçün yalnız kalkulyatorla bağlı testlər saxlanılıb.</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
        <button class="btn" onclick="runTests()">Testləri işə sal</button>
        <span id="testSummary" class="muted"></span>
      </div>
      <div id="testResults" class="muted" style="margin-top:8px"></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // UTILITIES
    const fmtAZN = n=> (new Intl.NumberFormat('az-AZ',{style:'currency',currency:'AZN',maximumFractionDigits:2})).format(n||0);
    const toNum = id=> Number(document.getElementById(id).value||0);
    function setMode(val){ const el=document.getElementById('mode'); if(el) el.value = val; }

    // POLICY
    const POLICY = {
      low: [ {min:1500, pct:0.10}, {min:800, pct:0.15}, {min:500, pct:0.20}, {min:0, pct:0.30} ],
      med: [ {min:1500, pct:0.15}, {min:800, pct:0.20}, {min:500, pct:0.30}, {min:0, pct:0.40} ],
      high:[ {min:1500, pct:0.25}, {min:800, pct:0.35}, {min:500, pct:0.45}, {min:0, pct:0.60} ]
    };
    const POLICY_RISK_ONLY = { low: 0.20, med: 0.30, high: 0.50 };
    const MIN_DOWN_AZN = 50;

    function getDownPayment(price, riskKey, salary){
      const mode = (document.getElementById('mode')||{value:'riskOnly'}).value;
      let down = 0, pct = 0;
      if(mode==='riskOnly'){
        pct = POLICY_RISK_ONLY[riskKey] ?? POLICY_RISK_ONLY.med;
        down = price * pct;
      }else{
        const bands = POLICY[riskKey]||POLICY.med;
        const rule = bands.find(b=> salary >= b.min) || bands[bands.length-1];
        pct = rule.pct; down = price * pct;
      }
      if(down < MIN_DOWN_AZN) down = MIN_DOWN_AZN;
      if(down > price) down = price;
      return {down, pct, mode};
    }

    // CALCULATOR
    let chart, calcDoneOnce=false;
    function calc(){
      const price=toNum('price');
      const months=toNum('months');
      const risk=document.getElementById('risk').value;
      const salary=toNum('salary');
      if(months<=0){ alert('Müddət ən az 1 ay olmalıdır.'); return; }

      const {down, pct, mode} = getDownPayment(price, risk, salary);
      const principal = Math.max(0, price - down);
      const monthly = principal / months;

      // schedule
      let bal = principal;
      const rows=[]; const sd=new Date();
      for(let i=1;i<=months;i++){
        bal = Math.max(0, bal - monthly);
        const d=new Date(sd); d.setMonth(d.getMonth()+i);
        rows.push({i,date:d.toISOString().slice(0,10), monthly, principalPart:monthly, interest:0, bal});
      }

      // summary
      document.getElementById('summary').innerHTML = `
        <div class="row">
          <div class="col-3"><div class="pill">Məhsul dəyəri</div><h2>${fmtAZN(price)}</h2></div>
          <div class="col-3"><div class="pill">Avto. ilkin ödəniş</div><h2>${fmtAZN(down)} <span class="muted">(${(pct*100).toFixed(0)}%)</span><br><span class="muted">Rejim: ${mode==='riskOnly'?'Yalnız risk':'Risk + əməkhaqqı'}</span></h2></div>
          <div class="col-3"><div class="pill">Kredit məbləği</div><h2>${fmtAZN(principal)}</h2></div>
          <div class="col-3"><div class="pill">Aylıq ödəniş</div><h2>${fmtAZN(monthly)}</h2></div>
        </div>`;

      // table
      const table = [`<table><thead><tr><th>#</th><th>Tarix</th><th>Aylıq</th><th>Əsas</th><th>Faiz</th><th>Qalıq</th></tr></thead><tbody>`,
        rows.map(r=>`<tr><td>${r.i}</td><td>${r.date}</td><td>${fmtAZN(r.monthly)}</td><td>${fmtAZN(r.principalPart)}</td><td>${fmtAZN(r.interest)}</td><td>${fmtAZN(r.bal)}</td></tr>`).join(''),
        `</tbody></table>`].join('');
      document.getElementById('scheduleWrap').innerHTML = table;

      // chart
      const labels = rows.map(r=> r.i);
      const dataBal = rows.map(r=> Number(r.bal.toFixed(2)) );
      const ctx=document.getElementById('chart');
      if(chart) chart.destroy();
      chart = new Chart(ctx,{ type:'line', data:{ labels, datasets:[ {label:'Qalıq borc', data:dataBal} ] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } } });

      calcDoneOnce=true;
    }

    // ENTER shortcut
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') { e.preventDefault(); calc(); }
    });

    // CSV
    function buildCSVFromTableEl(table){
      const rows=[...table.querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.innerText));
      return rows.map(r=>r.join(',')).join('\n');
    }
    function exportCSV(){
      const table = document.querySelector('#scheduleWrap table');
      if(!table){ alert('Öncə hesablayın.'); return; }
      const csv = buildCSVFromTableEl(table);
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='odenis_cedveli.csv'; a.click();
    }

    // TESTS (only calculator-related)
    function runTests(){
      const results=[];
      const pass = name=>results.push(`<div class="test-pass">✓ ${name}</div>`);
      const fail = (name,exp,act)=>results.push(`<div class="test-fail">✗ ${name} — gözlənilən: ${exp}, alındı: ${act}</div>`);
      const approxEqual=(a,b,eps=1e-6)=> Math.abs(a-b)<=eps;

      // 1) riskOnly A/B/C
      try{
        setMode('riskOnly');
        let r = getDownPayment(1000,'low',1600); approxEqual(r.pct,0.20)? pass('riskOnly A 20%'): fail('riskOnly A pct','0.20',r.pct);
        r = getDownPayment(1000,'med',600);     approxEqual(r.pct,0.30)? pass('riskOnly B 30%'): fail('riskOnly B pct','0.30',r.pct);
        r = getDownPayment(400,'high',300);     approxEqual(r.pct,0.50)? pass('riskOnly C 50%'): fail('riskOnly C pct','0.50',r.pct);
      }catch(e){ fail('riskOnly testləri','exception yoxdur',e.message); }

      // 2) risk+salary bandı
      try{
        setMode('riskSalary');
        const r = getDownPayment(1000,'med',600); // 500–799 → 30%
        approxEqual(r.pct,0.30)? pass('risk+salary B (500–799) 30%'): fail('risk+salary B pct','0.30',r.pct);
      }catch(e){ fail('risk+salary testləri','exception yoxdur',e.message); }

      // 3) Monthly calc nümunəsi
      try{
        setMode('riskOnly');
        const price=1000, months=10; const {down}=getDownPayment(price,'low',2000); const monthly=(price-down)/months;
        approxEqual(monthly,80)? pass('Monthly = (1000-200)/10 = 80'): fail('Monthly','80',monthly);
      }catch(e){ fail('Monthly hesabı','exception yoxdur',e.message); }

      // 4) CSV builder newline & headers
      try{
        const tbl=document.createElement('table');
        tbl.innerHTML='<thead><tr><th>#</th><th>Tarix</th></tr></thead><tbody><tr><td>1</td><td>2025-09-13</td></tr></tbody>';
        const csv=buildCSVFromTableEl(tbl);
        (csv.includes('\n') && csv.includes('Tarix')) ? pass('CSV builder OK') : fail('CSV builder','newline + headers',csv);
      }catch(e){ fail('CSV builder','exception yoxdur',e.message); }

      // 5) Clamp: min və qiymətə
      try{
        setMode('riskOnly');
        const r = getDownPayment(40,'high',0);
        approxEqual(r.down,40)? pass('Down clamp to price (40)'): fail('Down clamp','40',r.down);
      }catch(e){ fail('Clamp test','exception yoxdur',e.message); }

      document.getElementById('testResults').innerHTML = results.join('');
      const ok = results.filter(r=>r.includes('test-fail')).length===0;
      document.getElementById('testSummary').textContent = ok? 'Bütün testlər keçdi.' : 'Bəzi testlər uğursuz oldu — yuxarıya baxın.';
    }

    // Auto-calc once on load
    window.addEventListener('load', ()=>{ if(!calcDoneOnce) calc(); });

    // expose needed fns
    Object.assign(window,{calc,exportCSV,runTests});
  </script>
</body>
</html>
