<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KREDİT KALKULYATORU</title>
  <style>
    :root{ 
      --bg:#f7f9fc; --text:#0f172a; --card:#ffffff; --border:#e7eaf0; --muted:#51607a; --primary:#dc2626;
      --pill-bg:#eef2ff; --pill-border:#c7d2fe; --input-bg:#ffffff; --input-border:#cfd5e1; --shadow:0 6px 18px rgba(2,6,23,.06);
      --radius:14px; --warn-bg:#fff1f2; --warn-border:#fecaca; --warn-text:#991b1b;
      --ok-bg:#f0fdf4; --ok-border:#bbf7d0; --ok-text:#14532d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:16px;line-height:1.55}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:center;gap:10px;margin:0 0 10px 0}
    header h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px;color:var(--primary)}

    h2{font-size:22px;font-weight:700;color:#111827;margin:6px 0 0}
    h3{font-size:18px;font-weight:700;color:#111827;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px;box-shadow:var(--shadow)}
    .row{display:grid;gap:14px}
    @media(min-width:720px){.row{grid-template-columns:repeat(12,1fr)}}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    label{font-size:13px;color:#334155;font-weight:600}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text)}
    .btn{border:1px solid #cbd5e1;background:#f1f5f9;color:#0f172a;padding:11px 16px;border-radius:12px;cursor:pointer;transition:.15s ease;box-shadow:var(--shadow);font-weight:700}
    .btn.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#15803d;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#b91c1c;color:#fff}
    .btn.ghost{background:#fff}
    .btn.primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border-color:#0284c7;color:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--pill-border);padding:6px 10px;border-radius:999px;background:var(--pill-bg);color:#3730a3;font-size:12px}
    .pill.risk-low{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .pill.risk-med{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .pill.risk-high{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .muted{color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:#f8fafc;padding:12px 10px;font-weight:700;font-size:14px;color:#111827;border-bottom:1px solid var(--border);text-align:right}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);font-size:13px;text-align:right}
    tbody tr:nth-child(odd){background:rgba(2,6,23,.02)}
    canvas{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .bar > span{display:block;height:100%;background:#22c55e}
    .bar.warn > span{background:#ef4444}
    .notice{padding:12px;border-radius:12px;margin-top:8px}
    .notice.warn{background:var(--warn-bg);border:1px solid var(--warn-border);color:var(--warn-text)}
    .notice.ok{background:var(--ok-bg);border:1px solid var(--ok-border);color:var(--ok-text)}
    .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.12)}
    .inline-check{display:flex;align-items:center;gap:6px;justify-content:flex-start}
    .inline-check label{margin:0}
    .inline-check .big-check{width:18px;height:18px;accent-color:#16a34a;transform:scale(1.15);transform-origin:left center;margin-right:2px}
    @media print{ .btn, #calc { display:none } .wrap{max-width:1000px} header{margin-bottom:0} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>KREDİT KALKULYATORU</h1>
    </header>

    <!-- KALKULYATOR (yeganə modul) -->
    <main id="view-calculator">
      <section id="calc" class="card">
        <div id="calcAlert" class="notice warn" style="display:none"></div>
        <div class="row">
          <!-- Müştəri və məhsul xanası ilkin mərhələdə gizlədildi (sonradan rəsmiləşdirmədə açılacaq) -->
          <div class="col-4">
            <label>Məhsul dəyəri (AZN)</label>
            <input id="price" type="number" min="0" step="0.01" value="1000" />
          </div>
          <div class="col-3">
            <label>Müddət (ay)</label>
            <select id="months">
              <option value="3">3</option>
              <option value="6">6</option>
              <option value="9">9</option>
              <option value="12" selected>12</option>
              <option value="15">15</option>
              <option value="18">18</option>
            </select>
          </div>
          <div class="col-3">
            <label>Risk qrupu</label>
            <select id="risk" required>
              <option value="">-- Seçin --</option>
              <option value="low">Aşağı risk (A)</option>
              <option value="med">Orta risk (B)</option>
              <option value="high">Yüksək risk (C)</option>
            </select>
          </div>
          <div class="col-3">
            <label>Aylıq əmək haqqı (AZN)</label>
            <input id="salary" type="number" min="1" step="1" value="" required />
          </div>
          <div class="col-3">
            <label>Digər öhdəliklər (AZN)</label>
            <input id="oblig" type="number" min="0" step="1" value="" required />
          </div>
          <div class="col-12 inline-check">
            <input class="big-check" type="checkbox" id="addIncomeChk" onchange="toggleExtraIncome()" />
            <label for="addIncomeChk">Əlavə gəlir var?</label>
          </div>
          <div class="col-3" id="addIncomeTypeWrap" style="display:none">
            <label>Əlavə gəlir növü</label>
            <select id="addIncomeType" disabled onchange="onIncomeTypeChange()">
              <option value="">-- Seçin --</option>
              <option value="muavinet">Müavinət</option>
              <option value="bonus">Bonus</option>
              <option value="kiraye">Kirayə gəliri</option>
              <option value="freelance">Freelance</option>
              <option value="parttime">Müvəqqəti əlavə iş</option>
            </select>
          </div>
          <div class="col-3" id="addIncomeAmtWrap" style="display:none">
            <label>Əlavə gəlir məbləği (AZN)</label>
            <input id="addIncomeAmt" type="number" min="1" step="1" value="" disabled />
          </div>
          <div class="col-12" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn success" onclick="calc()">Hesabla</button>
            <button class="btn danger" onclick="resetForm()">Sıfırla</button>
            <button class="btn ghost" onclick="exportPrint()">PDF (Çap)</button>
            <button class="btn primary" onclick="toggleFinalize()">Əlavə rəsmiləşdir</button>
          </div>

          <!-- Rəsmiləşdirmə formu (gizli) -->
          <div id="finalizeWrap" class="col-12" style="display:none">
            <div class="card" style="margin:8px 0">
              <h3>Rəsmiləşdirmə</h3>
              <div class="row">
                <div class="col-4">
                  <label>Müştəri adı</label>
                  <input id="custName" type="text" placeholder="Ad Soyad" />
                </div>
                <div class="col-4">
                  <label>Əlaqə nömrəsi</label>
                  <input id="custPhone" type="tel" placeholder="050 xxx xx xx" />
                </div>
                <div class="col-4">
                  <label>Məhsul adı/model</label>
                  <input id="prodName" type="text" placeholder="Telefon / Noutbuk ..." />
                </div>
                <div class="col-12" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
                  <button class="btn success" onclick="finalizeAndPrint()">Təsdiqlə və Çap et</button>
                  <button class="btn" onclick="toggleFinalize(false)">Bağla</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="layout">
        <section class="card" id="summary"></section>
        <section class="card">
          <h3>Ödəniş cədvəli</h3>
          <div id="scheduleWrap" style="overflow:auto;max-height:420px"></div>
        </section>
      </div>

      <section class="card"><canvas id="chart" height="220"></canvas></section>
    </main>
  </div>

  <!-- Chart.js yalnız kitabxanadır, öz kodumuz ayrıca script-dədir -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- Tətbiq skripti (BÜTÜN öz funksiyalarımız buradadır) -->
  <script>
    // ===== Utils
    const fmtAZN = n=> (new Intl.NumberFormat('az-AZ',{style:'currency',currency:'AZN',maximumFractionDigits:2})).format(n||0);
    const toNum = id=> Number((document.getElementById(id)?.value) ?? 0);

    // ===== Policy & limits
    const POLICY_RISK_ONLY = { low: 0.20, med: 0.30, high: 0.50 };
    const MIN_DOWN_AZN = 50;
    const MAX_OBLIG_SHARE = 0.50; // xəbərdarlıq
    const MAX_DSR = 0.40;         // sərt limit

    // Hesablamada istifadə olunan köməkçi
    function getDownPayment(price, riskKey, salary=0, oblig=0){
      const base = POLICY_RISK_ONLY[riskKey] ?? POLICY_RISK_ONLY.med;
      salary = Number(salary)||0; oblig = Number(oblig)||0;
      const net = Math.max(0, salary - oblig);
      const ratio = salary>0 ? net / salary : 0;
      let mod = 0;
      if(ratio >= 0.70) mod = -0.10; else if(ratio >= 0.50) mod = -0.05; else if(ratio >= 0.35) mod = 0.00; else if(ratio >= 0.20) mod = +0.10; else mod = +0.20;
      if(riskKey==='high') mod *= 0.7;
      const pct = Math.min(0.85, Math.max(0.10, base + mod));
      let down = price * pct;
      if(down < MIN_DOWN_AZN) down = MIN_DOWN_AZN;
      if(down > price) down = price;
      return { down, pct, base, ratio, net };
    }

    // Çap (hesab xülasəsi + cədvəl)
    function exportPrint(){
      const w=window.open('','_blank');
      const summary=document.getElementById('summary').innerHTML;
      const sched=document.getElementById('scheduleWrap').innerHTML;
      w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>Kredit Çap</title>
        <style>body{font-family:system-ui,Segoe UI,Roboto; padding:16px} h1{margin:0 0 8px} .muted{color:#64748b}
        table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:8px;text-align:right} th{text-align:right;background:#f8fafc}
        th:first-child,td:first-child{text-align:left}
        .block{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:8px 0}
        </style></head><body>
        <h1>Kredit hesablaması</h1>
        <div class='muted'>${new Date().toLocaleString('az-AZ')}</div>
        <div class='block'>${summary}</div>
        <div class='block'>${sched}</div>
      </body></html>`);
      w.document.close(); w.focus(); w.print();
    }

    // Əlavə gəlir UI
    function toggleExtraIncome(){
      const chk=document.getElementById('addIncomeChk');
      const typeWrap=document.getElementById('addIncomeTypeWrap');
      const amtWrap=document.getElementById('addIncomeAmtWrap');
      const typeSel=document.getElementById('addIncomeType');
      const amtInp=document.getElementById('addIncomeAmt');
      if(!chk||!typeWrap||!amtWrap||!typeSel||!amtInp) return;
      const on=!!chk.checked;
      typeWrap.style.display= on? 'block':'none';
      typeSel.disabled = !on; if(!on) typeSel.value='';
      amtWrap.style.display = 'none';
      amtInp.disabled = true; amtInp.value='';
    }
    function onIncomeTypeChange(){
      const typeSel=document.getElementById('addIncomeType');
      const amtWrap=document.getElementById('addIncomeAmtWrap');
      const amtInp=document.getElementById('addIncomeAmt');
      if(!typeSel||!amtWrap||!amtInp) return;
      if(typeSel.value){ amtWrap.style.display='block'; amtInp.disabled=false; }
      else { amtWrap.style.display='none'; amtInp.disabled=true; amtInp.value=''; }
    }

    let chart=null;

    // Əsas hesabla
    function calc(){
      ['risk','salary','oblig','addIncomeType','addIncomeAmt'].forEach(id=>document.getElementById(id)?.classList.remove('invalid'));
      const riskEl=document.getElementById('risk');
      const salaryEl=document.getElementById('salary');
      const obligEl=document.getElementById('oblig');
      const chk=document.getElementById('addIncomeChk');
      const typeSel=document.getElementById('addIncomeType');
      const amtInp=document.getElementById('addIncomeAmt');

      const risk=riskEl?.value||''; const salaryStr=salaryEl?.value||''; const obligStr=obligEl?.value||'';
      if(!risk || salaryStr==='' || obligStr===''){
        const msgs=[];
        if(!risk){ riskEl.classList.add('invalid'); msgs.push('Risk qrupunu seçin.'); }
        if(salaryStr===''){ salaryEl.classList.add('invalid'); msgs.push('Aylıq əmək haqqını daxil edin.'); }
        if(obligStr===''){ obligEl.classList.add('invalid'); msgs.push('Digər öhdəlikləri daxil edin.'); }
        const alertBox=document.getElementById('calcAlert');
        if(alertBox){ alertBox.style.display='block'; alertBox.innerHTML = msgs.map(m=>`• ${m}`).join('<br>'); }
        (riskEl||salaryEl||obligEl)?.scrollIntoView({behavior:'smooth',block:'center'});
        return;
      }

      let extra=0; let extraDesc='';
      if(chk?.checked){
        if(!typeSel.value){ typeSel.classList.add('invalid'); const a=document.getElementById('calcAlert'); if(a){a.style.display='block'; a.textContent='Əlavə gəlir növünü seçin.';} return; }
        extraDesc = typeSel.options[typeSel.selectedIndex].text;
        if(amtInp.value===''){ amtInp.classList.add('invalid'); const a=document.getElementById('calcAlert'); if(a){a.style.display='block'; a.textContent='Əlavə gəlir məbləğini daxil edin.';} return; }
        extra = Math.max(0, Number(amtInp.value)||0);
        if(extra<=0){ amtInp.classList.add('invalid'); const a=document.getElementById('calcAlert'); if(a){a.style.display='block'; a.textContent='Əlavə gəlir məbləği 0-dan böyük olmalıdır.';} return; }
      }

      const price=toNum('price');
      const months=toNum('months');
      const salary=Number(document.getElementById('salary').value||0) + extra;
      const oblig=Number(document.getElementById('oblig').value||0);
      if(months<=0){ const a=document.getElementById('calcAlert'); if(a){a.style.display='block'; a.textContent='Müddət ən az 1 ay olmalıdır.';} return; }

      const dti = (salary>0)? (oblig/salary) : (oblig>0? Infinity : 0);
      const dtiWarn = dti > MAX_OBLIG_SHARE;

      const baseRes = getDownPayment(price, risk, salary, oblig);
      let down = baseRes.down; let pct = baseRes.pct; const base = baseRes.base; const ratio = baseRes.ratio; const net = baseRes.net;
      let principal = Math.max(0, price - down);
      let monthly = months>0 ? principal / months : 0;

      const maxMonthly = Math.max(0, net * MAX_DSR);
      const needsAdj = monthly > maxMonthly + 1e-9;
      let autoAdj = false, prevDown = down, prevMonthly = monthly;
      if(needsAdj){
        const requiredPrincipal = Math.max(0, maxMonthly * months);
        const newDownRaw = price - requiredPrincipal;
        down = Math.min(price, Math.max(MIN_DOWN_AZN, Math.max(prevDown, newDownRaw)));
        pct = price>0 ? (down/price) : 0;
        principal = Math.max(0, price - down);
        monthly = months>0 ? principal / months : 0;
        autoAdj = true;
      }

      let bal = principal; const rows=[]; const sd=new Date();
      for(let i=1;i<=months;i++){
        bal=Math.max(0,bal-monthly);
        const d=new Date(sd); d.setMonth(d.getMonth()+i);
        rows.push({i,date:d.toISOString().slice(0,10),monthly,bal});
      }

      const riskCls = risk==='low'?'risk-low':(risk==='high'?'risk-high':'risk-med');
      const dtiHtml = dtiWarn
        ? `<div class="notice warn">Diqqət: Öhdəlik/Gəlir = ${(dti*100).toFixed(0)}% (hədd ${Math.round(MAX_OBLIG_SHARE*100)}%). Yüksək risk göstəricisi.</div>`
        : '';
      const extraHtml = extra>0 ? `<div class="pill">Əlavə gəlir: ${extraDesc} — ${fmtAZN(extra)}</div>` : '';

      document.getElementById('calcAlert').style.display='none';
      document.getElementById('summary').innerHTML=`
        <h3>Xülasə</h3>
        ${dtiHtml}
        <div class="row">
          <div class="col-6"><div class="pill ${riskCls}">Risk: ${risk.toUpperCase()}</div>${extraHtml}<h2>${fmtAZN(price)}</h2><div class="muted">Məhsul dəyəri</div></div>
          <div class="col-6"><div class="pill">İlkin ödəniş</div>
            <h2>${fmtAZN(down)} <span class="muted">(${(pct*100).toFixed(0)}%)</span></h2>
            ${autoAdj?`<div class="notice ok">DSR həddinə görə ilkin ödəniş <strong>avtomatik artırılıb</strong>. Əvvəl: ${fmtAZN(prevDown)}, Aylıq: ${fmtAZN(prevMonthly)} → ${fmtAZN(monthly)}</div>`:''}
          </div>
          <div class="col-6"><div class="pill">Kredit</div><h2>${fmtAZN(principal)}</h2></div>
          <div class="col-6"><div class="pill">Aylıq</div><h2>${fmtAZN(monthly)}</h2></div>
          <div class="col-12"><div class="muted">Risk baza payı: ${(base*100).toFixed(0)}% • Net gəlir: ${fmtAZN(net)} (${(ratio*100).toFixed(0)}%)</div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col-12">
            <div class="muted">Borclanma yükü (DSR) — aylıq ödəniş / net gəlir</div>
            <div class="bar ${monthly>maxMonthly?'warn':''}"><span style="width:${Math.min(100, net? (monthly/net)*100 : 0)}%"></span></div>
            <div class="muted" style="margin-top:4px">Maks. aylıq icazə verilən: <strong>${fmtAZN(maxMonthly)}</strong></div>
          </div>
        </div>`;

      document.getElementById('scheduleWrap').innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Tarix</th><th>Aylıq</th><th>Qalıq</th></tr></thead>
          <tbody>
            ${rows.map(r=>`<tr><td>${r.i}</td><td>${r.date}</td><td>${fmtAZN(r.monthly)}</td><td>${fmtAZN(r.bal)}</td></tr>`).join('')}
          </tbody>
        </table>`;

      const labels=rows.map(r=>r.i); const dataBal=rows.map(r=>Number(r.bal.toFixed(2)));
      const ctx=document.getElementById('chart'); if(chart) chart.destroy();
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Qalıq borc',data:dataBal}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},elements:{line:{tension:.25}}}});
    }

    function resetForm(){
      ['price','months','risk','salary','oblig','addIncomeType','addIncomeAmt','custName','custPhone','prodName'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        if(id==='months') el.value=3; else if(id==='risk' || id==='addIncomeType') el.value=''; else el.value='';
        el.classList.remove('invalid');
      });
      const chk=document.getElementById('addIncomeChk');
      const typeWrap=document.getElementById('addIncomeTypeWrap');
      const amtWrap=document.getElementById('addIncomeAmtWrap');
      const typeSel=document.getElementById('addIncomeType');
      const amtInp=document.getElementById('addIncomeAmt');
      if(chk){ chk.checked=false; }
      if(typeWrap){ typeWrap.style.display='none'; }
      if(amtWrap){ amtWrap.style.display='none'; }
      if(typeSel){ typeSel.disabled=true; }
      if(amtInp){ amtInp.disabled=true; }

      const alertBox=document.getElementById('calcAlert'); if(alertBox){ alertBox.style.display='none'; alertBox.textContent=''; }
      document.getElementById('summary').innerHTML="";
      document.getElementById('scheduleWrap').innerHTML="";
      if(chart){ chart.destroy(); chart=null; }
    }

    // === Rəsmiləşdirmə UI ===
    function toggleFinalize(force){
      const box=document.getElementById('finalizeWrap');
      if(!box) return;
      const show = typeof force==='boolean' ? force : (box.style.display==='none');
      box.style.display = show? 'block' : 'none';
      if(show){ box.scrollIntoView({behavior:'smooth',block:'center'}); }
    }

    function computeForDocs(){
      // Kalkulyator dəyərlərini hesablamaq üçün (render etmədən)
      const risk=document.getElementById('risk').value;
      const salaryStr=document.getElementById('salary').value;
      const obligStr=document.getElementById('oblig').value;
      const price=toNum('price');
      const months=toNum('months');
      if(!risk || salaryStr==='' || obligStr==='' || months<=0){
        throw new Error('Zəhmət olmasa risk, əmək haqqı, öhdəliklər və müddəti düzgün daxil edin.');
      }
      const chk=document.getElementById('addIncomeChk');
      const extra = chk?.checked ? Math.max(0, Number(document.getElementById('addIncomeAmt').value||0)) : 0;
      const salary=Number(salaryStr)+extra;
      const oblig=Number(obligStr)||0;

      const baseRes = getDownPayment(price, risk, salary, oblig);
      let down = baseRes.down; let pct = baseRes.pct; const net = baseRes.net; const base = baseRes.base; const ratio = baseRes.ratio;
      let principal = Math.max(0, price - down);
      let monthly = months>0 ? principal / months : 0;
      const maxMonthly = Math.max(0, net * MAX_DSR);
      if(monthly>maxMonthly){
        const requiredPrincipal = Math.max(0, maxMonthly * months);
        const newDownRaw = price - requiredPrincipal;
        down = Math.min(price, Math.max(MIN_DOWN_AZN, Math.max(down, newDownRaw)));
        pct = price>0 ? (down/price) : 0;
        principal = Math.max(0, price - down);
        monthly = months>0 ? principal / months : 0;
      }
      let bal=principal; const rows=[]; const sd=new Date();
      for(let i=1;i<=months;i++){ bal=Math.max(0,bal-monthly); const d=new Date(sd); d.setMonth(d.getMonth()+i); rows.push({i,date:d.toISOString().slice(0,10),monthly,bal}); }
      return {price, months, risk, salary, oblig, down, pct, principal, monthly, base, ratio, net, schedule:rows};
    }

    function openPrintDocCombined(title, sectionsHtml){
      const w=window.open('','_blank');
      w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>${title}</title>
      <style>body{font-family:system-ui,Segoe UI,Roboto;padding:18px} h1{margin:0 0 8px}
      h2{margin:16px 0 6px} .muted{color:#64748b} table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #e5e7eb;padding:8px;text-align:left} th{text-align:left;background:#f8fafc}
      .block{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:10px 0}
      .page{page-break-after:always}
      </style></head><body>${sectionsHtml}</body></html>`);
      w.document.close(); w.focus(); w.print();
    }

    function finalizeAndPrint(){
      // 1) Müştəri & satış məlumat validasiyası
      const custName=(document.getElementById('custName')?.value||'').trim();
      const custPhone=(document.getElementById('custPhone')?.value||'').trim();
      const prodName=(document.getElementById('prodName')?.value||'').trim();
      ['custName','custPhone','prodName'].forEach(id=>document.getElementById(id)?.classList.remove('invalid'));
      const errs=[]; if(!custName) {document.getElementById('custName').classList.add('invalid'); errs.push('Müştəri adı');}
      if(!custPhone){document.getElementById('custPhone').classList.add('invalid'); errs.push('Əlaqə nömrəsi');}
      if(!prodName){document.getElementById('prodName').classList.add('invalid'); errs.push('Məhsul adı');}
      if(errs.length){ alert('Zəhmət olmasa doldurun: '+errs.join(', ')); return; }

      // 2) Kalkulyasiya dəyərlərini hesablamaq
      try{ calc(); }catch(e){}
      let c; try{ c = computeForDocs(); }catch(e){ alert(e.message); return; }

      // 3) Sənədləri hazırlayıb tək pəncərədə çap
      const contract=`<div class='page'>
        <h1 style='text-transform:uppercase'>MÜDDƏTLİ (NİSYƏ) ALQI-SATQI MÜQAVİLƏSİ №</h1>
        <div class='muted'>Bakı şəhəri — Tarix: ${new Date().toLocaleDateString('az-AZ')}</div>
        <div class='block'>
          Bir tərəfdən Azərbaycan Respublikasının qanunları və Normativ aktları əsasında öz nizamnaməsi ilə fəaliyyət göstərən
          <strong>“Baktel Electronics” Məhdud Məsuliyyətli Cəmiyyəti</strong> (bundan sonra “Satıcı firma”),
          digər tərəfdən isə şəxsiyyətini təsdiq edən sənədin (seriya/nömrə: <em>—</em>) sahibi
          <strong>${custName || '—'}</strong> (bundan sonra “Alıcı”) arasında aşağıdakılar barədə müqavilə bağlanıldı.
        </div>

        <h2>1. MÜQAVİLƏNİN PREDMETİ</h2>
        <div class='block'>
          Bakı şəhəri, Nəsimi rayonu, Nizami küçəsi ünvanında yerləşən “Baktel Electronics” MMC ilə qeydiyyatda olan
          <strong>${custName || '—'}</strong> arasında tərtib edilmiş <strong>${new Date().toLocaleDateString('az-AZ')}</strong> tarixli
          <strong>${('ST'+new Date().getFullYear()+'/'+String(Date.now()).slice(-3))}</strong> saylı hesab-qaiməsinə əsasən
          şirkət tərəfindən dəyərinin qalan hissəsini müəyyən müddət ərzində ödəmək şərtilə aşağıdakı mal nisyə satılır:
          <br/><br/>
          <table style='width:100%; border-collapse:collapse'>
            <tr><th style='text-align:left'>Məhsulun adı</th><td>${prodName || '—'}</td></tr>
            <tr><th style='text-align:left'>İlkin ödəniş məbləği</th><td>${fmtAZN(c.down)}</td></tr>
            <tr><th style='text-align:left'>Kredit məbləği</th><td>${fmtAZN(c.principal)}</td></tr>
            <tr><th style='text-align:left'>Kreditin müddəti</th><td>${c.months} ay</td></tr>
            <tr><th style='text-align:left'>Aylıq ödəniş məbləği</th><td>${fmtAZN(c.monthly)}</td></tr>
          </table>
        </div>

        <h2>2. TƏRƏFLƏRİN HÜQUQLARI VƏ VƏZİFƏLƏRİ</h2>
        <div class='block'>
          <strong>2.1. “Satıcı firma” aşağıdakıları öz öhdəsinə götürür:</strong><br/>
          2.1.1. “Alıcının” nisyə aldığı mala görə birdəfəlik haqqın hesablanmasının və tutulmasının düzgünlüyünə riayət etmək.<br/>
          2.1.2. Bu müqavilə ilə bağlı konfidensiallığı qorumaq.<br/>
          <br/>
          <strong>2.2. “Alıcı” aşağıdakıları öz öhdəsinə götürür:</strong><br/>
          2.2.1. Bu müqavilə üzrə bütün ödənişləri vaxtında həyata keçirmək (birdəfəlik haqq və aylıq ödənişlər “Satıcı” firmanın
          xəzinəsinə daxil olduqdan sonra yerinə yetirilmiş hesab edilir).<br/>
          2.2.2. “Alıcı”nın nisyə alınmış əşyanın sənədlərində dəyişiklik olduqda (ünvan, iş yeri və s.) 3 (üç) təqvim günü ərzində
          “Satıcı firma”ya yazılı surətdə xəbər vermək.<br/>
          2.2.3. “Satıcı firma”nın tələbi ilə “Alıcı”nın maliyyə durumunu müəyyən etməyə şərait yaratmaq.<br/>
          2.2.4. Bu müqavilə ilə bağlı məlumatların konfidensiallığını qorumaq.<br/>
          <br/>
          <strong>2.3. “Satıcı firma”nın hüquqları:</strong><br/>
          2.3.1. “Alıcı” şərtləri pozduqda müqaviləni vaxtından əvvəl ləğv etməyi və borcun dərhal ödənilməsini tələb etmək.<br/>
          <br/>
          <strong>2.4. “Alıcı”nın hüquqları:</strong><br/>
          2.4.1. “Satıcı”nın razılığı ilə əşyanın dəyərini qismən və ya bir dəfəyə vaxtından əvvəl qaytarmaq.
        </div>

        <h2>3. TƏRƏFLƏRİN MƏSULİYYƏTİ</h2>
        <div class='block'>
          3.1. Aylıq ödəniş gecikərsə, gecikilən hər gün üçün qrafikə uyğun aylıq ödəniş məbləğinin 3%-i cərimə tətbiq oluna bilər.<br/>
          3.2. “Alıcı” aylıq ödənişi 5 gün gecikdirərsə, “Satıcı” borcun vaxtından əvvəl ödənilməsini tələb edə bilər.<br/>
          3.3. “Alıcı” aylıq ödənişi 1 ay gecikdirərsə, “Satıcı” nisyə alınmış məhsulun IMEI qeydiyyatına məhdudiyyət qoya bilər.
        </div>

        <h2>4. YEKUN MÜDDƏALAR</h2>
        <div class='block'>
          Bu müqavilə hər iki tərəf imzaladıqdan sonra qüvvəyə minir və öhdəliklər tam yerinə yetirilənədək qüvvədə olur. Müqavilə 2 (iki)
          eyni nüsxədə tərtib edilmişdir. Mübahisələr Azərbaycan Respublikasının qüvvədə olan qanunvericiliyi ilə tənzimlənir.
        </div>

        <div class='block'>
          <table style='width:100%'>
            <tr>
              <td style='vertical-align:top; width:50%'>
                <strong>Satıcı:</strong><br/>
                “Baktel Electronics” MMC<br/>
                Ünvan: Bakı şəhəri, Nəsimi rayonu, Nizami küç., 187<br/>
                VÖEN: 1505350851<br/>
                İmza: __________________
              </td>
              <td style='vertical-align:top; width:50%'>
                <strong>Alıcı:</strong><br/>
                A.S.A.: ${custName || '—'}<br/>
                Ş/V seriya və nömrəsi: —<br/>
                Ünvan: —<br/>
                İmza: __________________
              </td>
            </tr>
          </table>
        </div>
      </div>`;

      const scheduleRows=c.schedule.map(r=>`<tr><td>${r.i}</td><td>${r.date}</td><td style='text-align:right'>${fmtAZN(r.monthly)}</td><td style='text-align:right'>${fmtAZN(r.bal)}</td></tr>`).join('');
      const schedule=`<div class='page'>
        <h1>Ödəniş cədvəli</h1>
        <div class='muted'>Müştəri: ${custName} • Məhsul: ${prodName}</div>
        <div class='block'><table><thead><tr><th>#</th><th>Tarix</th><th>Aylıq</th><th>Qalıq</th></tr></thead><tbody>${scheduleRows}</tbody></table></div>
      </div>`;

      const warranty=`<div class='page'>
        <h1>Zəmanət talonu</h1>
        <div class='block'>
          <strong>Müştəri:</strong> ${custName}<br/>
          <strong>Əlaqə:</strong> ${custPhone}<br/>
          <strong>Məhsul:</strong> ${prodName}<br/>
          <strong>Satış tarixi:</strong> ${new Date().toLocaleDateString('az-AZ')}<br/>
          <strong>Zəmanət müddəti:</strong> 12 ay (standart)
        </div>
        <div class='block'><strong>Qaydalar:</strong><br/>Mexaniki zədələr, suya düşmə və s. zəmanətə daxil deyil. Qüsur aşkarlanarsa, servis mərkəzinə müraciət edin.</div>
      </div>`;

      openPrintDocCombined('Sənədlər', contract + schedule + warranty);
    }

    // Qlobal çıxar (onclick üçün)
    window.calc=calc;
    window.resetForm=resetForm;
    window.exportPrint=exportPrint;
    window.toggleExtraIncome=toggleExtraIncome;
    window.onIncomeTypeChange=onIncomeTypeChange;
    window.toggleFinalize=toggleFinalize;
    window.finalizeAndPrint=finalizeAndPrint;
  </script>
</body>
</html>
