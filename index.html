<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biznes Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --details-color: #8b5cf6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-main: #f3f4f6;
            --bg-content: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            font-size: 14px;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sidebar {
            width: 260px;
            height: 100vh;
            position: fixed;
            background: var(--bg-content);
            border-right: 1px solid var(--border-color);
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
        }
        .sidebar .logo {
            text-align: center;
            padding: 0 0 32px 0;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
        }
        .sidebar nav {
            flex-grow: 1;
        }
        .sidebar nav ul {
            list-style: none;
        }
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            margin: 6px 16px;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
        }
        .sidebar nav li a:hover {
            background: #f1f5f9;
            color: var(--primary-color);
        }
        .sidebar nav li a.active {
            background: #eef2ff;
            color: var(--primary-color);
            font-weight: 600;
        }
        .sidebar nav li a svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }
        .main-content {
            margin-left: 260px;
            width: calc(100% - 260px);
            padding: 32px;
            height: 100vh;
            overflow-y: auto;
        }
        .page-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
        }
        .search-container {
            position: relative;
        }
        .search-container svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }
        .search-input {
            min-width: 300px;
            padding: 12px 16px 12px 48px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-content);
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .content-area {
            background: var(--bg-content);
            border: 1px solid var(--border-color);
            padding: 32px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .btn svg {
            width: 18px;
            height: 18px;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        .btn-success:hover {
            background-color: #0c9c6f;
        }
        .btn-danger {
            background-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #cc3636;
        }
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-primary);
        }
        .btn-warning:hover {
            background-color: #d88a07;
        }
        .actions-cell {
            text-align: right;
        }
        .actions-cell button {
            padding: 10px;
            margin-left: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            background: transparent;
            transition: background-color 0.2s;
        }
        .actions-cell button:hover {
            background-color: #e9ecef;
        }
        .btn-edit {
            color: var(--warning-color);
        }
        .btn-delete {
            color: var(--danger-color);
        }
        .btn-details {
            color: var(--details-color);
        }
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .data-table th,
        .data-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }
        .data-table tbody tr:hover {
            background-color: #f9fafb;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--bg-content);
            padding: 40px;
            border-radius: 16px;
            width: 700px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 32px;
            cursor: pointer;
            color: #adb5bd;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-main);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .form-actions {
            text-align: right;
            margin-top: 30px;
        }
        .sale-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 24px;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }
        .card {
            background: var(--bg-content);
            padding: 32px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .card h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .card p {
            margin: 0;
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .positive {
            color: var(--success-color) !important;
        }
        .negative {
            color: var(--danger-color) !important;
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            padding: 6px;
            background: #e9ecef;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .view-toggle button {
            flex: 1;
            padding: 10px 18px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .view-toggle button.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 1.4em;
            border-bottom: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">BİZNES PANEL</div>
        <nav id="sidebar-nav"><ul>
            <li><a data-page="finance" class="active"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> <span>Maliyyə</span></a></li>
            <li><a data-page="reports"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6m-6-10h6m-6 4h6m0 0v6a2 2 0 002 2h2a2 2 0 002-2v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2z"></path></svg> <span>Hesabatlar</span></a></li>
            <li><a data-page="sales"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> <span>Satış Etmək</span></a></li>
            <li><a data-page="purchases"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg> <span>Mal Alışı</span></a></li>
            <li><a data-page="products"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg> <span>Məhsullar</span></a></li>
            <li><a data-page="customers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-1-3.794M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>Müştərilər</span></a></li>
            <li><a data-page="suppliers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg> <span>Təchizatçılar</span></a></li>
        </ul></nav>
    </div>

    <main class="main-content" id="app-container">
    </main>
    
    <div id="addProductModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Yeni Məhsul</h2><form id="addProductForm"><div class="form-group"><label for="productNameModal">Məhsul Adı</label><input type="text" id="productNameModal" required></div><div class="form-group"><label for="purchasePriceModal">Alış Qiyməti (₼)</label><input type="number" id="purchasePriceModal" step="0.01" required></div><div class="form-group"><label for="salePriceModal">Satış Qiyməti (₼)</label><input type="number" id="salePriceModal" step="0.01" required></div><div class="form-group"><label for="stockQuantityModal">Anbar Sayı</label><input type="number" id="stockQuantityModal" required></div><div class="form-actions"><button type="submit" class="btn btn-primary">Yadda Saxla</button></div></form></div></div>
    <div id="editProductModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Məhsulu Redaktə Et</h2><form id="editProductForm"><input type="hidden" id="editProductId"><div class="form-group"><label for="editProductName">Məhsul Adı</label><input type="text" id="editProductName" required></div><div class="form-group"><label for="editPurchasePrice">Alış Qiyməti (₼)</label><input type="number" id="editPurchasePrice" step="0.01" required></div><div class="form-group"><label for="editSalePrice">Satış Qiyməti (₼)</label><input type="number" id="editSalePrice" step="0.01" required></div><div class="form-group"><label for="editStockQuantity">Anbar Sayı</label><input type="number" id="editStockQuantity" required></div><div class="form-actions"><button type="submit" class="btn btn-primary">Dəyişikliyi Saxla</button></div></form></div></div>
    <div id="addCustomerModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Yeni Müştəri</h2><form id="addCustomerForm"><div class="form-group"><label for="customerNameModal">Tam Adı</label><input type="text" id="customerNameModal" required></div><div class="form-group"><label for="customerPhoneModal">Telefon Nömrəsi</label><input type="text" id="customerPhoneModal" required></div><div class="form-actions"><button type="submit" class="btn btn-primary">Yadda Saxla</button></div></form></div></div>
    <div id="editCustomerModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Müştərini Redaktə Et</h2><form id="editCustomerForm"><input type="hidden" id="editCustomerId"><div class="form-group"><label for="editCustomerName">Tam Adı</label><input type="text" id="editCustomerName" required></div><div class="form-group"><label for="editCustomerPhone">Telefon Nömrəsi</label><input type="text" id="editCustomerPhone" required></div><div class="form-actions"><button type="submit" class="btn btn-primary">Dəyişikliyi Saxla</button></div></form></div></div>
    <div id="addSupplierModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Yeni Təchizatçı</h2><form id="addSupplierForm"><div class="form-group"><label for="supplierNameModal">Təchizatçı Adı</label><input type="text" id="supplierNameModal" required></div><div class="form-group"><label for="supplierPhoneModal">Telefon</label><input type="text" id="supplierPhoneModal"></div><div class="form-actions"><button type="submit" class="btn btn-primary">Yadda Saxla</button></div></form></div></div>
    <div id="editSupplierModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Təchizatçını Redaktə Et</h2><form id="editSupplierForm"><input type="hidden" id="editSupplierId"><div class="form-group"><label for="editSupplierName">Təchizatçı Adı</label><input type="text" id="editSupplierName" required></div><div class="form-group"><label for="editSupplierPhone">Telefon</label><input type="text" id="editSupplierPhone"></div><div class="form-actions"><button type="submit" class="btn btn-primary">Dəyişikliyi Saxla</button></div></form></div></div>
    <div id="saleDetailsModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Satış Detalları</h2><div id="saleDetailsContent" style="margin-top: 20px;"></div></div></div>
    <div id="acceptPaymentModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Müştəri Ödənişi Qəbul Et</h2><form id="acceptPaymentForm"><div class="form-group"><label>Müştəri</label><select id="paymentCustomerSelect" required></select></div><div class="form-group"><label>Ödənilən Məbləğ (₼)</label><input type="number" id="paymentAmount" step="0.01" required></div><div class="form-actions"><button type="submit" class="btn btn-success">Ödənişi Qəbul Et</button></div></form></div></div>
    <div id="addExpenseModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Xərc Əlavə Et</h2><form id="addExpenseForm"><div class="form-group"><label>Xərcin Təsviri</label><textarea id="expenseDescription" rows="3" required></textarea></div><div class="form-group"><label>Məbləğ (₼)</label><input type="number" id="expenseAmount" step="0.01" required></div><div class="form-actions"><button type="submit" class="btn btn-danger">Xərci Əlavə Et</button></div></form></div></div>
    <div id="paySupplierModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2>Təchizatçıya Ödəniş</h2><form id="paySupplierForm"><div class="form-group"><label>Təchizatçı</label><select id="paymentSupplierSelect" required></select></div><div class="form-group"><label>Ödənilən Məbləğ (₼)</label><input type="number" id="supplierPaymentAmount" step="0.01" required></div><div class="form-actions"><button type="submit" class="btn btn-warning">Ödənişi Et</button></div></form></div></div>
    <div id="customerSalesHistoryModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 id="customer-history-title">Müştəri Satış Tarixçəsi</h2><div id="customerSalesHistoryContent" style="margin-top: 20px;"><table class="data-table" style="width:100%;"><thead><tr><th>#ID</th><th>Tarix</th><th>Növ</th><th>Məbləğ</th><th></th></tr></thead><tbody id="customer-sales-history-table-body"></tbody></table></div></div></div>

    <template id="finance-page-template"><div class="page-container"><div class="page-header"><h1>Maliyyə</h1><button id="btnBackupData" class="btn btn-primary"><span>Məlumatları Yüklə (Backup)</span></button></div><div class="summary-cards"><div class="card"><h3>Cari Kassa Balansı</h3><p id="current-cash-balance">0.00 ₼</p></div><div class="card"><h3>Müştəri Borcları</h3><p id="total-receivables" class="positive">0.00 ₼</p></div><div class="card"><h3>Təchizatçı Borcları</h3><p id="total-payables" class="negative">0.00 ₼</p></div></div><div class="content-area"><div class="page-header"><h2>Son Əməliyyatlar</h2></div><div class="finance-actions" style="margin-bottom: 20px;"><button id="btnAcceptPayment" class="btn btn-success"><span>Ödəniş Qəbul Et</span></button><button id="btnAddExpense" class="btn btn-danger"><span>Xərc Əlavə Et</span></button><button id="btnPaySupplier" class="btn btn-warning"><span>Təchizatçıya Ödə</span></button></div><table class="data-table"><thead><tr><th>Tarix</th><th>Növ</th><th>Açıqlama</th><th>Məbləğ</th></tr></thead><tbody id="transactionsTableBody"></tbody></table></div></div></template>
    <template id="reports-page-template"><div class="page-container"><div class="page-header"><h1>Hesabatlar</h1></div><div class="content-area"><div class="view-toggle"><button id="viewAllSalesBtn" class="active">Bütün Satışlar</button><button id="viewByCustomerBtn">Müştərilər Üzrə</button></div><div id="all-sales-view" class="report-view active"><div class="page-header" style="padding: 16px 0 0 0;"><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="salesReportSearch" class="search-input" placeholder="Müştəri və ya məbləğə görə axtar..."></div></div><table class="data-table"><thead><tr><th>#ID</th><th>Tarix</th><th>Müştəri</th><th>Növ</th><th>Yekun Məbləğ</th><th></th></tr></thead><tbody id="salesHistoryTableBody"></tbody></table></div><div id="by-customer-view" class="report-view"><div class="page-header" style="padding: 16px 0 0 0;"><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="customerReportSearch" class="search-input" placeholder="Müştəri adına görə axtar..."></div></div><table class="data-table"><thead><tr><th>Müştəri Adı</th><th>Satış Sayı</th><th>Ümumi Dövriyyə</th><th></th></tr></thead><tbody id="customerSalesSummaryTableBody"></tbody></table></div></div></div></template>
    <template id="sales-page-template"><div class="page-container"><div class="page-header"><h1>Satış Etmək</h1></div><form id="saleForm"><div class="sale-container"><div class="content-area"><h4>1. Müştəri və Məhsul seçimi</h4><div class="form-group"><label for="saleCustomer">Müştəri Seçin</label><select id="saleCustomer" required></select></div><div class="form-group"><label for="saleProduct">Məhsul Əlavə Et</label><select id="saleProduct"></select></div><table class="data-table"><thead><tr><th>Məhsul</th><th>Say</th><th>Qiymət</th><th>Toplam</th><th></th></tr></thead><tbody id="cartTableBody"></tbody></table></div><div class="content-area"><h4>2. Satışı Yekunlaşdır</h4><div class="form-group"><label>Satış Növünü Seçin</label><div class="sale-type-buttons"><button type="button" class="btn sale-type-btn active" data-type="Nağd">Nağd</button><button type="button" class="btn sale-type-btn" data-type="POS Terminal">POS</button><button type="button" class="btn sale-type-btn" data-type="Kredit">Kredit</button><button type="button" class="btn sale-type-btn" data-type="Korporativ">Korporativ</button></div></div><div class="form-group" id="initialPaymentGroup"><label for="initialPayment">İlkin Ödəniş (₼)</label><input type="number" id="initialPayment" value="0" step="0.01"></div><div class="summary-row"><span>Yekun Məbləğ:</span><span id="summaryTotal">0.00 ₼</span></div><div class="summary-row" id="debt-row" style="display:none;"><span>Borc qalığı:</span><span id="debt-total">0.00 ₼</span></div><div class="form-actions"><button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 16px;"><span>Satışı Tamamla</span></button></div></div></div></form></div></template>
    <template id="purchases-page-template"><div class="page-container"><div class="page-header"><h1>Yeni Mal Alışı</h1></div><form id="purchaseForm"><div class="sale-container"><div class="content-area"><h4>1. Təchizatçı və Məhsul seçimi</h4><div class="form-group"><label>Təchizatçı Seçin</label><select id="purchaseSupplierSelect" required></select></div><div class="form-group"><label>Məhsul Əlavə Et</label><select id="purchaseProductSelect"></select></div><table class="data-table"><thead><tr><th>Məhsul</th><th>Say</th><th>Alış Qiyməti</th><th>Toplam</th><th></th></tr></thead><tbody id="purchaseCartTableBody"></tbody></table></div><div class="content-area"><h4>2. Alışı Yekunlaşdır</h4><div class="summary-row total" style="margin-top: 24px;"><span>Yekun Məbləğ:</span><span id="purchaseTotal">0.00 ₼</span></div><div class="form-actions"><button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 16px;"><span>Alışı Tamamla</span></button></div></div></div></form></div></template>
    <template id="products-page-template"><div class="page-container"><div class="page-header"><h1>Məhsullar</h1><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="productSearch" class="search-input" placeholder="Məhsul adı və ya ID ilə axtar..."></div><button id="addProductBtn" class="btn btn-primary"><span>Yeni Məhsul</span></button></div><div class="content-area"><table class="data-table"><thead><tr><th>#ID</th><th>Ad</th><th>Alış Qiyməti</th><th>Satış Qiyməti</th><th>Anbar Sayı</th><th></th></tr></thead><tbody id="productTableBody"></tbody></table></div></div></template>
    <template id="customers-page-template"><div class="page-container"><div class="page-header"><h1>Müştərilər</h1><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="customerSearch" class="search-input" placeholder="Ad və ya telefonla axtar..."></div><button id="addCustomerBtn" class="btn btn-primary"><span>Yeni Müştəri</span></button></div><div class="content-area"><table class="data-table"><thead><tr><th>#ID</th><th>Tam Adı</th><th>Telefon</th><th>Borc</th><th></th></tr></thead><tbody id="customerTableBody"></tbody></table></div></div></template>
    <template id="suppliers-page-template"><div class="page-container"><div class="page-header"><h1>Təchizatçılar</h1><div class="search-container"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><input type="search" id="supplierSearch" class="search-input" placeholder="Ad və ya telefonla axtar..."></div><button id="addSupplierBtn" class="btn btn-primary"><span>Yeni Təchizatçı</span></button></div><div class="content-area"><table class="data-table"><thead><tr><th>#ID</th><th>Ad</th><th>Telefon</th><th>Bizim Borcumuz</th><th></th></tr></thead><tbody id="supplierTableBody"></tbody></table></div></div></template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        const sidebarNav = document.getElementById('sidebar-nav');
        const allModals = document.querySelectorAll('.modal');

        const getFromStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';
        allModals.forEach(modal => {
            const closeButton = modal.querySelector('.modal-close');
            if(closeButton) closeButton.addEventListener('click', () => closeModal(modal));
            window.addEventListener('click', (event) => { if (event.target === modal) closeModal(modal); });
        });
        
        const pageSetups = {
            'finance': setupFinancePage, 'reports': setupReportsPage, 'sales': setupSalesPage,
            'purchases': setupPurchasesPage, 'products': setupProductsPage, 'customers': setupCustomersPage, 'suppliers': setupSuppliersPage
        };

        const renderPage = (pageName) => {
            const template = document.getElementById(`${pageName}-page-template`);
            if (!template) { console.error(`Template for page "${pageName}" not found.`); return; }
            appContainer.innerHTML = '';
            const pageContent = template.content.cloneNode(true);
            appContainer.appendChild(pageContent);
            if (pageSetups[pageName]) pageSetups[pageName]();
        };

        sidebarNav.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                const pageName = link.dataset.page;
                if(pageName) {
                    sidebarNav.querySelectorAll('a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    renderPage(pageName);
                }
            }
        });

        // --- DATA FUNCTIONS ---
        const getProducts = () => getFromStorage('products'); const saveProducts = (p) => saveToStorage('products', p);
        const getCustomers = () => getFromStorage('customers'); const saveCustomers = (c) => saveToStorage('customers', c);
        const getSuppliers = () => getFromStorage('suppliers'); const saveSuppliers = (s) => saveToStorage('suppliers', s);
        const getSales = () => getFromStorage('sales'); const saveSales = (s) => saveToStorage('sales', s);
        const getPurchases = () => getFromStorage('purchases'); const savePurchases = (p) => saveToStorage('purchases', p);
        const getTransactions = () => getFromStorage('transactions'); const saveTransactions = (t) => saveToStorage('transactions', t);
        
        function addTransaction(type, description, amount) {
            const transactions = getTransactions();
            transactions.push({ id: Date.now(), date: new Date().toLocaleString('az-AZ'), type, description, amount });
            saveTransactions(transactions);
        }

        // --- PAGE SETUPS ---
        function setupProductsPage() {
            const productTableBody = appContainer.querySelector('#productTableBody');
            const addProductBtn = appContainer.querySelector('#addProductBtn');
            const productSearch = appContainer.querySelector('#productSearch');
            const addProductModal = document.getElementById('addProductModal');
            const editProductModal = document.getElementById('editProductModal');
            const addProductForm = document.getElementById('addProductForm');
            const editProductForm = document.getElementById('editProductForm');

            const renderProducts = () => {
                const query = productSearch.value.toLowerCase();
                let products = getProducts();
                if (query) {
                    products = products.filter(p => p.name.toLowerCase().includes(query) || p.id.toString().includes(query));
                }
                productTableBody.innerHTML = '';
                if (products.length === 0) {
                    productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Məhsul tapılmadı.</td></tr>';
                    return;
                }
                products.forEach(p => {
                    productTableBody.innerHTML += `<tr><td>${p.id}</td><td>${p.name}</td><td>${p.purchasePrice.toFixed(2)} ₼</td><td>${p.salePrice.toFixed(2)} ₼</td><td>${p.stock} ədəd</td><td class="actions-cell"><button class="btn-edit" data-id="${p.id}"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button><button class="btn-delete" data-id="${p.id}"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td></tr>`;
                });
            };

            addProductBtn.addEventListener('click', () => { addProductForm.reset(); openModal(addProductModal); });
            addProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const products = getProducts();
                const newProduct = {
                    id: Date.now(),
                    name: document.getElementById('productNameModal').value,
                    purchasePrice: parseFloat(document.getElementById('purchasePriceModal').value),
                    salePrice: parseFloat(document.getElementById('salePriceModal').value),
                    stock: parseInt(document.getElementById('stockQuantityModal').value)
                };
                products.push(newProduct);
                saveProducts(products);
                renderProducts();
                closeModal(addProductModal);
            });

            productTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = parseInt(btn.dataset.id);

                if (btn.classList.contains('btn-delete')) {
                    if (confirm('Məhsulu silməyə əminsiniz?')) {
                        saveProducts(getProducts().filter(p => p.id !== id));
                        renderProducts();
                    }
                }
                if (btn.classList.contains('btn-edit')) {
                    const product = getProducts().find(p => p.id === id);
                    if (product) {
                        document.getElementById('editProductId').value = product.id;
                        document.getElementById('editProductName').value = product.name;
                        document.getElementById('editPurchasePrice').value = product.purchasePrice;
                        document.getElementById('editSalePrice').value = product.salePrice;
                        document.getElementById('editStockQuantity').value = product.stock;
                        openModal(editProductModal);
                    }
                }
            });

            editProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editProductId').value);
                const updatedProducts = getProducts().map(p => p.id === id ? {
                    id,
                    name: document.getElementById('editProductName').value,
                    purchasePrice: parseFloat(document.getElementById('editPurchasePrice').value),
                    salePrice: parseFloat(document.getElementById('editSalePrice').value),
                    stock: parseInt(document.getElementById('editStockQuantity').value)
                } : p);
                saveProducts(updatedProducts);
                renderProducts();
                closeModal(editProductModal);
            });

            productSearch.addEventListener('input', renderProducts);
            renderProducts();
        }

        function setupCustomersPage() {
            const customerTableBody = appContainer.querySelector('#customerTableBody');
            const addCustomerBtn = appContainer.querySelector('#addCustomerBtn');
            const customerSearch = appContainer.querySelector('#customerSearch');
            const addCustomerModal = document.getElementById('addCustomerModal');
            const editCustomerModal = document.getElementById('editCustomerModal');
            const addCustomerForm = document.getElementById('addCustomerForm');
            const editCustomerForm = document.getElementById('editCustomerForm');

            const renderCustomers = () => {
                const query = customerSearch.value.toLowerCase();
                let customers = getCustomers();
                if(query){
                    customers = customers.filter(c => c.name.toLowerCase().includes(query) || c.phone.includes(query));
                }
                customerTableBody.innerHTML = '';
                if (customers.length === 0) {
                    customerTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Müştəri tapılmadı.</td></tr>';
                    return;
                }
                customers.forEach(c => {
                    customerTableBody.innerHTML += `<tr><td>${c.id}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.debt.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-edit" data-id="${c.id}">✏️</button><button class="btn-delete" data-id="${c.id}">🗑️</button></td></tr>`;
                });
            };
            
            addCustomerBtn.addEventListener('click', () => { addCustomerForm.reset(); openModal(addCustomerModal); });
            addCustomerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const customers = getCustomers();
                customers.push({
                    id: Date.now(),
                    name: document.getElementById('customerNameModal').value,
                    phone: document.getElementById('customerPhoneModal').value,
                    debt: 0
                });
                saveCustomers(customers);
                renderCustomers();
                closeModal(addCustomerModal);
            });

            customerTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = parseInt(btn.dataset.id);

                if (btn.classList.contains('btn-delete')) {
                    const customer = getCustomers().find(c => c.id === id);
                    if (customer.debt > 0) {
                        alert('Bu müştərinin borcu olduğu üçün silinə bilməz!');
                        return;
                    }
                    if (confirm('Müştərini silməyə əminsiniz?')) {
                        saveCustomers(getCustomers().filter(c => c.id !== id));
                        renderCustomers();
                    }
                }
                if (btn.classList.contains('btn-edit')) {
                    const customer = getCustomers().find(c => c.id === id);
                    if (customer) {
                        document.getElementById('editCustomerId').value = customer.id;
                        document.getElementById('editCustomerName').value = customer.name;
                        document.getElementById('editCustomerPhone').value = customer.phone;
                        openModal(editCustomerModal);
                    }
                }
            });

            editCustomerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editCustomerId').value);
                const updatedCustomers = getCustomers().map(c => c.id === id ? {
                    ...c,
                    name: document.getElementById('editCustomerName').value,
                    phone: document.getElementById('editCustomerPhone').value
                } : c);
                saveCustomers(updatedCustomers);
                renderCustomers();
                closeModal(editCustomerModal);
            });

            customerSearch.addEventListener('input', renderCustomers);
            renderCustomers();
        }

        function setupSuppliersPage() {
            const supplierTableBody = appContainer.querySelector('#supplierTableBody');
            const addSupplierBtn = appContainer.querySelector('#addSupplierBtn');
            const supplierSearch = appContainer.querySelector('#supplierSearch');
            const addSupplierModal = document.getElementById('addSupplierModal');
            const editSupplierModal = document.getElementById('editSupplierModal');
            const addSupplierForm = document.getElementById('addSupplierForm');
            const editSupplierForm = document.getElementById('editSupplierForm');

            const renderSuppliers = () => {
                const query = supplierSearch.value.toLowerCase();
                let suppliers = getSuppliers();
                if(query) {
                    suppliers = suppliers.filter(s => s.name.toLowerCase().includes(query) || (s.phone && s.phone.includes(query)));
                }
                supplierTableBody.innerHTML = '';
                if (suppliers.length === 0) {
                    supplierTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Təchizatçı tapılmadı.</td></tr>';
                    return;
                }
                suppliers.forEach(s => {
                    supplierTableBody.innerHTML += `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.phone || '-'}</td><td>${(s.balance || 0).toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-edit" data-id="${s.id}">✏️</button><button class="btn-delete" data-id="${s.id}">🗑️</button></td></tr>`;
                });
            };

            addSupplierBtn.addEventListener('click', () => { addSupplierForm.reset(); openModal(addSupplierModal); });
            addSupplierForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const suppliers = getSuppliers();
                suppliers.push({
                    id: Date.now(),
                    name: document.getElementById('supplierNameModal').value,
                    phone: document.getElementById('supplierPhoneModal').value,
                    balance: 0
                });
                saveSuppliers(suppliers);
                renderSuppliers();
                closeModal(addSupplierModal);
            });

            supplierTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = parseInt(btn.dataset.id);

                if (btn.classList.contains('btn-delete')) {
                    const supplier = getSuppliers().find(s => s.id === id);
                    if ((supplier.balance || 0) > 0) {
                        alert('Bu təchizatçıya borc olduğu üçün silinə bilməz!');
                        return;
                    }
                    if (confirm('Təchizatçını silməyə əminsiniz?')) {
                        saveSuppliers(getSuppliers().filter(s => s.id !== id));
                        renderSuppliers();
                    }
                }
                if (btn.classList.contains('btn-edit')) {
                    const supplier = getSuppliers().find(s => s.id === id);
                    if (supplier) {
                        document.getElementById('editSupplierId').value = supplier.id;
                        document.getElementById('editSupplierName').value = supplier.name;
                        document.getElementById('editSupplierPhone').value = supplier.phone;
                        openModal(editSupplierModal);
                    }
                }
            });

            editSupplierForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('editSupplierId').value);
                const updatedSuppliers = getSuppliers().map(s => s.id === id ? {
                    ...s,
                    name: document.getElementById('editSupplierName').value,
                    phone: document.getElementById('editSupplierPhone').value
                } : s);
                saveSuppliers(updatedSuppliers);
                renderSuppliers();
                closeModal(editSupplierModal);
            });

            supplierSearch.addEventListener('input', renderSuppliers);
            renderSuppliers();
        }
        
        function setupSalesPage() {
            const saleForm = appContainer.querySelector('#saleForm');
            const saleCustomerSelect = appContainer.querySelector('#saleCustomer');
            const saleProductSelect = appContainer.querySelector('#saleProduct');
            const cartTableBody = appContainer.querySelector('#cartTableBody');
            const summaryTotal = appContainer.querySelector('#summaryTotal');
            const initialPaymentGroup = appContainer.querySelector('#initialPaymentGroup');
            const initialPaymentInput = appContainer.querySelector('#initialPayment');
            const debtRow = appContainer.querySelector('#debt-row');
            const debtTotal = appContainer.querySelector('#debt-total');
            let currentCart = [];
            const saleTypeButtonsContainer = appContainer.querySelector('.sale-type-buttons');
            let selectedSaleType = 'Nağd';

            const initializeSalePage = () => {
                const customers = getCustomers();
                saleCustomerSelect.innerHTML = '<option value="">-- Müştəri Seçin --</option><option value="0">Nağd Alıcı</option>';
                customers.forEach(c => { saleCustomerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
                const products = getProducts();
                saleProductSelect.innerHTML = '<option value="">-- Məhsul Əlavə Et --</option>';
                products.forEach(p => { if (p.stock > 0) { saleProductSelect.innerHTML += `<option value="${p.id}">${p.name} (Stok: ${p.stock})</option>`; }});
                currentCart = [];
                renderCart();
                saleForm.reset();
                initialPaymentGroup.style.display = 'none';
                debtRow.style.display = 'none';
                saleTypeButtonsContainer.querySelectorAll('.sale-type-btn').forEach(b => b.classList.remove('active'));
                saleTypeButtonsContainer.querySelector('.sale-type-btn[data-type="Nağd"]').classList.add('active');
                selectedSaleType = 'Nağd';
            };

            const calculateTotals = () => {
                const totalAmount = currentCart.reduce((s, i) => s + (i.quantity * i.salePrice), 0);
                summaryTotal.textContent = `${totalAmount.toFixed(2)} ₼`;
                return totalAmount;
            };

            const renderCart = () => {
                cartTableBody.innerHTML = '';
                if (currentCart.length === 0) {
                    cartTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Səbət boşdur</td></tr>';
                } else {
                    currentCart.forEach(i => {
                        const itemTotal = i.quantity * i.salePrice;
                        cartTableBody.innerHTML += `<tr><td>${i.name}</td><td><input type="number" class="cart-quantity-input" data-id="${i.id}" value="${i.quantity}" min="1" max="${i.stock}"></td><td>${i.salePrice.toFixed(2)} ₼</td><td>${itemTotal.toFixed(2)} ₼</td><td class="actions-cell"><button type="button" class="btn-delete cart-remove-btn" data-id="${i.id}">🗑️</button></td></tr>`;
                    });
                }
                calculateTotals();
            };

            saleProductSelect.addEventListener('change', () => {
                const productId = parseInt(saleProductSelect.value);
                if (!productId) return;
                const product = getProducts().find(p => p.id === productId);
                if (!product) return;
                const existingItem = currentCart.find(i => i.id === productId);
                if (existingItem) {
                    if (existingItem.quantity < product.stock) {
                        existingItem.quantity++;
                    } else {
                        alert('Anbarda kifayət qədər məhsul yoxdur!');
                    }
                } else {
                    currentCart.push({ ...product, quantity: 1 });
                }
                renderCart();
                saleProductSelect.value = '';
            });

            cartTableBody.addEventListener('input', (e) => {
                if (e.target.classList.contains('cart-quantity-input')) {
                    const productId = parseInt(e.target.dataset.id);
                    let newQuantity = parseInt(e.target.value);
                    const item = currentCart.find(i => i.id === productId);
                    if (!item) return;

                    if (newQuantity > item.stock) {
                        alert(`Anbarda yalnız ${item.stock} ədəd var!`);
                        newQuantity = item.stock;
                        e.target.value = newQuantity;
                    }

                    if (newQuantity < 1) {
                        newQuantity = 1;
                        e.target.value = newQuantity;
                    }
                    
                    item.quantity = newQuantity;
                    renderCart();
                }
            });

            cartTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if(btn && btn.classList.contains('cart-remove-btn')) {
                    currentCart = currentCart.filter(i => i.id !== parseInt(btn.dataset.id));
                    renderCart();
                }
            });

            saleTypeButtonsContainer.addEventListener('click', (e) => {
                const clickedButton = e.target.closest('.sale-type-btn');
                if (!clickedButton) return;
                saleTypeButtonsContainer.querySelectorAll('.sale-type-btn').forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                selectedSaleType = clickedButton.dataset.type;

                const totalAmount = calculateTotals();
                if (selectedSaleType === 'Kredit' || selectedSaleType === 'Korporativ') {
                    initialPaymentGroup.style.display = 'block';
                    debtRow.style.display = 'flex';
                    initialPaymentInput.value = 0;
                    debtTotal.textContent = `${totalAmount.toFixed(2)} ₼`;
                } else {
                    initialPaymentGroup.style.display = 'none';
                    debtRow.style.display = 'none';
                    initialPaymentInput.value = totalAmount;
                }
            });

            initialPaymentInput.addEventListener('input', () => {
                const totalAmount = calculateTotals();
                const initialPayment = parseFloat(initialPaymentInput.value) || 0;
                const debt = totalAmount - initialPayment;
                debtTotal.textContent = `${debt.toFixed(2)} ₼`;
            });
            
            saleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (currentCart.length === 0 || !saleCustomerSelect.value) {
                    alert('Müştəri seçin və səbətə məhsul əlavə edin!');
                    return;
                }
                const totalAmount = calculateTotals();
                const isCreditType = selectedSaleType === 'Kredit' || selectedSaleType === 'Korporativ';
                const customerId = parseInt(saleCustomerSelect.value);
                const initialPayment = isCreditType ? parseFloat(initialPaymentInput.value || 0) : totalAmount;
                const debt = totalAmount - initialPayment;

                if (isCreditType && customerId === 0) {
                    alert(`${selectedSaleType} satışı üçün "Nağd Alıcı" seçilə bilməz!`);
                    return;
                }

                if (isCreditType && initialPayment > totalAmount) {
                    alert('İlkin ödəniş ümumi məbləğdən çox ola bilməz!');
                    return;
                }
                
                let products = getProducts();
                currentCart.forEach(item => {
                    let product = products.find(p => p.id === item.id);
                    if (product) product.stock -= item.quantity;
                });
                saveProducts(products);

                if (isCreditType && debt > 0) {
                    let customers = getCustomers();
                    let customer = customers.find(c => c.id === customerId);
                    if (customer) customer.debt += debt;
                    saveCustomers(customers);
                }
                
                let sales = getSales();
                let customerName = "Nağd Alıcı";
                if (customerId !== 0) {
                    const customer = getCustomers().find(c => c.id === customerId);
                    if (customer) customerName = customer.name;
                    else customerName = "Silinmiş Müştəri";
                }

                const newSale = {
                    id: Date.now(),
                    customerId,
                    customerName,
                    items: currentCart,
                    totalAmount,
                    type: selectedSaleType,
                    initialPayment,
                    date: new Date().toLocaleString('az-AZ')
                };
                sales.push(newSale);
                saveSales(sales);
                
                addTransaction(`${selectedSaleType} Satış`, `Satış #${newSale.id} - ${customerName}`, initialPayment);
                
                alert('Satış uğurla tamamlandı!');
                initializeSalePage();
            });

            initializeSalePage();
        }

        function setupPurchasesPage() {
            const purchaseForm = appContainer.querySelector('#purchaseForm');
            const purchaseSupplierSelect = appContainer.querySelector('#purchaseSupplierSelect');
            const purchaseProductSelect = appContainer.querySelector('#purchaseProductSelect');
            const purchaseCartTableBody = appContainer.querySelector('#purchaseCartTableBody');
            const purchaseTotalEl = appContainer.querySelector('#purchaseTotal');
            let currentPurchaseCart = [];

            const initializePurchasePage = () => {
                const suppliers = getSuppliers();
                purchaseSupplierSelect.innerHTML = '<option value="">-- Təchizatçı Seçin --</option>';
                suppliers.forEach(s => { purchaseSupplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
                const products = getProducts();
                purchaseProductSelect.innerHTML = '<option value="">-- Məhsul Seçin --</option>';
                products.forEach(p => { purchaseProductSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`; });
                currentPurchaseCart = [];
                renderPurchaseCart();
                purchaseForm.reset();
            };

            const calculatePurchaseTotal = () => {
                const total = currentPurchaseCart.reduce((sum, item) => sum + (item.quantity * item.purchasePrice), 0);
                purchaseTotalEl.textContent = `${total.toFixed(2)} ₼`;
                return total;
            };

            const renderPurchaseCart = () => {
                purchaseCartTableBody.innerHTML = '';
                if (currentPurchaseCart.length === 0) {
                    purchaseCartTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Siyahı boşdur</td></tr>';
                } else {
                    currentPurchaseCart.forEach(item => {
                        const itemTotal = item.quantity * item.purchasePrice;
                        purchaseCartTableBody.innerHTML += `<tr><td>${item.name}</td><td><input type="number" value="${item.quantity}" class="purchase-quantity-input" data-id="${item.id}" min="1"></td><td><input type="number" value="${item.purchasePrice.toFixed(2)}" class="purchase-price-input" data-id="${item.id}" step="0.01" min="0"></td><td>${itemTotal.toFixed(2)} ₼</td><td class="actions-cell"><button type="button" class="btn-delete purchase-remove-btn" data-id="${item.id}">🗑️</button></td></tr>`;
                    });
                }
                calculatePurchaseTotal();
            };

            purchaseProductSelect.addEventListener('change', () => {
                const productId = parseInt(purchaseProductSelect.value);
                if(!productId) return;
                const product = getProducts().find(p => p.id === productId);
                if(!product) return;
                const existingItem = currentPurchaseCart.find(i => i.id === productId);
                if(existingItem) {
                    existingItem.quantity++;
                } else {
                    currentPurchaseCart.push({ id: product.id, name: product.name, quantity: 1, purchasePrice: product.purchasePrice });
                }
                renderPurchaseCart();
                purchaseProductSelect.value = '';
            });

            purchaseCartTableBody.addEventListener('input', (e) => {
                const id = parseInt(e.target.dataset.id);
                const item = currentPurchaseCart.find(i => i.id === id);
                if(!item) return;
                if(e.target.classList.contains('purchase-quantity-input')) {
                    item.quantity = parseInt(e.target.value) || 1;
                }
                if(e.target.classList.contains('purchase-price-input')) {
                    item.purchasePrice = parseFloat(e.target.value) || 0;
                }
                renderPurchaseCart();
            });

            purchaseCartTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if(btn && btn.classList.contains('purchase-remove-btn')) {
                    currentPurchaseCart = currentPurchaseCart.filter(i => i.id !== parseInt(btn.dataset.id));
                    renderPurchaseCart();
                }
            });

            purchaseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const supplierId = parseInt(purchaseSupplierSelect.value);
                if(!supplierId || currentPurchaseCart.length === 0) {
                    alert("Təchizatçı seçin və siyahıya məhsul əlavə edin!");
                    return;
                }

                const totalAmount = calculatePurchaseTotal();
                let products = getProducts();
                let suppliers = getSuppliers();
                const supplier = suppliers.find(s => s.id === supplierId);
                if(!supplier) return;

                currentPurchaseCart.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock += item.quantity;
                        product.purchasePrice = item.purchasePrice;
                    }
                });

                supplier.balance = (supplier.balance || 0) + totalAmount;
                
                const newPurchase = {
                    id: Date.now(),
                    supplierId,
                    supplierName: supplier.name,
                    items: currentPurchaseCart,
                    totalAmount,
                    date: new Date().toLocaleString('az-AZ')
                };

                const purchases = getPurchases();
                purchases.push(newPurchase);
                
                savePurchases(purchases);
                saveProducts(products);
                saveSuppliers(suppliers);
                
                addTransaction('Mal Alışı', `Alış #${newPurchase.id} - ${supplier.name}`, 0); 
                
                alert('Alış uğurla tamamlandı!');
                initializePurchasePage();
            });

            initializePurchasePage();
        }

        function setupReportsPage() {
            const salesHistoryTableBody = appContainer.querySelector('#salesHistoryTableBody');
            const salesReportSearch = appContainer.querySelector('#salesReportSearch');
            const viewAllSalesBtn = appContainer.querySelector('#viewAllSalesBtn');
            const viewByCustomerBtn = appContainer.querySelector('#viewByCustomerBtn');
            const allSalesView = appContainer.querySelector('#all-sales-view');
            const byCustomerView = appContainer.querySelector('#by-customer-view');
            const customerReportSearch = appContainer.querySelector('#customerReportSearch');
            const customerSalesSummaryTableBody = appContainer.querySelector('#customerSalesSummaryTableBody');
            const customerSalesHistoryModal = document.getElementById('customerSalesHistoryModal');
            const saleDetailsModal = document.getElementById('saleDetailsModal');
            
            viewAllSalesBtn.addEventListener('click', () => {
                viewAllSalesBtn.classList.add('active');
                viewByCustomerBtn.classList.remove('active');
                allSalesView.style.display = 'block';
                byCustomerView.style.display = 'none';
                renderAllSalesReport();
            });

            viewByCustomerBtn.addEventListener('click', () => {
                viewByCustomerBtn.classList.add('active');
                viewAllSalesBtn.classList.remove('active');
                byCustomerView.style.display = 'block';
                allSalesView.style.display = 'none';
                renderCustomerSummaryReport();
            });

            const renderAllSalesReport = () => {
                const query = salesReportSearch.value.toLowerCase();
                let sales = getSales().reverse();
                if (query) {
                    sales = sales.filter(s => s.customerName.toLowerCase().includes(query) || s.totalAmount.toString().includes(query));
                }
                salesHistoryTableBody.innerHTML = '';
                if (sales.length === 0) {
                    salesHistoryTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Satış tapılmadı.</td></tr>';
                } else {
                    sales.forEach(sale => {
                        salesHistoryTableBody.innerHTML += `<tr><td>${sale.id}</td><td>${sale.date}</td><td>${sale.customerName}</td><td><span style="background:${sale.type === 'Kredit' || sale.type === 'Korporativ' ? 'var(--warning-color)' : 'var(--success-color)'}; color:white; padding: 4px 10px; border-radius:6px; font-size:12px;">${sale.type}</span></td><td>${sale.totalAmount.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-details" data-id="${sale.id}">Detallar</button></td></tr>`;
                    });
                }
            };

            const renderCustomerSummaryReport = () => {
                const query = customerReportSearch.value.toLowerCase();
                const sales = getSales();
                const customers = getCustomers();
                const salesByCustomer = {};
                
                customers.forEach(customer => {
                    salesByCustomer[customer.id] = {
                        customerId: customer.id,
                        customerName: customer.name,
                        salesCount: 0,
                        totalRevenue: 0,
                    };
                });
                
                sales.forEach(sale => {
                    const id = sale.customerId;
                    if (salesByCustomer[id]) {
                        salesByCustomer[id].salesCount++;
                        salesByCustomer[id].totalRevenue += sale.totalAmount;
                    }
                });

                let customerSummaries = Object.values(salesByCustomer);
                if(query) {
                    customerSummaries = customerSummaries.filter(c => c.customerName.toLowerCase().includes(query));
                }
                
                customerSalesSummaryTableBody.innerHTML = '';
                if (customerSummaries.length === 0) {
                    customerSalesSummaryTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Məlumat tapılmadı.</td></tr>';
                    return;
                }
                
                customerSummaries.forEach(summary => {
                    customerSalesSummaryTableBody.innerHTML += `<tr><td>${summary.customerName}</td><td>${summary.salesCount}</td><td>${summary.totalRevenue.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-details" data-customer-id="${summary.customerId}">Satışlara Bax</button></td></tr>`;
                });
            };
            
            customerSalesSummaryTableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if(btn && btn.dataset.customerId) {
                    const customerId = parseInt(btn.dataset.customerId);
                    const sales = getSales().filter(s => s.customerId === customerId).reverse();
                    const customerName = sales.length > 0 ? sales[0].customerName : 'Naməlum';
                    document.getElementById('customer-history-title').textContent = `${customerName} - Satış Tarixçəsi`;
                    const body = document.getElementById('customer-sales-history-table-body');
                    body.innerHTML = '';
                    sales.forEach(sale => {
                        body.innerHTML += `<tr><td>${sale.id}</td><td>${sale.date}</td><td>${sale.type}</td><td>${sale.totalAmount.toFixed(2)} ₼</td><td class="actions-cell"><button class="btn-details" data-id="${sale.id}">Məhsullar</button></td></tr>`;
                    });
                    openModal(customerSalesHistoryModal);
                }
            });

            appContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.classList.contains('btn-details') && btn.dataset.id) {
                    const saleId = parseInt(btn.dataset.id);
                    const sale = getSales().find(s => s.id === saleId);
                    if (!sale) return;
                    let detailsHtml = `
                        <p><strong>Satış ID:</strong> ${sale.id}</p>
                        <p><strong>Müştəri:</strong> ${sale.customerName}</p>
                        <p><strong>Satış Növü:</strong> ${sale.type}</p>
                        <p><strong>Yekun Məbləğ:</strong> ${sale.totalAmount.toFixed(2)} ₼</p>
                        <p><strong>Ödənilmiş Məbləğ:</strong> ${sale.initialPayment.toFixed(2)} ₼</p>
                        <p><strong>Borc:</strong> ${(sale.totalAmount - sale.initialPayment).toFixed(2)} ₼</p>
                        <hr style="border-color:var(--border-color); margin: 15px 0;">
                        <h4 style="margin-bottom:10px;">Satılan Məhsullar</h4>
                        <table class="data-table" style="width:100%;">
                            <thead>
                                <tr><th>Məhsul</th><th>Say</th><th>Qiymət</th><th>Toplam</th></tr>
                            </thead>
                            <tbody>
                    `;
                    sale.items.forEach(i => {
                        detailsHtml += `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${i.salePrice.toFixed(2)} ₼</td><td>${(i.quantity * i.salePrice).toFixed(2)} ₼</td></tr>`;
                    });
                    detailsHtml += '</tbody></table>';
                    document.getElementById('saleDetailsContent').innerHTML = detailsHtml;
                    openModal(saleDetailsModal);
                }
            });

            salesReportSearch.addEventListener('input', renderAllSalesReport);
            customerReportSearch.addEventListener('input', renderCustomerSummaryReport);
            
            if (viewAllSalesBtn.classList.contains('active')) {
                renderAllSalesReport();
            } else {
                renderCustomerSummaryReport();
            }
        }

        function setupFinancePage() {
            const currentCashBalanceEl = appContainer.querySelector('#current-cash-balance');
            const totalReceivablesEl = appContainer.querySelector('#total-receivables');
            const totalPayablesEl = appContainer.querySelector('#total-payables');
            const transactionsTableBody = appContainer.querySelector('#transactionsTableBody');
            const btnAcceptPayment = appContainer.querySelector('#btnAcceptPayment');
            const btnAddExpense = appContainer.querySelector('#btnAddExpense');
            const btnPaySupplier = appContainer.querySelector('#btnPaySupplier');
            const btnBackupData = appContainer.querySelector('#btnBackupData');
            const acceptPaymentModal = document.getElementById('acceptPaymentModal');
            const addExpenseModal = document.getElementById('addExpenseModal');
            const paySupplierModal = document.getElementById('paySupplierModal');
            const acceptPaymentForm = document.getElementById('acceptPaymentForm');
            const addExpenseForm = document.getElementById('addExpenseForm');
            const paySupplierForm = document.getElementById('paySupplierForm');
            
            const renderFinancePage = () => {
                const transactions = getTransactions();
                const customers = getCustomers();
                const suppliers = getSuppliers();

                const cashBalance = transactions.reduce((sum, tr) => sum + tr.amount, 0);
                currentCashBalanceEl.textContent = `${cashBalance.toFixed(2)} ₼`;
                currentCashBalanceEl.classList.toggle('negative', cashBalance < 0);
                
                const totalReceivables = customers.reduce((sum, cust) => sum + cust.debt, 0);
                totalReceivablesEl.textContent = `${totalReceivables.toFixed(2)} ₼`;
                
                const totalPayables = suppliers.reduce((sum, sup) => sum + (sup.balance || 0), 0);
                totalPayablesEl.textContent = `${totalPayables.toFixed(2)} ₼`;

                transactionsTableBody.innerHTML = '';
                transactions.slice().reverse().forEach(tr => {
                    transactionsTableBody.innerHTML += `<tr><td>${tr.date}</td><td>${tr.type}</td><td>${tr.description}</td><td class="${tr.amount >= 0 ? 'positive' : 'negative'}">${tr.amount.toFixed(2)} ₼</td></tr>`;
                });
            };

            btnBackupData.addEventListener('click', () => {
                const backupData = {
                    products: getProducts(), customers: getCustomers(), suppliers: getSuppliers(),
                    sales: getSales(), purchases: getPurchases(), transactions: getTransactions()
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `biznes-panel-backup-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            btnAcceptPayment.addEventListener('click', () => {
                const cDebt = getCustomers().filter(c => c.debt > 0);
                const select = document.getElementById('paymentCustomerSelect');
                select.innerHTML = '<option value="">-- Müştəri Seçin --</option>';
                cDebt.forEach(c => { select.innerHTML += `<option value="${c.id}">${c.name} (Borc: ${c.debt.toFixed(2)} ₼)</option>`; });
                acceptPaymentForm.reset();
                openModal(acceptPaymentModal);
            });

            btnAddExpense.addEventListener('click', () => { addExpenseForm.reset(); openModal(addExpenseModal); });

            btnPaySupplier.addEventListener('click', () => {
                const sBal = getSuppliers().filter(s => (s.balance || 0) > 0);
                const select = document.getElementById('paymentSupplierSelect');
                select.innerHTML = '<option value="">-- Təchizatçı Seçin --</option>';
                sBal.forEach(s => { select.innerHTML += `<option value="${s.id}">${s.name} (Borc: ${s.balance.toFixed(2)} ₼)</option>`; });
                paySupplierForm.reset();
                openModal(paySupplierModal);
            });

            acceptPaymentForm.addEventListener('submit', e => {
                e.preventDefault();
                const customerId = parseInt(document.getElementById('paymentCustomerSelect').value);
                if (!customerId) { alert("Müştəri seçin."); return; }
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                let customers = getCustomers();
                const customer = customers.find(c => c.id === customerId);
                if (!customer || amount > customer.debt || amount <= 0) {
                    alert('Ödəniş məbləği düzgün deyil!');
                    return;
                }
                customer.debt -= amount;
                saveCustomers(customers);
                addTransaction('Müştəri Ödənişi', `${customer.name} tərəfindən ödəniş`, amount);
                renderFinancePage();
                closeModal(acceptPaymentModal);
            });

            addExpenseForm.addEventListener('submit', e => {
                e.preventDefault();
                const desc = document.getElementById('expenseDescription').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                if(amount <= 0) { alert("Məbləğ müsbət olmalıdır."); return; }
                addTransaction('Xərc', desc, -amount);
                renderFinancePage();
                closeModal(addExpenseModal);
            });

            paySupplierForm.addEventListener('submit', e => {
                e.preventDefault();
                const supplierId = parseInt(document.getElementById('paymentSupplierSelect').value);
                if(!supplierId){ alert("Təchizatçı seçin."); return; }
                const amount = parseFloat(document.getElementById('supplierPaymentAmount').value);
                let suppliers = getSuppliers();
                const supplier = suppliers.find(s => s.id === supplierId);
                if (!supplier || amount > supplier.balance || amount <= 0) {
                    alert('Ödəniş məbləği düzgün deyil!');
                    return;
                }
                supplier.balance -= amount;
                saveSuppliers(suppliers);
                addTransaction('Təchizatçıya Ödəniş', `${supplier.name} üçün ödəniş`, -amount);
                renderFinancePage();
                closeModal(paySupplierModal);
            });

            renderFinancePage();
        }

        // --- INITIAL LOAD ---
        renderPage('finance');
    });
    </script>
</body>
</html>
